<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Benort</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
  <style>
    #editor-preview-wrapper {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    @media (min-width: 992px) {
      #editor-preview-wrapper {
        flex-direction: row;
      }
    }
    .editor-pane,
    .preview-pane {
      flex: 1 1 0;
      min-height: 70vh;
      display: flex;
      flex-direction: column;
    }
    #editor-container,
    #pdf-container,
    #markdown-preview {
      height: 70vh;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: #fff;
      overflow: auto;
    }
    #editor-container {
      background: #f8f9fa;
      padding: 0;
    }
    .CodeMirror {
      height: 100% !important;
    }
    .CodeMirror-scroll {
      max-height: 100% !important;
    }
    #pdf-container {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 1rem;
    }
    #markdown-preview {
      padding: 1rem;
    }
    .markdown-preview-content pre {
      background: #f5f5f5;
      border-radius: 4px;
      padding: 0.75rem;
      overflow: auto;
    }
    .copy-trigger-wrapper {
      position: relative;
      display: block;
    }
    .copy-trigger-wrapper.inline-copy {
      display: inline-block;
      vertical-align: baseline;
    }
    .copy-trigger-btn {
      position: absolute;
      top: 0.35rem;
      right: 0.35rem;
      opacity: 0;
      transition: opacity 0.2s ease;
      padding: 0.1rem 0.4rem;
      line-height: 1.2;
      font-size: 0.75rem;
    }
    .copy-trigger-wrapper:hover .copy-trigger-btn,
    .copy-trigger-btn:focus {
      opacity: 1;
    }
    #pdf-pages {
      width: 100%;
    }
    .pdf-page-canvas {
      max-width: 100%;
      height: auto;
      background: #fff;
    }
    .navbar .btn-outline-primary {
      border-width: 2px;
    }
    @media (max-width: 767.98px) {
      .editor-pane,
      .preview-pane {
        min-height: 60vh;
      }
    }
  </style>
</head>
<body>
<div id="status-area" class="position-fixed top-0 start-50 translate-middle-x p-3" style="z-index:2000;"></div>
 
<nav class="navbar navbar-expand-lg navbar-light bg-light mb-3">
  <div class="container-fluid">
    <div class="d-flex align-items-center gap-3">
      <div class="dropdown">
        <button class="btn btn-outline-primary fw-semibold px-3" id="project-dropdown" data-bs-toggle="dropdown" aria-expanded="false">Benort</button>
        <ul class="dropdown-menu" id="project-menu" aria-labelledby="project-dropdown">
          <li><span class="dropdown-item-text text-muted">加载项目...</span></li>
        </ul>
      </div>
    </div>
  <div class="navbar-collapse show ms-3">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">

        <li class="nav-item d-flex align-items-center">
          <button class="btn btn-outline-primary btn-sm me-2" id="prev-page" title="上一页">上</button>
          <button type="button" class="btn btn-outline-primary btn-sm me-2" id="page-status" >
            <span id="page-num">1</span> / <span id="page-count">1</span>
          </button>
          <button class="btn btn-outline-primary btn-sm me-2" id="next-page" title="下一页">下</button>
        </li>
        <li class="nav-item"><button class="btn btn-outline-primary me-2" id="mode-switch-btn" title="切换LaTeX/Markdown">模式</button></li>
        <li class="nav-item"><button class="btn btn-outline-secondary me-2" id="add-page" title="添加新页">加页</button></li>
        <li class="nav-item"><button class="btn btn-outline-warning me-2" id="insert-component" title="插入常用组件">插入</button></li>
        <li class="nav-item"><button class="btn btn-outline-info me-2" id="edit-template" title="编辑LaTeX样式模板">样式</button></li>
        <li><hr class="dropdown-divider m-1"></li>

  <li class="nav-item"><button class="btn btn-outline-success me-2" id="export-btn" title="导出">导出</button></li>
        <li><hr class="dropdown-divider m-1"></li>

        <li class="nav-item"><button class="btn btn-outline-danger me-2" id="ai-optimize" title="AI代码优化">代码优化</button></li>
  <li class="nav-item"><button class="btn btn-outline-secondary me-2" id="ai-note-optimize" title="AI笔记优化">笔记优化</button></li>
  <li class="nav-item"><button class="btn btn-outline-secondary me-2" id="ai-script-optimize" title="AI讲稿优化">讲稿优化</button></li>
        <li><hr class="dropdown-divider m-1"></li>
  <li class="nav-item"><button class="btn btn-outline-dark me-2" id="play-note" title="播放当前页讲稿">播放讲稿</button></li>
        <li><hr class="dropdown-divider m-1"></li>

        <li class="nav-item"><button class="btn btn-outline-primary me-2" id="edit-bib" title="管理文献">管理文献</button></li>
        <li class="nav-item"><button class="btn btn-outline-primary me-2" id="manage-resources" title="管理资源">管理资源</button></li>
        <li class="nav-item"><button class="btn btn-outline-primary me-2" id="manage-attachments" title="管理附件">管理附件</button></li>
        <li class="nav-item"><button class="btn btn-outline-primary me-2" id="manage-sync" title="OSS 同步设置">同步设置</button></li>

      <div class="modal fade" id="bibModal" tabindex="-1" aria-labelledby="bibModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="bibModalLabel">参考文献管理</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-2 d-flex">
                <input id="bib-input" class="form-control me-2" placeholder="输入DOI或文献链接">
                <select id="bib-scope" class="form-select me-2" style="width:auto;">
                  <option value="global">全局</option>
                  <option value="page">本页</option>
                </select>
                <button class="btn btn-success me-2" id="add-bib-btn">AI生成并添加</button>
                <button class="btn btn-outline-primary" id="add-url-bib-btn">直接添加URL</button>
              </div>
              <div id="bib-list" class="list-group"></div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
          </div>
        </div>
      </div>
      
          <!-- Resources Modal -->
          <div class="modal fade" id="resourcesModal" tabindex="-1" aria-labelledby="resourcesModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="resourcesModalLabel">资源管理</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="mb-3 d-flex align-items-center">
                    <select id="resources-scope" class="form-select me-2" style="width:auto;">
                      <option value="page">本页</option>
                      <option value="global">全局</option>
                    </select>
                    <button id="refresh-resources" class="btn btn-outline-secondary me-2">刷新</button>
                    <div class="ms-auto text-muted">当前页: <span id="resources-current-page">1</span></div>
                  </div>

                  <div class="input-group mb-3">
                    <input id="modal-resource-upload-input" type="file" class="form-control" />
                    <button id="modal-resource-upload-btn" class="btn btn-primary">上传到本页</button>
                    <button id="modal-resource-upload-global-btn" class="btn btn-secondary">上传为全局</button>
                  </div>

                  <h6 class="mt-2">资源</h6>
                  <div id="resources-list-modal" class="list-group mb-3"></div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
              </div>
            </div>
          </div>

      <!-- Attachments Modal -->
      <div class="modal fade" id="attachmentsModal" tabindex="-1" aria-labelledby="attachmentsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="attachmentsModalLabel">附件管理</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="d-flex align-items-center mb-3 gap-2">
                <label class="form-label small mb-0" for="attachment-insert-format">插入格式</label>
                <select id="attachment-insert-format" class="form-select form-select-sm" style="width:auto;">
                  <option value="auto">自动（根据当前编辑模式）</option>
                  <option value="latex">LaTeX</option>
                  <option value="markdown">Markdown</option>
                </select>
              </div>
              <div class="input-group mb-3">
                <input id="modal-attachment-upload-input" type="file" class="form-control" />
                <button id="modal-attachment-upload-btn" class="btn btn-primary">上传附件</button>
              </div>
              <div id="attachments-list-modal" class="list-group"></div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
          </div>
        </div>
      </div>

      
          <div class="modal fade" id="aiNoteModal" tabindex="-1" aria-labelledby="aiNoteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="aiNoteModalLabel">笔记AI优化结果</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <textarea id="ai-note-result" class="form-control" rows="8"></textarea>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
              <button type="button" class="btn btn-primary" id="apply-ai-note-result">应用到当前笔记</button>
            </div>
          </div>
        </div>
      </div>  

      <div class="modal fade" id="aiModal" tabindex="-1" aria-labelledby="aiModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="aiModalLabel">AI优化结果</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <textarea id="ai-result" class="form-control" rows="8"></textarea>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
              <button type="button" class="btn btn-primary" id="apply-ai-result">应用到当前页</button>
            </div>
          </div>
        </div>
      </div>
    
      <!-- Attachment Preview Modal -->
      <div class="modal fade" id="attachmentPreviewModal" tabindex="-1" aria-labelledby="attachmentPreviewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="attachmentPreviewModalLabel">附件预览</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
              <img id="attachment-preview-image" src="" alt="preview" class="img-fluid" style="max-height:70vh;" />
              <div class="text-muted small mt-2" id="attachment-preview-meta"></div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
              <a id="attachment-preview-open" href="#" target="_blank" class="btn btn-primary">新标签页打开</a>
            </div>
          </div>
        </div>
      </div>

      <!-- Attachment Rename Modal -->
      <div class="modal fade" id="attachmentRenameModal" tabindex="-1" aria-labelledby="attachmentRenameModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="attachmentRenameModalLabel">重命名附件</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="attachment-rename-input" class="form-label">新文件名</label>
                <input type="text" class="form-control" id="attachment-rename-input" />
                <div class="form-text">名称会自动清理非法字符，请保留正确的扩展名。</div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
              <button type="button" class="btn btn-primary" id="attachment-rename-confirm">保存</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Project Create Modal -->
      <div class="modal fade" id="projectCreateModal" tabindex="-1" aria-labelledby="projectCreateModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="projectCreateModalLabel">新建项目</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <label for="project-create-name" class="form-label">项目名称</label>
              <input type="text" class="form-control" id="project-create-name" placeholder="请输入项目名称" />
              <div class="form-text">名称仅支持字母、数字、下划线和中划线。</div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
              <button type="button" class="btn btn-primary" id="project-create-confirm">创建</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Project Rename Modal -->
      <div class="modal fade" id="projectRenameModal" tabindex="-1" aria-labelledby="projectRenameModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="projectRenameModalLabel">重命名项目</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <p class="mb-2" id="project-rename-current"></p>
              <label for="project-rename-name" class="form-label">新名称</label>
              <input type="text" class="form-control" id="project-rename-name" placeholder="请输入新名称" />
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
              <button type="button" class="btn btn-primary" id="project-rename-confirm">保存</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Project Delete Modal -->
      <div class="modal fade" id="projectDeleteModal" tabindex="-1" aria-labelledby="projectDeleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="projectDeleteModalLabel">删除项目</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <p class="text-danger" id="project-delete-warning">此操作无法撤销。</p>
              <label for="project-delete-confirm-name" class="form-label">请输入项目名称以确认删除</label>
              <input type="text" class="form-control" id="project-delete-confirm-name" />
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
              <button type="button" class="btn btn-danger" id="project-delete-confirm">删除</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Project Password Modal -->
      <div class="modal fade" id="projectPasswordModal" tabindex="-1" aria-labelledby="projectPasswordModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="projectPasswordModalLabel">项目密码</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="project-password-current" class="form-label">当前密码（若已有密码）</label>
                <input type="password" class="form-control" id="project-password-current" autocomplete="current-password" />
              </div>
              <div class="mb-3">
                <label for="project-password-new" class="form-label">新密码</label>
                <input type="password" class="form-control" id="project-password-new" autocomplete="new-password" />
              </div>
              <div class="mb-3">
                <label for="project-password-confirm" class="form-label">确认新密码</label>
                <input type="password" class="form-control" id="project-password-confirm" autocomplete="new-password" />
              </div>
              <div class="alert alert-warning d-none" id="project-password-warning"></div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-danger me-auto" id="project-password-remove">移除密码</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
              <button type="button" class="btn btn-primary" id="project-password-confirm">保存</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Project Unlock Modal -->
      <div class="modal fade" id="projectUnlockModal" tabindex="-1" aria-labelledby="projectUnlockModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="projectUnlockModalLabel">解锁项目</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <p id="project-unlock-target" class="mb-2"></p>
              <label for="project-unlock-password" class="form-label">输入项目密码</label>
              <input type="password" class="form-control" id="project-unlock-password" autocomplete="current-password" />
              <div class="alert alert-danger d-none mt-3" id="project-unlock-error"></div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
              <button type="button" class="btn btn-primary" id="project-unlock-confirm">解锁</button>
            </div>
          </div>
        </div>
      </div>

      <!-- OSS Sync Modal -->
      <div class="modal fade" id="ossSyncModal" tabindex="-1" aria-labelledby="ossSyncModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="ossSyncModalLabel">OSS 同步设置</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" id="oss-sync-toggle-main" />
                <label class="form-check-label" for="oss-sync-toggle-main">启用 OSS 同步</label>
              </div>
              <div class="alert alert-warning d-none" id="oss-sync-warning-main"></div>
              <dl class="row small mb-3" id="oss-sync-paths">
                <dt class="col-sm-4">附件目录</dt><dd class="col-sm-8 text-break" id="oss-sync-attachments"></dd>
                <dt class="col-sm-4">资源目录</dt><dd class="col-sm-8 text-break" id="oss-sync-resources"></dd>
                <dt class="col-sm-4">项目 YAML</dt><dd class="col-sm-8 text-break" id="oss-sync-yaml"></dd>
              </dl>
              <div class="border rounded p-2 bg-light text-break" id="oss-sync-status" style="min-height:3rem"></div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" id="oss-sync-run">立即同步</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
          </div>
        </div>
      </div>

      <!-- AI Script Modal (optimized speaking script) -->
      <div class="modal fade" id="aiScriptModal" tabindex="-1" aria-labelledby="aiScriptModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="aiScriptModalLabel">讲稿 AI 优化结果</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <textarea id="ai-script-result" class="form-control" rows="8"></textarea>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
              <button type="button" class="btn btn-primary" id="apply-ai-script-result">应用到当前讲稿</button>
            </div>
          </div>
        </div>
      </div>
      </ul>
    </div>
  </div>
</nav>
<div class="container-fluid">
  <div id="editor-preview-wrapper" class="mb-3">
    <div class="editor-pane">
      
      <form id="tex-form" class="flex-grow-1 d-flex flex-column">
        <div id="editor-container">
          <div id="pages-list"></div>
        </div>
      </form>

      <div class="modal fade" id="tabsModal" tabindex="-1" aria-labelledby="tabsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="tabsModalLabel">页面拖拽排序</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div id="page-tabs" class="d-flex flex-wrap"></div>
              <div class="text-muted mt-2">拖动页码标签可调整顺序，点击页码可跳转</div>
            </div>
          </div>
        </div>
      </div>

      <div class="modal fade" id="componentModal" tabindex="-1" aria-labelledby="componentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="componentModalLabel">插入常用页面组件</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="list-group" id="component-list">
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
          </div>
        </div>
      </div>

      <div class="modal fade" id="templateModal" tabindex="-1" aria-labelledby="templateModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="templateModalLabel">编辑样式模板</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label">选择基础模板</label>
                <select id="template-select" class="form-select mb-2">
                  <option value="">自定义（当前模板）</option>
                </select>
                <div class="form-text">选择后仍可在下方文本框中补充或修改内容。</div>
              </div>
              <label class="form-label">文档头部（第一页前）</label>
              <textarea id="template-header" class="form-control mb-2" rows="4"></textarea>
              <label class="form-label">文档主体（每页前）</label>
              <textarea id="template-before-pages" class="form-control mb-2" rows="2"></textarea>
              <label class="form-label">文档结尾（最后一页后）</label>
              <textarea id="template-footer" class="form-control" rows="2"></textarea>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
              <button type="button" class="btn btn-primary" id="save-template">保存模板</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="preview-pane">
      
      <div id="pdf-container">
        <div id="pdf-pages" class="w-100 d-flex flex-column align-items-center gap-3"></div>
      </div>
      <div id="markdown-preview" class="d-none">
        <div id="markdown-preview-content" class="markdown-preview-content mt-4"></div>
      </div>
    </div>
  </div>

  <div class="mb-4 mt-2">
    <textarea id="page-script" class="form-control" rows="4" placeholder="这里是本页的讲稿，支持导出语音。"></textarea>
  </div>
  
  <!-- Export Modal -->
  <div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exportModalLabel">导出选项</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="exportOption" id="exportTexOption" value="tex" checked>
            <label class="form-check-label" for="exportTexOption">导出 TeX</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="exportOption" id="exportAttachmentsOption" value="attachments">
            <label class="form-check-label" for="exportAttachmentsOption">导出 资料、附件和 yaml 为 zip</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="exportOption" id="exportAudioOption" value="audio">
            <label class="form-check-label" for="exportAudioOption">导出 讲稿为语音 (MP3)</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="exportOption" id="exportNotesOption" value="notes">
            <label class="form-check-label" for="exportNotesOption">导出 笔记 (Markdown)</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="exportOption" id="exportPagePdfOption" value="page_pdf">
            <label class="form-check-label" for="exportPagePdfOption">导出 当前页 PDF</label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
          <button type="button" class="btn btn-primary" id="doExportBtn">开始导出</button>
        </div>
      </div>
    </div>
  </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/stex/stex.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/markdown/markdown.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script>
  if (window.hljs) {
    hljs.configure({ignoreUnescapedHTML: true});
  }
</script>
<script>
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$', '$$'], ['\\[', '\\]']],
      processEscapes: true
    },
    svg: { fontCache: 'global' }
  };
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script>
  marked.setOptions({
    breaks: true,
    gfm: true,
    highlight: function(code, lang) {
      if (window.hljs) {
        try {
          if (lang && hljs.getLanguage(lang)) {
            return hljs.highlight(code, {language: lang}).value;
          }
          return hljs.highlightAuto(code).value;
        } catch (err) {
          console.warn('代码高亮失败', err);
        }
      }
      return code;
    }
  });

  
  function updatePageNumLabel() {
    document.getElementById('page-num').textContent = currentPageIdx+1;
    document.getElementById('page-count').textContent = pagesData.length;
  }
  
  
  const COMPONENTS = [

    { group: '结构', items: [
      { name: '章节（Section）', code: '\\section{章节标题}' },
      { name: '小节（Subsection）', code: '\\subsection{小节标题}' },
      { name: '幻灯片标题', code: '\\frametitle{幻灯片标题}' },
      { name: '摘要（Abstract）', code: '\\begin{abstract}\n这里是摘要内容。\n  \\end{abstract}' },
      { name: '目录（Table of Contents）', code: '\\tableofcontents' }
    ]},

    { group: '排版', items: [
      { name: '两栏排版', code: '\\begin{columns}\n  \\column{0.5\\textwidth}\n  左侧内容\n  \\column{0.5\\textwidth}\n  右侧内容\n\\end{columns}' },
      { name: '左右两列上下分块', code: '\\begin{columns}[T,onlytextwidth]\n  \\column{0.48\\textwidth}\n  % 左侧内容\n  这里是左侧一整块内容\n  \\column{0.48\\textwidth}\n  % 右侧上块\n  \\textbf{右上块标题}\n  右上块内容\\\\[1em]\n  % 右侧下块\n  \\textbf{右下块标题}\n  右下块内容\n\\end{columns}' },
      { name: '田字格（2x2分栏）', code: '\\begin{columns}\n  \\column{0.5\\textwidth}\n    \\begin{block}{左上}\n    内容1\n    \\end{block}\n    \\begin{block}{左下}\n    内容2\n    \\end{block}\n  \\column{0.5\\textwidth}\n    \\begin{block}{右上}\n    内容3\n    \\end{block}\n    \\begin{block}{右下}\n    内容4\n    \\end{block}\n\\end{columns}' },
      { name: '分段（Paragraph）', code: '\\paragraph{段落标题} 这里是段落内容。' },
      { name: '引用块（Quote）', code: '\\begin{quote}\n引用内容。\n\\end{quote}' }
    ]},

    { group: '组件', items: [
      { name: '项目符号列表', code: '\\begin{itemize}\n  \\item 第一项\n  \\item 第二项\n\\end{itemize}' },
      { name: '编号列表', code: '\\begin{enumerate}\n  \\item 第一项\n  \\item 第二项\n\\end{enumerate}' },
      { name: '表格', code: '\\begin{tabular}{|c|c|c|}\n  \\hline\nA & B & C \\\\ \\hline\n1 & 2 & 3 \\\\ \\hline\n\\end{tabular}' },
      { name: '浮动表格（table）', code: '\\begin{table}[htbp]\n  \\centering\n  \\begin{tabular}{ccc}\n    A & B & C \\\\ \n    1 & 2 & 3 \\\\ \n  \\end{tabular}\n  \\caption{表格标题}\n  \\label{tab:label}\n\\end{table}' },
      { name: '代码块（verbatim）', code: '\\begin{verbatim}\n这里是代码内容\n\\end{verbatim}' },
      { name: '交叉引用', code: '见图\\ref{fig:label}，表\\ref{tab:label}，公式\\eqref{eq:label}' }
    ]},

    { group: '数学/定理', items: [
      { name: '公式（有编号）', code: '\\begin{equation}\n  E=mc^2\n  \\end{equation}' },
      { name: '公式（无编号）', code: '\\[ E^2 = p^2c^2 + m^2c^4 \]' },
      { name: '定理（theorem）', code: '\\begin{theorem}\n  定理内容。\n  \\end{theorem}' },
      { name: '证明（proof）', code: '\\begin{proof}\n  证明过程。\n  \\end{proof}' }
    ]},

    { group: '卡片', items: [
      { name: '普通卡片（block）', code: '\\begin{block}{卡片标题}\n  这里是卡片内容，可用于强调信息。\n  \\end{block}' },
      { name: '警告卡片（alertblock）', code: '\\begin{alertblock}{警告/高亮}\n  这里是高亮警告内容。\n  \\end{alertblock}' },
      { name: '示例卡片（exampleblock）', code: '\\begin{exampleblock}{示例}\n  这里是示例内容。\n  \\end{exampleblock}' }
    ]},

    { group: '图片', items: [
      { name: '插入图片', code: '\\begin{center}\n  \\includegraphics[width=0.7\\textwidth]{example-image}\n  \\end{center}' },
      { name: '浮动图片（figure）', code: '\\begin{figure}[htbp]\n  \\centering\n  \\includegraphics[width=0.6\\textwidth]{example-image}\n  \\caption{图片标题}\n  \\label{fig:label}\n  \\end{figure}' }
    ]}
  ];
  
  
  document.getElementById('insert-component').onclick = function() {
    const list = document.getElementById('component-list');
    list.innerHTML = '';
    const container = document.createElement('div');
    container.className = 'd-flex';
    const nav = document.createElement('div');
    nav.className = 'list-group me-3';
    nav.style.minWidth = '120px';
    const compArea = document.createElement('div');
    compArea.style.flex = '1';
    let currentGroupIdx = 0;
    function renderCompList(idx) {
      compArea.innerHTML = '';
      COMPONENTS[idx].items.forEach(comp => {
        const btn = document.createElement('button');
        btn.className = 'list-group-item list-group-item-action mb-1';
        btn.textContent = comp.name;
        btn.onclick = function() {
          if(singleEditor) {
            const doc = singleEditor.getDoc();
            const cursor = doc.getCursor();
            doc.replaceRange(comp.code + '\n', cursor);
          }
          var modal = bootstrap.Modal.getInstance(document.getElementById('componentModal'));
          modal.hide();
        };
        compArea.appendChild(btn);
      });
    }
    COMPONENTS.forEach((group, idx) => {
      const navBtn = document.createElement('button');
      navBtn.className = 'list-group-item list-group-item-action' + (idx === 0 ? ' active' : '');
      navBtn.textContent = group.group;
      navBtn.onclick = function() {
        currentGroupIdx = idx;
        Array.from(nav.children).forEach(btn => btn.classList.remove('active'));
        navBtn.classList.add('active');
        renderCompList(idx);
      };
      nav.appendChild(navBtn);
    });
    renderCompList(0);
    container.appendChild(nav);
    container.appendChild(compArea);
    list.appendChild(container);
    var modal = new bootstrap.Modal(document.getElementById('componentModal'));
    modal.show();
  };
  let pagesData = [];
  let globalResources = [];
  let latexTemplate = {
    header: '\\documentclass{beamer}\n\\usepackage[utf8]{inputenc}\n\\usetheme{Madrid}',
    beforePages: '\\begin{document}',
    footer: '\\end{document}'
  };

  
  let currentPageIdx = 0;
  let singleEditor = null;
  let currentEditMode = 'latex';
  let currentProject = '';
  let compileTimer = null;
  let isCompiling = false;
  let compilePending = false;
  let availableTemplates = [];
  let templatesLoaded = false;
  let selectedTemplateName = '';
  let saveProjectTimer = null;
  let saveRequestQueue = Promise.resolve();
  let pendingSaveCallbacks = [];

  let attachmentRenameTarget = null;
  const SCRIPT_ROOT = {{ request.script_root|tojson }} || '';
  function buildApiUrl(path){
    if(!path) return SCRIPT_ROOT || '';
    if(path.startsWith('http://') || path.startsWith('https://')) return path;
    if(path.startsWith('/')) return (SCRIPT_ROOT || '') + path;
    return (SCRIPT_ROOT || '') + '/' + path;
  }
  const PROJECT_ENDPOINTS = {
    list: buildApiUrl('/projects'),
    create: buildApiUrl('/projects/create'),
    rename: buildApiUrl('/projects/rename'),
    delete: buildApiUrl('/projects/delete'),
    password: buildApiUrl('/projects/password'),
    unlock: buildApiUrl('/projects/unlock'),
    lock: buildApiUrl('/projects/lock'),
    project: buildApiUrl('/project'),
    projectSave: buildApiUrl('/project'),
  };
  const attachmentRenameModalEl = document.getElementById('attachmentRenameModal');
  const attachmentRenameInput = document.getElementById('attachment-rename-input');
  const attachmentRenameConfirm = document.getElementById('attachment-rename-confirm');
  const attachmentPreviewModalEl = document.getElementById('attachmentPreviewModal');
  const attachmentPreviewImage = document.getElementById('attachment-preview-image');
  const attachmentPreviewMeta = document.getElementById('attachment-preview-meta');
  const attachmentPreviewOpen = document.getElementById('attachment-preview-open');
  const ossSyncModalEl = document.getElementById('ossSyncModal');
  const ossSyncToggleMain = document.getElementById('oss-sync-toggle-main');
  const ossSyncWarningMain = document.getElementById('oss-sync-warning-main');
  const ossSyncAttachments = document.getElementById('oss-sync-attachments');
  const ossSyncResources = document.getElementById('oss-sync-resources');
  const ossSyncYaml = document.getElementById('oss-sync-yaml');
  const ossSyncStatusBox = document.getElementById('oss-sync-status');
  const ossSyncRunBtn = document.getElementById('oss-sync-run');
  let projectMetadata = {};
  let projectRenameTarget = '';
  let projectDeleteTarget = '';
  let projectPasswordTarget = '';
  let projectUnlockTargetName = '';
  const projectCreateModalEl = document.getElementById('projectCreateModal');
  const projectCreateNameInput = document.getElementById('project-create-name');
  const projectCreateConfirmBtn = document.getElementById('project-create-confirm');
  const projectRenameModalEl = document.getElementById('projectRenameModal');
  const projectRenameCurrent = document.getElementById('project-rename-current');
  const projectRenameInput = document.getElementById('project-rename-name');
  const projectRenameConfirmBtn = document.getElementById('project-rename-confirm');
  const projectDeleteModalEl = document.getElementById('projectDeleteModal');
  const projectDeleteWarning = document.getElementById('project-delete-warning');
  const projectDeleteConfirmInput = document.getElementById('project-delete-confirm-name');
  const projectDeleteConfirmBtn = document.getElementById('project-delete-confirm');
  const projectPasswordModalEl = document.getElementById('projectPasswordModal');
  const projectPasswordCurrentInput = document.getElementById('project-password-current');
  const projectPasswordNewInput = document.getElementById('project-password-new');
  const projectPasswordConfirmInput = document.getElementById('project-password-confirm');
  const projectPasswordWarning = document.getElementById('project-password-warning');
  const projectPasswordConfirmBtn = document.getElementById('project-password-confirm');
  const projectPasswordRemoveBtn = document.getElementById('project-password-remove');
  const projectUnlockModalEl = document.getElementById('projectUnlockModal');
  const projectUnlockTargetLabel = document.getElementById('project-unlock-target');
  const projectUnlockPasswordInput = document.getElementById('project-unlock-password');
  const projectUnlockErrorBox = document.getElementById('project-unlock-error');
  const projectUnlockConfirmBtn = document.getElementById('project-unlock-confirm');

  if(attachmentRenameModalEl){
    attachmentRenameModalEl.addEventListener('hidden.bs.modal', () => {
      attachmentRenameTarget = null;
      if(attachmentRenameInput) attachmentRenameInput.value = '';
    });
  }

  if(attachmentPreviewModalEl){
    attachmentPreviewModalEl.addEventListener('hidden.bs.modal', () => {
      if(attachmentPreviewImage) attachmentPreviewImage.removeAttribute('src');
      if(attachmentPreviewMeta) attachmentPreviewMeta.textContent = '';
    });
  }

  if(projectCreateModalEl){
    projectCreateModalEl.addEventListener('hidden.bs.modal', () => {
      if(projectCreateNameInput) projectCreateNameInput.value = '';
    });
    projectCreateModalEl.addEventListener('shown.bs.modal', () => {
      if(projectCreateNameInput) projectCreateNameInput.focus();
    });
  }

  if(projectRenameModalEl){
    projectRenameModalEl.addEventListener('hidden.bs.modal', () => {
      projectRenameTarget = '';
      if(projectRenameInput) projectRenameInput.value = '';
    });
    projectRenameModalEl.addEventListener('shown.bs.modal', () => {
      if(projectRenameInput) projectRenameInput.focus();
    });
  }

  if(projectDeleteModalEl){
    projectDeleteModalEl.addEventListener('hidden.bs.modal', () => {
      projectDeleteTarget = '';
      if(projectDeleteConfirmInput){
        projectDeleteConfirmInput.value = '';
        projectDeleteConfirmInput.classList.remove('is-invalid');
      }
    });
    projectDeleteModalEl.addEventListener('shown.bs.modal', () => {
      if(projectDeleteConfirmInput) projectDeleteConfirmInput.focus();
    });
  }

  if(projectPasswordModalEl){
    projectPasswordModalEl.addEventListener('hidden.bs.modal', () => {
      projectPasswordTarget = '';
      if(projectPasswordCurrentInput) projectPasswordCurrentInput.value = '';
      if(projectPasswordNewInput) projectPasswordNewInput.value = '';
      if(projectPasswordConfirmInput) projectPasswordConfirmInput.value = '';
      if(projectPasswordWarning){
        projectPasswordWarning.textContent = '';
        projectPasswordWarning.classList.add('d-none');
      }
    });
    projectPasswordModalEl.addEventListener('shown.bs.modal', () => {
      if(projectPasswordNewInput) projectPasswordNewInput.focus();
    });
  }

  if(projectUnlockModalEl){
    projectUnlockModalEl.addEventListener('hidden.bs.modal', () => {
      projectUnlockTargetName = '';
      if(projectUnlockPasswordInput) projectUnlockPasswordInput.value = '';
      if(projectUnlockErrorBox){
        projectUnlockErrorBox.classList.add('d-none');
        projectUnlockErrorBox.textContent = '';
      }
    });
    projectUnlockModalEl.addEventListener('shown.bs.modal', () => {
      if(projectUnlockPasswordInput) projectUnlockPasswordInput.focus();
    });
  }

  function renderSyncEntry(entry){
    if(!entry) return '无数据';
    if(entry.error) return `失败：${entry.error}`;
    if(Object.prototype.hasOwnProperty.call(entry, 'uploaded') && Object.prototype.hasOwnProperty.call(entry, 'removed')){
      const uploaded = Array.isArray(entry.uploaded) ? entry.uploaded.length : 0;
      const removed = Array.isArray(entry.removed) ? entry.removed.length : 0;
      const failed = Array.isArray(entry.failed) ? entry.failed.length : 0;
      return `上传 ${uploaded}，删除 ${removed}，失败 ${failed}`;
    }
    if(Object.prototype.hasOwnProperty.call(entry, 'uploaded') && Object.prototype.hasOwnProperty.call(entry, 'url')){
      if(entry.error) return `失败：${entry.error}`;
      if(entry.uploaded) return entry.url ? `已上传 (${entry.url})` : '已上传';
      return '未上传';
    }
    return JSON.stringify(entry);
  }

  function getProjectMeta(name){
    if(!name) return {};
    return projectMetadata && Object.prototype.hasOwnProperty.call(projectMetadata, name) ? (projectMetadata[name] || {}) : {};
  }

  function closeProjectDropdown(){
    const dropdownToggle = document.getElementById('project-dropdown');
    if(!dropdownToggle) return;
    const dropdown = bootstrap.Dropdown.getInstance(dropdownToggle);
    if(dropdown) dropdown.hide();
  }

  function openProjectUnlockModal(name){
    projectUnlockTargetName = name || currentProject || '';
    if(projectUnlockTargetLabel){
      const labelName = projectUnlockTargetName || '当前项目';
      projectUnlockTargetLabel.textContent = `项目「${labelName}」已加密，请输入密码解锁。`;
    }
    if(projectUnlockErrorBox){
      projectUnlockErrorBox.classList.add('d-none');
      projectUnlockErrorBox.textContent = '';
    }
    if(projectUnlockPasswordInput) projectUnlockPasswordInput.value = '';
    if(projectUnlockModalEl){
      const modal = bootstrap.Modal.getOrCreateInstance(projectUnlockModalEl);
      modal.show();
    }
  }

  function handleProjectLocked(message){
    const info = message || '项目已加密，请先解锁';
    showStatus(info, 'warning', 6000);
    openProjectUnlockModal(currentProject);
  }

  function createMenuAction(menu, {id, label, handler, disabled}) {
    const li = document.createElement('li');
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'dropdown-item';
    if(id) btn.id = id;
    btn.textContent = label;
    if(disabled) btn.disabled = true;
    btn.addEventListener('click', () => {
      closeProjectDropdown();
      if(typeof handler === 'function') handler();
    });
    li.dataset.projectAction = 'item';
    li.appendChild(btn);
    menu.appendChild(li);
    return btn;
  }

  function buildProjectMenu(menu, projects){
    menu.innerHTML = '';
    const header = document.createElement('li');
    header.innerHTML = '<h6 class="dropdown-header">项目</h6>';
    menu.appendChild(header);

    if(!projects.length){
      const empty = document.createElement('li');
      empty.innerHTML = '<span class="dropdown-item-text text-muted">无项目</span>';
      menu.appendChild(empty);
    } else {
      projects.forEach(name => {
        const li = document.createElement('li');
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'dropdown-item d-flex justify-content-between align-items-center';
        if(name === currentProject) btn.classList.add('active');
        const label = document.createElement('span');
        label.textContent = name;
        btn.appendChild(label);
        const meta = getProjectMeta(name);
        if(meta.locked){
          const badge = document.createElement('span');
          badge.className = 'badge rounded-pill ' + (meta.unlocked ? 'bg-success' : 'bg-warning text-dark');
          badge.textContent = meta.unlocked ? '已解锁' : '需密码';
          btn.appendChild(badge);
        }
        btn.addEventListener('click', () => {
          menu.querySelectorAll('.dropdown-item').forEach(item => item.classList.remove('active'));
          btn.classList.add('active');
          currentProject = name;
          currentPageIdx = 0;
          updateProjectButtonLabel();
          const metaNow = getProjectMeta(name);
          if(metaNow.locked && !metaNow.unlocked){
            closeProjectDropdown();
            showStatus('项目已加密，请输入密码后继续', 'warning', 6000);
            openProjectUnlockModal(name);
            return;
          }
          closeProjectDropdown();
          loadProject();
        });
        li.appendChild(btn);
        menu.appendChild(li);
      });
    }
    renderProjectActionsSection(menu);
  }

  function renderProjectActionsSection(menu){
    if(!menu) return;
    menu.querySelectorAll('[data-project-action]').forEach(node => node.remove());

    const divider = document.createElement('li');
    divider.dataset.projectAction = 'divider';
    divider.innerHTML = '<hr class="dropdown-divider">';
    menu.appendChild(divider);

    const manageHeader = document.createElement('li');
    manageHeader.dataset.projectAction = 'header';
    manageHeader.innerHTML = '<h6 class="dropdown-header">管理</h6>';
    menu.appendChild(manageHeader);

    const currentMeta = getProjectMeta(currentProject);
    const hasProject = !!currentProject;
    const locked = !!currentMeta.locked;
    const unlocked = !!currentMeta.unlocked;

    createMenuAction(menu, {
      id: 'project-action-create',
      label: '新建项目',
      handler: openProjectCreateModal,
      disabled: false,
    });
    createMenuAction(menu, {
      id: 'project-action-rename',
      label: '重命名当前项目',
      handler: () => openProjectRenameModal(currentProject),
      disabled: !hasProject,
    });
    createMenuAction(menu, {
      id: 'project-action-delete',
      label: '删除当前项目',
      handler: () => openProjectDeleteModal(currentProject),
      disabled: !hasProject,
    });
    createMenuAction(menu, {
      id: 'project-action-password',
      label: '设置/修改密码',
      handler: () => openProjectPasswordModal(currentProject),
      disabled: !hasProject,
    });
    createMenuAction(menu, {
      id: 'project-action-unlock',
      label: '解锁当前项目',
      handler: () => {
        if(hasProject){
          showStatus('请输入密码解锁项目', 'info', 5000);
          openProjectUnlockModal(currentProject);
        }
      },
      disabled: !(hasProject && locked && !unlocked),
    });
    createMenuAction(menu, {
      id: 'project-action-lock',
      label: '锁定当前项目',
      handler: lockCurrentProject,
      disabled: !(hasProject && locked && unlocked),
    });
  }

  async function refreshOssSyncModal(){
    if(!ossSyncModalEl) return;
    if(ossSyncStatusBox) ossSyncStatusBox.textContent = '加载中...';
    try{
      const res = await fetch('/oss/status');
      const parsed = await parseJsonSafe(res);
      const payload = parsed.json || {};
      if(!(res.ok && payload.success !== false)){
        const errorMsg = (payload.error) ? payload.error : (parsed.text || `HTTP ${res.status}`);
        if(ossSyncStatusBox) ossSyncStatusBox.textContent = `获取状态失败：${errorMsg}`;
        if(ossSyncToggleMain){
          ossSyncToggleMain.disabled = true;
          ossSyncToggleMain.checked = false;
        }
        if(ossSyncWarningMain){
          ossSyncWarningMain.classList.remove('d-none');
          ossSyncWarningMain.textContent = '无法读取 OSS 状态';
        }
        if(ossSyncRunBtn) ossSyncRunBtn.disabled = true;
        return;
      }

      const configured = !!payload.ossConfigured;
      const enabled = !!payload.syncEnabled && configured;

      if(ossSyncToggleMain){
        ossSyncToggleMain.dataset.configured = configured ? 'true' : 'false';
        ossSyncToggleMain.disabled = !configured;
        ossSyncToggleMain.checked = enabled;
      }
      if(ossSyncRunBtn){
        ossSyncRunBtn.disabled = !configured;
      }

      if(ossSyncWarningMain){
        if(!configured){
          ossSyncWarningMain.classList.remove('d-none');
          ossSyncWarningMain.textContent = '未检测到 OSS 配置，所有文件仅保存在本地。';
        } else {
          ossSyncWarningMain.classList.add('d-none');
          ossSyncWarningMain.textContent = '';
        }
      }

      if(ossSyncAttachments) ossSyncAttachments.textContent = payload.attachmentsPath || '未知';
      if(ossSyncResources) ossSyncResources.textContent = payload.resourcesPath || '未知';
      if(ossSyncYaml) ossSyncYaml.textContent = payload.yamlPath || '未生成';

      if(ossSyncStatusBox){
        const statusParts = [];
        statusParts.push(configured ? (enabled ? '同步已开启' : '同步已关闭') : 'OSS 未配置');
        if(payload.project) statusParts.push(`项目：${payload.project}`);
        if(payload.message) statusParts.push(payload.message);
        ossSyncStatusBox.textContent = statusParts.join('；') || '状态未知';
      }
    }catch(e){
      if(ossSyncStatusBox) ossSyncStatusBox.textContent = `获取状态失败：${e.message}`;
      if(ossSyncToggleMain){
        ossSyncToggleMain.disabled = true;
        ossSyncToggleMain.checked = false;
      }
      if(ossSyncRunBtn) ossSyncRunBtn.disabled = true;
      if(ossSyncWarningMain){
        ossSyncWarningMain.classList.remove('d-none');
        ossSyncWarningMain.textContent = '无法连接服务器获取同步状态';
      }
    }
  }


  function updateModeToggleUI() {
    const switchBtn = document.getElementById('mode-switch-btn');
    if (switchBtn) {
      switchBtn.textContent = currentEditMode === 'latex' ? 'LaTeX' : 'Markdown';
    }
  }

  function showStatus(message, type = 'info', timeout = 4000) {
    const area = document.getElementById('status-area');
    if (!area) return;
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show shadow`;
    alertDiv.setAttribute('role', 'alert');
    alertDiv.textContent = message;
    area.appendChild(alertDiv);
    setTimeout(() => {
      alertDiv.classList.remove('show');
      alertDiv.classList.add('fade');
      setTimeout(() => alertDiv.remove(), 200);
    }, timeout);
  }

  async function exportTex() {
    try {
      const res = await fetch('/export_tex');
      if (!res.ok) {
        const parsed = await parseJsonSafe(res);
        const message = (parsed.json && parsed.json.error) ? parsed.json.error : (parsed.text || `HTTP ${res.status}`);
        showStatus('导出 TeX 失败：' + message, 'danger', 6000);
        return;
      }
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'exported_full.tex';
      document.body.appendChild(link);
      link.click();
      link.remove();
      URL.revokeObjectURL(url);
      showStatus('TeX 导出完成', 'success', 2500);
    } catch (err) {
      console.error('导出 TeX 失败', err);
      showStatus('导出 TeX 失败：' + (err?.message || '未知错误'), 'danger', 6000);
    }
  }

  function updateProjectButtonLabel() {
    const btn = document.getElementById('project-dropdown');
    if (!btn) return;
    if(!currentProject){
      btn.textContent = 'Benort';
      renderProjectActionsSection(document.getElementById('project-menu'));
      return;
    }
    const meta = getProjectMeta(currentProject);
    let suffix = '';
    if(meta.locked){
      suffix = meta.unlocked ? '（已解锁）' : '（已加密）';
    }
    btn.textContent = `Benort · ${currentProject}${suffix}`;
    renderProjectActionsSection(document.getElementById('project-menu'));
  }

  function normalizeTemplateText(text) {
    return (text || '').replace(/\r\n/g, '\n').trim();
  }

  function detectCurrentTemplate() {
    if (!templatesLoaded) return;
    const header = normalizeTemplateText(latexTemplate.header);
    const before = normalizeTemplateText(latexTemplate.beforePages);
    const footer = normalizeTemplateText(latexTemplate.footer);
    const match = availableTemplates.find(t =>
      normalizeTemplateText(t.header) === header &&
      normalizeTemplateText(t.beforePages) === before &&
      normalizeTemplateText(t.footer) === footer
    );
    selectedTemplateName = match ? match.name : '';
  }

  function ensureTemplatesLoaded() {
    if (templatesLoaded) return Promise.resolve(availableTemplates);
    return fetch('/templates/list')
      .then(res => res.json())
      .then(data => {
        availableTemplates = Array.isArray(data.templates) ? data.templates : [];
        templatesLoaded = true;
        detectCurrentTemplate();
        return availableTemplates;
      })
      .catch(err => {
        showStatus('加载模板列表失败：' + (err?.message || '未知错误'), 'danger', 6000);
        throw err;
      });
  }

  function populateTemplateSelect() {
    const select = document.getElementById('template-select');
    if (!select) return;
    const currentValue = selectedTemplateName || '';
    select.innerHTML = '';
    const customOption = document.createElement('option');
    customOption.value = '';
    customOption.textContent = '自定义（当前模板）';
    select.appendChild(customOption);
    availableTemplates.forEach(t => {
      const opt = document.createElement('option');
      opt.value = t.name;
      opt.textContent = t.name;
      select.appendChild(opt);
    });
    select.value = currentValue;
  }

  function applyTemplateByName(name) {
    const tmpl = availableTemplates.find(t => t.name === name);
    if (!tmpl) return;
    document.getElementById('template-header').value = tmpl.header || '';
    document.getElementById('template-before-pages').value = tmpl.beforePages || '';
    document.getElementById('template-footer').value = tmpl.footer || '';
    selectedTemplateName = name;
  }

  function renderMarkdownPreview() {
    const wrapper = document.getElementById('markdown-preview');
    const preview = document.getElementById('markdown-preview-content') || wrapper;
    if (!wrapper || !preview) return;
    const md = pagesData[currentPageIdx]?.notes || '';
    if (md.trim()) {
      preview.innerHTML = marked.parse(md);
    } else {
      preview.innerHTML = '<p class="text-muted mb-0">暂无 Markdown 内容</p>';
    }
    if (window.hljs && preview.querySelectorAll) {
      preview.querySelectorAll('pre code').forEach(block => {
        hljs.highlightElement(block);
      });
    }
    enhanceCodeCopy(preview);
    if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
      try {
        if (typeof window.MathJax.typesetClear === 'function') {
          window.MathJax.typesetClear([preview]);
        }
      } catch (err) {
        console.warn('清理 MathJax 队列失败', err);
      }
      window.MathJax.typesetPromise([preview])
        .then(() => enhanceMathCopy(preview))
        .catch(err => console.warn('MathJax 渲染失败', err));
    }
  }

  async function copyTextToClipboard(text) {
    try {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        await navigator.clipboard.writeText(text);
      } else {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.focus();
        textarea.select();
        document.execCommand('copy');
        textarea.remove();
      }
      return true;
    } catch (err) {
      console.warn('复制失败', err);
      return false;
    }
  }

  function attachCopyButton(target, text, label, inline = false) {
    if (!target || !text) return;
    const parent = target.parentElement;
    if (!parent) return;
    const wrapper = document.createElement(inline ? 'span' : 'div');
    wrapper.className = 'copy-trigger-wrapper' + (inline ? ' inline-copy' : '');
    parent.insertBefore(wrapper, target);
    wrapper.appendChild(target);

    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'copy-trigger-btn btn btn-sm btn-outline-secondary';
    btn.textContent = '复制';
    btn.setAttribute('aria-label', `复制${label}`);
    btn.addEventListener('click', async (ev) => {
      ev.preventDefault();
      ev.stopPropagation();
      const ok = await copyTextToClipboard(text);
      if (ok) {
        showStatus(`${label}已复制`, 'success', 2000);
      } else {
        showStatus(`复制${label}失败`, 'warning', 3000);
      }
    });
    wrapper.appendChild(btn);
  }

  function enhanceCodeCopy(preview) {
    if (!preview || !preview.querySelectorAll) return;
    preview.querySelectorAll('pre').forEach(pre => {
      if (pre.closest('.copy-trigger-wrapper')) return;
      const code = pre.querySelector('code');
      const text = code ? code.textContent || '' : pre.textContent || '';
      if (!text.trim()) return;
      attachCopyButton(pre, text, '代码');
    });
  }

  function enhanceMathCopy(preview) {
    if (!preview || !window.MathJax || !MathJax.startup || !MathJax.startup.document) return;
    const items = MathJax.startup.document.math || [];
    items.forEach(item => {
      const root = item && item.typesetRoot;
      if (!root || !preview.contains(root)) return;
      if (!item.display) return; // 仅对块级公式启用复制按钮
      let tex = (item.math || item.originalText || '').trim();
      if (!tex) return;
      if (!/^((\$\$)|(\\\[)|(\\begin))/i.test(tex)) {
        tex = `$$${tex}$$`;
      }
      if (root.closest('.copy-trigger-wrapper')) return;
      attachCopyButton(root, tex, '公式');
    });
  }

  function syncPaneHeights() {
    if (singleEditor) {
      setTimeout(() => singleEditor.refresh(), 0);
    }
  }

  function queueCompile(delay = 600) {
    if (compileTimer) clearTimeout(compileTimer);
    compileTimer = setTimeout(runCompile, delay);
  }

  function runCompile() {
    if (isCompiling) {
      compilePending = true;
      return;
    }
    isCompiling = true;
    compilePending = false;
    fetch('/compile_page', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({page: currentPageIdx})
    }).then(res => res.json()).then(data => {
      if (data.success) {
        loadCurrentPagePDF();
      } else {
        showStatus('编译失败：' + (data.error || '未知错误'), 'danger', 6000);
      }
    }).catch(err => {
      showStatus('编译失败：' + (err?.message || '网络错误'), 'danger', 6000);
    }).finally(() => {
      isCompiling = false;
      if (compilePending) {
        compilePending = false;
        runCompile();
      }
    });
  }

  function refreshPreview() {
    const pdfContainer = document.getElementById('pdf-container');
    const markdownContainer = document.getElementById('markdown-preview');
    if (currentEditMode === 'latex') {
      pdfContainer?.classList.remove('d-none');
      markdownContainer?.classList.add('d-none');
      loadCurrentPagePDF();
    } else {
      pdfContainer?.classList.add('d-none');
      markdownContainer?.classList.remove('d-none');
      renderMarkdownPreview();
    }
    updateModeToggleUI();
    syncPaneHeights();
  }

  function setEditMode(mode) {
    if (currentEditMode === mode) return;
    currentEditMode = mode;
    renderSingleEditor();
  }

  updateModeToggleUI();
  window.addEventListener('resize', syncPaneHeights);
  
  function renderTabsModal() {
    const tabs = document.getElementById('page-tabs');
    tabs.innerHTML = '';
    pagesData.forEach((_, idx) => {
      const tab = document.createElement('div');
      tab.className = 'badge rounded-pill bg-' + (idx === currentPageIdx ? 'primary' : 'secondary') + ' me-1 mb-1';
      tab.textContent = idx + 1;
      tab.setAttribute('draggable', 'true');
      tab.style.cursor = 'grab';
      tab.ondragstart = e => {
        e.dataTransfer.setData('text/plain', idx);
        tab.classList.add('opacity-50');
      };
      tab.ondragend = e => tab.classList.remove('opacity-50');
      tab.ondragover = e => e.preventDefault();
      tab.ondrop = e => {
        e.preventDefault();
        const from = parseInt(e.dataTransfer.getData('text/plain'));
        const to = idx;
        if (from !== to) {
          const moved = pagesData.splice(from, 1)[0];
          pagesData.splice(to, 0, moved);
          if (currentPageIdx === from) currentPageIdx = to;
          else if (from < currentPageIdx && to >= currentPageIdx) currentPageIdx--;
          else if (from > currentPageIdx && to <= currentPageIdx) currentPageIdx++;
          saveProject();
          renderTabsModal();
          renderSingleEditor();
          updatePageNumLabel();
          refreshPreview();
        }
      };
      tab.onclick = () => {
        currentPageIdx = idx;
        renderSingleEditor();
        refreshPreview();
        updatePageNumLabel();
        var modal = bootstrap.Modal.getInstance(document.getElementById('tabsModal'));
        modal.hide();
      };
      tabs.appendChild(tab);
    });
  }
  
  function renderSingleEditor() {
    const list = document.getElementById('pages-list');
    list.innerHTML = '';
    const wrapper = document.createElement('div');
    wrapper.className = 'mb-3';
    wrapper.innerHTML = `<textarea id="page-single" class="form-control"></textarea>`;
    list.appendChild(wrapper);
    if (!pagesData[currentPageIdx]) {
      pagesData[currentPageIdx] = {content: '', script: '', notes: '', bib: [], resources: []};
    }
    const page = pagesData[currentPageIdx];
    singleEditor = CodeMirror.fromTextArea(wrapper.querySelector('textarea'), {
      mode: currentEditMode === 'markdown' ? 'markdown' : 'stex',
      lineNumbers: true,
      theme: 'default',
      viewportMargin: Infinity,
      lineWrapping: true
    });
    const initialValue = currentEditMode === 'markdown' ? (page.notes || '') : (page.content || '');
    singleEditor.setValue(initialValue);
    singleEditor.setSize('100%', '100%');
    singleEditor.on('change', function() {
      const value = singleEditor.getValue();
      if (currentEditMode === 'markdown') {
        pagesData[currentPageIdx].notes = value;
        renderMarkdownPreview();
      } else {
        pagesData[currentPageIdx].content = value;
      }
      saveProject();
      queueCompile();
    });
    const scriptInput = document.getElementById('page-script');
    scriptInput.value = page.script || '';
    updateModeToggleUI();
    refreshPreview();
    // refresh resources list for this page
    setTimeout(()=>{ if(window.refreshResourceLists) refreshResourceLists(); }, 50);
    queueCompile();
  }
  
  document.getElementById('page-num').parentElement.onclick = function() {
    renderTabsModal();
    var modal = new bootstrap.Modal(document.getElementById('tabsModal'));
    modal.show();
  };

  function removeCurrentPage() {
    if(pagesData.length <= 1) return;
    pagesData.splice(currentPageIdx, 1);
    if(currentPageIdx >= pagesData.length) currentPageIdx = pagesData.length - 1;
    saveProject();
    renderSingleEditor();
    updatePageNumLabel();
  }


  
  document.getElementById('add-page').onclick = function() {
    fetch('/add_page', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({idx: currentPageIdx+1})
    }).then(res => res.json()).then(data => {
      pagesData = data.pages;
      currentPageIdx++;
      renderSingleEditor();
      updatePageNumLabel();
      refreshPreview();
    });
  };
  const modeSwitchBtn = document.getElementById('mode-switch-btn');
  if (modeSwitchBtn) {
    modeSwitchBtn.addEventListener('click', () => {
      const nextMode = currentEditMode === 'latex' ? 'markdown' : 'latex';
      setEditMode(nextMode);
    });
  }
  updateModeToggleUI();
  
  document.getElementById('edit-template').onclick = function() {
    document.getElementById('template-header').value = latexTemplate.header || '';
    document.getElementById('template-before-pages').value = latexTemplate.beforePages || '';
    document.getElementById('template-footer').value = latexTemplate.footer || '';
    ensureTemplatesLoaded().finally(() => {
      detectCurrentTemplate();
      populateTemplateSelect();
    });
    var modal = new bootstrap.Modal(document.getElementById('templateModal'));
    modal.show();
  };
  document.getElementById('save-template').onclick = function() {
    const headerVal = document.getElementById('template-header').value;
    const beforeVal = document.getElementById('template-before-pages').value;
    const footerVal = document.getElementById('template-footer').value;
    latexTemplate.header = headerVal;
    latexTemplate.beforePages = beforeVal;
    latexTemplate.footer = footerVal;
    const selectEl = document.getElementById('template-select');
    const chosen = selectEl ? selectEl.value : '';
    if (chosen) {
      const tmpl = availableTemplates.find(t => t.name === chosen);
      if (
        tmpl &&
        normalizeTemplateText(tmpl.header) === normalizeTemplateText(headerVal) &&
        normalizeTemplateText(tmpl.beforePages) === normalizeTemplateText(beforeVal) &&
        normalizeTemplateText(tmpl.footer) === normalizeTemplateText(footerVal)
      ) {
        selectedTemplateName = chosen;
      } else {
        selectedTemplateName = '';
        if (selectEl) selectEl.value = '';
      }
    } else {
      selectedTemplateName = '';
    }
    detectCurrentTemplate();
    saveProject();
    queueCompile();
    var modal = bootstrap.Modal.getInstance(document.getElementById('templateModal'));
    modal.hide();
  };

  
  document.getElementById('tex-form').onsubmit = function(e) {
    e.preventDefault();
    saveProject();
  };

  
  // export-tex button removed; unified export flow handled by export modal

  // New unified export flow
  const exportBtn = document.getElementById('export-btn');
  if(exportBtn) exportBtn.addEventListener('click', function(){
    var modal = new bootstrap.Modal(document.getElementById('exportModal'));
    modal.show();
  });

  const templateSelectEl = document.getElementById('template-select');
  if (templateSelectEl) templateSelectEl.addEventListener('change', function(){
    const name = this.value;
    if (name) {
      applyTemplateByName(name);
    } else {
      selectedTemplateName = '';
    }
  });

  document.getElementById('doExportBtn').addEventListener('click', function(){
    const opt = document.querySelector('input[name="exportOption"]:checked').value;
    var modalEl = document.getElementById('exportModal');
    var modal = bootstrap.Modal.getInstance(modalEl);
    modal.hide();
    if(opt === 'tex') return exportTex();
    if(opt === 'attachments') {
      fetch('/export_attachments').then(res => {
        if(res.ok) return res.blob();
        return res.json().then(data=>{throw new Error(data.error||'导出失败')});
      }).then(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'attachments.zip'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        showStatus('资料与附件已导出', 'success', 2500);
      }).catch(e=>alert('导出失败：'+e.message));
      return;
    }
    if(opt === 'page_pdf') {
      const pageNumber = currentPageIdx + 1;
      fetch(`/export_page_pdf?page=${pageNumber}`).then(res => {
        if(res.ok) return res.blob();
        return res.json().then(data=>{throw new Error(data.error||'导出失败')});
      }).then(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `slide_page_${pageNumber}.pdf`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        showStatus(`第 ${pageNumber} 页 PDF 已导出`, 'success', 2500);
      }).catch(e=>alert('导出失败：'+e.message));
      return;
    }
    if(opt === 'audio'){
      // request the server to produce audio from 'script' (讲稿)
      fetch('/export_audio').then(res => {
        if(res.ok) return res.blob();
        return res.json().then(data=>{throw new Error(data.error||'导出失败')});
      }).then(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'script.mp3'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        showStatus('讲稿语音已导出', 'success', 2500);
      }).catch(e=>alert('导出失败：'+e.message));
      return;
    }
    if(opt === 'notes'){
      fetch('/export_notes').then(res => {
        if(res.ok) return res.blob();
        return res.json().then(data=>{throw new Error(data.error||'导出失败')});
      }).then(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'notes.md'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        showStatus('笔记已导出', 'success', 2500);
      }).catch(e=>alert('导出失败：'+e.message));
      return;
    }
  });
  
  function flushProjectSave(callbacks) {
    const payload = {
      template: latexTemplate,
      pages: pagesData,
      resources: globalResources,
    };
    saveRequestQueue = saveRequestQueue
      .catch(() => {})
      .then(() => fetch(PROJECT_ENDPOINTS.projectSave || '/project', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload),
      }))
      .then(async response => {
        if (!response.ok) {
          let message = '保存接口返回错误';
          try {
            const parsed = await parseJsonSafe(response);
            if(parsed.json && parsed.json.error){
              message = parsed.json.error;
            } else if(parsed.text){
              message = parsed.text;
            } else {
              message = `HTTP ${response.status}`;
            }
          } catch (e) {
            message = `HTTP ${response.status}`;
          }
          throw new Error(message);
        }
        callbacks.forEach(cb => {
          try {
            cb();
          } catch (err) {
            console.error('saveProject 回调执行失败:', err);
          }
        });
      })
      .catch(err => {
        console.error('保存项目失败:', err);
        showStatus('保存失败：' + (err?.message || '网络错误'), 'danger', 6000);
      });
  }

  function saveProject(cb) {
    if (typeof cb === 'function') {
      pendingSaveCallbacks.push(cb);
    }
    if (saveProjectTimer) {
      clearTimeout(saveProjectTimer);
    }
    saveProjectTimer = setTimeout(() => {
      saveProjectTimer = null;
      const callbacks = pendingSaveCallbacks.slice();
      pendingSaveCallbacks = [];
      flushProjectSave(callbacks);
    }, 400);
  }

  
  function loadProject(cb) {
    const projectUrl = PROJECT_ENDPOINTS.project || '/project';
    return fetch(projectUrl)
      .then(async res => {
        let data;
        try {
          data = await res.json();
        } catch (e) {
          data = {};
        }
        if (res.status === 401) {
          return null;
        }
        if (!res.ok) {
          const message = data && data.error ? data.error : `HTTP ${res.status}`;
          throw new Error(message);
        }
        return data;
      })
      .then(data => {
        if (!data) return;
        latexTemplate = typeof data.template === 'string' ? {
          header: data.template,
          beforePages: '\\begin{document}',
          footer: '\\end{document}'
        } : (data.template || latexTemplate);

        pagesData = (data.pages || []).map(p => {
          if(typeof p === 'string') return {content: p, script: '', notes: '', bib: [], resources: []};
          p.script = p.script || '';
          p.notes = p.notes || '';
          p.bib = Array.isArray(p.bib) ? p.bib : [];
          p.resources = Array.isArray(p.resources) ? p.resources : [];
          return p;
        });
        if(pagesData.length === 0) pagesData = [{content: '', script: '', notes: '', bib: [], resources: []}];
        globalResources = Array.isArray(data.resources) ? data.resources.slice() : [];
        currentPageIdx = Math.min(currentPageIdx, pagesData.length - 1);
        updateProjectButtonLabel();
        renderSingleEditor();
        updatePageNumLabel();
        ensureTemplatesLoaded().then(() => detectCurrentTemplate()).catch(() => {});
        if(cb) cb();
      })
      .catch(err => {
        if(!err) return;
        console.error(err);
        showStatus('加载项目失败：' + (err?.message || '未知错误'), 'danger', 6000);
      });
  }
  
  document.addEventListener('input', function(e) {
    if(!e.target) return;
    if(e.target.id === 'page-script') {
      pagesData[currentPageIdx].script = e.target.value;
      saveProject();
      queueCompile();
    }
  });



  
  const pdfPagesContainer = document.getElementById('pdf-pages');
  let currentPdfRequestId = 0;

  function resetPdfViewer() {
    if (pdfPagesContainer) {
      pdfPagesContainer.innerHTML = '';
    }
  }

  function renderMessage(message, requestId) {
    if (!pdfPagesContainer || requestId !== currentPdfRequestId) return;
    resetPdfViewer();
    const holder = document.createElement('div');
    holder.className = 'text-muted small';
    holder.style.padding = '2rem';
    holder.textContent = message;
    pdfPagesContainer.appendChild(holder);
  }

  async function renderPdfDocument(pdf, requestId) {
    if (!pdfPagesContainer || requestId !== currentPdfRequestId) return;
    resetPdfViewer();
    const total = pdf.numPages;
    if (!total) {
      renderMessage('PDF 没有页面', requestId);
      return;
    }
    for (let i = 1; i <= total; i += 1) {
      if (requestId !== currentPdfRequestId) {
        return;
      }
      try {
        const page = await pdf.getPage(i);
        if (requestId !== currentPdfRequestId) {
          return;
        }
        const viewport = page.getViewport({ scale: 1.5 });
        const canvas = document.createElement('canvas');
        canvas.className = 'pdf-page-canvas shadow-sm';
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        pdfPagesContainer.appendChild(canvas);
        const ctx = canvas.getContext('2d');
        if (ctx) {
          await page.render({ canvasContext: ctx, viewport }).promise;
        }
      } catch (err) {
        console.error(`渲染 PDF 第 ${i} 页失败:`, err);
        renderMessage('PDF 渲染失败', requestId);
        return;
      }
    }
  }

  function loadCurrentPagePDF(retry = 0) {
    if (!pdfPagesContainer) return;
    const requestId = ++currentPdfRequestId;
    renderMessage('加载中...', requestId);
    const project = currentProject || '';
    const pdfUrl = `/page_pdf/${currentPageIdx + 1}?project=${encodeURIComponent(project)}&t=${Date.now()}`;
    fetch(pdfUrl, { method: 'HEAD' }).then(res => {
      if (requestId !== currentPdfRequestId) {
        return;
      }
      if (res.ok) {
        pdfjsLib.getDocument(pdfUrl).promise
          .then(pdf => renderPdfDocument(pdf, requestId))
          .catch(err => {
            console.error('加载 PDF 失败:', err);
            renderMessage('PDF 加载失败', requestId);
          });
      } else {
        if (retry < 3) {
          setTimeout(() => loadCurrentPagePDF(retry + 1), 800);
        } else {
          renderMessage('本页未编译', requestId);
        }
      }
    }).catch(err => {
      console.error('请求 PDF 失败:', err);
      if (retry < 3) {
        setTimeout(() => loadCurrentPagePDF(retry + 1), 800);
      } else if (requestId === currentPdfRequestId) {
        renderMessage('无法加载预览', requestId);
      }
    });
    document.getElementById('page-num').textContent = currentPageIdx + 1;
    document.getElementById('page-count').textContent = pagesData.length;
  }

  document.getElementById('prev-page').addEventListener('click', function() {
    if(currentPageIdx > 0) {
      currentPageIdx--;
      renderSingleEditor();
      refreshPreview();
      document.getElementById('page-num').textContent = currentPageIdx+1;
    }
  });
  document.getElementById('next-page').addEventListener('click', function() {
    if(currentPageIdx < pagesData.length-1) {
      currentPageIdx++;
      renderSingleEditor();
      refreshPreview();
      document.getElementById('page-num').textContent = currentPageIdx+1;
    }
  });

// --- multi-project client helpers ---
(function(){
  function getSelectedProject() {
    return currentProject || '';
  }

  function appendProjectQuery(url, key, value) {
    if(typeof url !== 'string') return url;
    const sep = url.indexOf('?') > -1 ? '&' : '?';
    return url + sep + encodeURIComponent(key) + '=' + encodeURIComponent(value);
  }

  function extractContentType(headers){
    if(!headers) return '';
    if(headers instanceof Headers){
      return headers.get('Content-Type') || headers.get('content-type') || '';
    }
    if(Array.isArray(headers)){
      for(const entry of headers){
        if(Array.isArray(entry) && entry.length >= 2 && typeof entry[0] === 'string' && entry[0].toLowerCase() === 'content-type'){
          return entry[1];
        }
      }
      return '';
    }
    if(typeof headers === 'object'){
      return headers['Content-Type'] || headers['content-type'] || '';
    }
    return '';
  }

  const _origFetch = window.fetch.bind(window);
  window.fetch = function(input, init){
    let requestUrl = input;
    let requestInit = init;
    let shouldTrack401 = false;

    try {
      if(typeof requestUrl === 'string' && requestUrl.startsWith('/')){
        shouldTrack401 = true;
        const project = getSelectedProject();
        if(project){
          if(requestInit && requestInit.body instanceof FormData){
            requestUrl = appendProjectQuery(requestUrl, 'project', project);
          } else if(requestInit && requestInit.headers){
            const contentType = extractContentType(requestInit.headers) || '';
            if(contentType.indexOf('application/json') > -1 && requestInit.body){
              try{
                const obj = JSON.parse(requestInit.body);
                obj.project = project;
                requestInit = Object.assign({}, requestInit, { body: JSON.stringify(obj) });
              }catch(e){}
            } else {
              requestUrl = appendProjectQuery(requestUrl, 'project', project);
            }
          } else {
            requestUrl = appendProjectQuery(requestUrl, 'project', project);
          }
        }
      }
    } catch(e) {
      // ignore and fall back to default fetch
    }

    const fetchPromise = _origFetch(requestUrl, requestInit);
    if(shouldTrack401){
      return fetchPromise.then(async res => {
        if(res.status === 401){
          let message = '';
          try{
            const header = res.headers.get('content-type') || res.headers.get('Content-Type') || '';
            if(header && header.indexOf('application/json') > -1){
              const data = await res.clone().json();
              if(data && data.error) message = data.error;
            } else {
              message = await res.clone().text();
            }
          }catch(err){
            message = '';
          }
          handleProjectLocked(message);
        }
        return res;
      });
    }
    return fetchPromise;
  };

  window.loadProjects = async function(){
    try{
      const listUrl = PROJECT_ENDPOINTS.list || '/projects';
      const res = await _origFetch(listUrl);
      if(!res.ok) return;
      const data = await res.json();
      const projects = Array.isArray(data.projects) ? data.projects : [];
      projectMetadata = data && typeof data.metadata === 'object' && data.metadata ? data.metadata : {};

      if(currentProject && projects.length && !projects.includes(currentProject)){
        currentProject = projects[0];
      }
      if(!currentProject){
        currentProject = data.default || projects[0] || '';
      }
      if(!currentProject && data.default){
        currentProject = data.default;
      }

      const menu = document.getElementById('project-menu');
      if(menu){
        buildProjectMenu(menu, projects);
      }
      updateProjectButtonLabel();
      return data;
    }catch(e){
      console.warn('loadProjects failed', e);
    }
  };
})();

  function openProjectCreateModal(){
    if(!projectCreateModalEl){
      showStatus('当前界面不支持新建项目', 'danger', 6000);
      return;
    }
    const modal = bootstrap.Modal.getOrCreateInstance(projectCreateModalEl);
    modal.show();
  }

  function openProjectRenameModal(target){
    const name = target || currentProject;
    if(!name){
      showStatus('暂无可重命名的项目', 'warning', 4000);
      return;
    }
    projectRenameTarget = name;
    if(projectRenameCurrent) projectRenameCurrent.textContent = `当前项目：${name}`;
    if(projectRenameInput){
      projectRenameInput.value = name;
      setTimeout(() => {
        try{ projectRenameInput.select(); } catch(e){}
      }, 100);
    }
    if(!projectRenameModalEl){
      showStatus('当前界面不支持重命名', 'danger', 6000);
      return;
    }
    const modal = bootstrap.Modal.getOrCreateInstance(projectRenameModalEl);
    modal.show();
  }

  function openProjectDeleteModal(target){
    const name = target || currentProject;
    if(!name){
      showStatus('暂无可删除的项目', 'warning', 4000);
      return;
    }
    projectDeleteTarget = name;
    if(projectDeleteWarning) projectDeleteWarning.textContent = `此操作无法撤销，将永久删除项目「${name}」及其所有附件与资源。`;
    if(projectDeleteConfirmInput){
      projectDeleteConfirmInput.value = '';
      projectDeleteConfirmInput.placeholder = name;
      projectDeleteConfirmInput.classList.remove('is-invalid');
    }
    if(!projectDeleteModalEl){
      showStatus('当前界面不支持删除项目', 'danger', 6000);
      return;
    }
    const modal = bootstrap.Modal.getOrCreateInstance(projectDeleteModalEl);
    modal.show();
  }

  function openProjectPasswordModal(target){
    const name = target || currentProject;
    if(!name){
      showStatus('暂无可设置密码的项目', 'warning', 4000);
      return;
    }
    projectPasswordTarget = name;
    if(projectPasswordModalEl) projectPasswordModalEl.dataset.project = name;
    if(projectPasswordCurrentInput) projectPasswordCurrentInput.value = '';
    if(projectPasswordNewInput) projectPasswordNewInput.value = '';
    if(projectPasswordConfirmInput) projectPasswordConfirmInput.value = '';
    if(projectPasswordWarning){
      projectPasswordWarning.textContent = '';
      projectPasswordWarning.classList.add('d-none');
    }
    if(projectPasswordRemoveBtn){
      const meta = getProjectMeta(name);
      projectPasswordRemoveBtn.disabled = !meta.locked;
    }
    if(!projectPasswordModalEl){
      showStatus('当前界面不支持项目加密设置', 'danger', 6000);
      return;
    }
    const modal = bootstrap.Modal.getOrCreateInstance(projectPasswordModalEl);
    modal.show();
  }

  async function lockCurrentProject(){
    const name = currentProject;
    if(!name){
      showStatus('请选择项目后再锁定', 'warning', 4000);
      return;
    }
    const meta = getProjectMeta(name);
    if(!meta.locked){
      showStatus('当前项目尚未设置密码，无需锁定', 'info', 4000);
      return;
    }
    const lockBtn = document.getElementById('project-action-lock');
    if(lockBtn) lockBtn.disabled = true;
    try{
      const res = await fetch(PROJECT_ENDPOINTS.lock || '/projects/lock', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({project: name}),
      });
      const parsed = await parseJsonSafe(res);
      if(res.ok && (!parsed.json || parsed.json.success !== false)){
        showStatus('项目已锁定，下次访问需密码解锁', 'info', 5000);
        await loadProjects();
      } else {
        const message = (parsed.json && parsed.json.error) ? parsed.json.error : (parsed.text || (`HTTP ${res.status}`));
        showStatus('锁定失败：' + message, 'danger', 6000);
      }
    }catch(e){
      showStatus('锁定失败：' + e.message, 'danger', 6000);
    } finally {
      if(lockBtn) lockBtn.disabled = false;
    }
  }

  if(projectCreateConfirmBtn){
    projectCreateConfirmBtn.addEventListener('click', async function(){
      if(!projectCreateNameInput){
        showStatus('请输入项目名称', 'warning', 4000);
        return;
      }
      const name = projectCreateNameInput.value.trim();
      if(!name){
        showStatus('项目名称不能为空', 'warning', 4000);
        return;
      }
      const original = this.textContent;
      this.disabled = true;
      this.textContent = '创建中...';
      try{
        const res = await fetch(PROJECT_ENDPOINTS.create || '/projects/create', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({name}),
        });
        const parsed = await parseJsonSafe(res);
        if(res.ok && (!parsed.json || parsed.json.success !== false)){
          const payload = parsed.json || {};
          currentProject = payload.project || name;
          updateProjectButtonLabel();
          if(projectCreateModalEl){
            const modal = bootstrap.Modal.getInstance(projectCreateModalEl);
            if(modal) modal.hide();
          }
          showStatus('项目创建成功', 'success', 4000);
          await loadProjects();
          await loadProject();
        } else {
          const message = (parsed.json && parsed.json.error) ? parsed.json.error : (parsed.text || (`HTTP ${res.status}`));
          showStatus('创建项目失败：' + message, 'danger', 6000);
        }
      }catch(e){
        showStatus('创建项目失败：' + e.message, 'danger', 6000);
      }
      this.disabled = false;
      this.textContent = original || '创建';
    });
  }

  if(projectRenameConfirmBtn){
    projectRenameConfirmBtn.addEventListener('click', async function(){
      if(!projectRenameTarget){
        showStatus('请选择要重命名的项目', 'warning', 4000);
        return;
      }
      const newName = projectRenameInput ? projectRenameInput.value.trim() : '';
      if(!newName){
        showStatus('新名称不能为空', 'warning', 4000);
        return;
      }
      const original = this.textContent;
      this.disabled = true;
      this.textContent = '保存中...';
      try{
        const res = await fetch(PROJECT_ENDPOINTS.rename || '/projects/rename', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({oldName: projectRenameTarget, newName}),
        });
        const parsed = await parseJsonSafe(res);
        if(res.ok && (!parsed.json || parsed.json.success !== false)){
          const payload = parsed.json || {};
          const finalName = payload.project || newName;
          const wasCurrent = currentProject === projectRenameTarget;
          if(wasCurrent){
            currentProject = finalName;
          }
          updateProjectButtonLabel();
          showStatus('项目已重命名', 'success', 4000);
          if(projectRenameModalEl){
            const modal = bootstrap.Modal.getInstance(projectRenameModalEl);
            if(modal) modal.hide();
          }
          projectRenameTarget = '';
          await loadProjects();
          if(wasCurrent){
            await loadProject();
          }
        } else {
          const message = (parsed.json && parsed.json.error) ? parsed.json.error : (parsed.text || (`HTTP ${res.status}`));
          showStatus('重命名失败：' + message, 'danger', 6000);
        }
      }catch(e){
        showStatus('重命名失败：' + e.message, 'danger', 6000);
      }
      this.disabled = false;
      this.textContent = original || '保存';
    });
  }

  if(projectDeleteConfirmBtn){
    projectDeleteConfirmBtn.addEventListener('click', async function(){
      if(!projectDeleteTarget){
        showStatus('请选择要删除的项目', 'warning', 4000);
        return;
      }
      const confirmation = projectDeleteConfirmInput ? projectDeleteConfirmInput.value.trim() : '';
      if(confirmation !== projectDeleteTarget){
        if(projectDeleteConfirmInput) projectDeleteConfirmInput.classList.add('is-invalid');
        showStatus('请输入准确的项目名称以确认删除', 'warning', 4000);
        return;
      }
      if(projectDeleteConfirmInput) projectDeleteConfirmInput.classList.remove('is-invalid');
      const original = this.textContent;
      this.disabled = true;
      this.textContent = '删除中...';
      try{
        const res = await fetch(PROJECT_ENDPOINTS.delete || '/projects/delete', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({name: projectDeleteTarget}),
        });
        const parsed = await parseJsonSafe(res);
        if(res.ok && (!parsed.json || parsed.json.success !== false)){
          const deleted = projectDeleteTarget;
          if(projectDeleteModalEl){
            const modal = bootstrap.Modal.getInstance(projectDeleteModalEl);
            if(modal) modal.hide();
          }
          showStatus('项目已删除', 'success', 4000);
          if(currentProject === deleted){
            currentProject = '';
            updateProjectButtonLabel();
          }
          projectDeleteTarget = '';
          await loadProjects();
          await loadProject();
        } else {
          const message = (parsed.json && parsed.json.error) ? parsed.json.error : (parsed.text || (`HTTP ${res.status}`));
          showStatus('删除项目失败：' + message, 'danger', 6000);
        }
      }catch(e){
        showStatus('删除项目失败：' + e.message, 'danger', 6000);
      }
      this.disabled = false;
      this.textContent = original || '删除';
    });
  }

  if(projectPasswordConfirmBtn){
    projectPasswordConfirmBtn.addEventListener('click', async function(){
      if(!projectPasswordTarget){
        showStatus('请选择项目后再设置密码', 'warning', 4000);
        return;
      }
      const newPassword = projectPasswordNewInput ? projectPasswordNewInput.value : '';
      const confirmPassword = projectPasswordConfirmInput ? projectPasswordConfirmInput.value : '';
      if(!newPassword){
        if(projectPasswordWarning){
          projectPasswordWarning.textContent = '新密码不能为空';
          projectPasswordWarning.classList.remove('d-none');
        }
        return;
      }
      if(newPassword !== confirmPassword){
        if(projectPasswordWarning){
          projectPasswordWarning.textContent = '两次输入的密码不一致';
          projectPasswordWarning.classList.remove('d-none');
        }
        return;
      }
      if(projectPasswordWarning){
        projectPasswordWarning.textContent = '';
        projectPasswordWarning.classList.add('d-none');
      }
      const original = this.textContent;
      this.disabled = true;
      this.textContent = '保存中...';
      try{
        const payload = {
          project: projectPasswordTarget,
          newPassword,
        };
        const currentPassword = projectPasswordCurrentInput ? projectPasswordCurrentInput.value : '';
        if(currentPassword) payload.currentPassword = currentPassword;
        const res = await fetch(PROJECT_ENDPOINTS.password || '/projects/password', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload),
        });
        const parsed = await parseJsonSafe(res);
        if(res.ok && (!parsed.json || parsed.json.success !== false)){
          if(projectPasswordModalEl){
            const modal = bootstrap.Modal.getInstance(projectPasswordModalEl);
            if(modal) modal.hide();
          }
          showStatus('项目密码已更新', 'success', 4000);
          updateProjectButtonLabel();
          await loadProjects();
          await loadProject();
        } else {
          const message = (parsed.json && parsed.json.error) ? parsed.json.error : (parsed.text || (`HTTP ${res.status}`));
          if(projectPasswordWarning){
            projectPasswordWarning.textContent = message;
            projectPasswordWarning.classList.remove('d-none');
          } else {
            showStatus('更新密码失败：' + message, 'danger', 6000);
          }
        }
      }catch(e){
        if(projectPasswordWarning){
          projectPasswordWarning.textContent = e.message;
          projectPasswordWarning.classList.remove('d-none');
        } else {
          showStatus('更新密码失败：' + e.message, 'danger', 6000);
        }
      }
      this.disabled = false;
      this.textContent = original || '保存';
    });
  }

  if(projectPasswordRemoveBtn){
    projectPasswordRemoveBtn.addEventListener('click', async function(){
      if(this.disabled) return;
      if(!projectPasswordTarget){
        showStatus('请选择项目后再移除密码', 'warning', 4000);
        return;
      }
      const payload = { project: projectPasswordTarget, remove: true };
      const currentPassword = projectPasswordCurrentInput ? projectPasswordCurrentInput.value : '';
      if(currentPassword) payload.currentPassword = currentPassword;
      this.disabled = true;
      try{
        const res = await fetch(PROJECT_ENDPOINTS.password || '/projects/password', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload),
        });
        const parsed = await parseJsonSafe(res);
        if(res.ok && (!parsed.json || parsed.json.success !== false)){
          if(projectPasswordModalEl){
            const modal = bootstrap.Modal.getInstance(projectPasswordModalEl);
            if(modal) modal.hide();
          }
          showStatus('项目密码已移除', 'success', 4000);
          updateProjectButtonLabel();
          await loadProjects();
          await loadProject();
        } else {
          const message = (parsed.json && parsed.json.error) ? parsed.json.error : (parsed.text || (`HTTP ${res.status}`));
          if(projectPasswordWarning){
            projectPasswordWarning.textContent = message;
            projectPasswordWarning.classList.remove('d-none');
          } else {
            showStatus('移除密码失败：' + message, 'danger', 6000);
          }
        }
      }catch(e){
        if(projectPasswordWarning){
          projectPasswordWarning.textContent = e.message;
          projectPasswordWarning.classList.remove('d-none');
        } else {
          showStatus('移除密码失败：' + e.message, 'danger', 6000);
        }
      }
      this.disabled = false;
    });
  }

  if(projectUnlockConfirmBtn){
    projectUnlockConfirmBtn.addEventListener('click', async function(){
      const name = projectUnlockTargetName || currentProject;
      const password = projectUnlockPasswordInput ? projectUnlockPasswordInput.value : '';
      if(!name){
        showStatus('请选择项目后再解锁', 'warning', 4000);
        return;
      }
      if(!password){
        if(projectUnlockErrorBox){
          projectUnlockErrorBox.textContent = '请输入密码';
          projectUnlockErrorBox.classList.remove('d-none');
        }
        return;
      }
      this.disabled = true;
      const original = this.textContent;
      this.textContent = '解锁中...';
      try{
        const res = await fetch(PROJECT_ENDPOINTS.unlock || '/projects/unlock', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({project: name, password}),
        });
        const parsed = await parseJsonSafe(res);
        if(res.ok && (!parsed.json || parsed.json.success !== false)){
          if(projectUnlockModalEl){
            const modal = bootstrap.Modal.getInstance(projectUnlockModalEl);
            if(modal) modal.hide();
          }
          showStatus('项目已解锁', 'success', 4000);
          projectUnlockTargetName = name;
          currentProject = name;
          updateProjectButtonLabel();
          await loadProjects();
          await loadProject();
        } else {
          const message = (parsed.json && parsed.json.error) ? parsed.json.error : (parsed.text || (`HTTP ${res.status}`));
          if(projectUnlockErrorBox){
            projectUnlockErrorBox.textContent = message || '解锁失败';
            projectUnlockErrorBox.classList.remove('d-none');
          } else {
            showStatus('解锁失败：' + message, 'danger', 6000);
          }
        }
      }catch(e){
        if(projectUnlockErrorBox){
          projectUnlockErrorBox.textContent = e.message;
          projectUnlockErrorBox.classList.remove('d-none');
        } else {
          showStatus('解锁失败：' + e.message, 'danger', 6000);
        }
      }
      this.disabled = false;
      this.textContent = original || '解锁';
    });
  }

// load projects then project data
loadProjects().then(()=>{
  loadProject();
});

  
  document.getElementById('ai-optimize').onclick = function() {
    const content = pagesData[currentPageIdx]?.content || '';
    const note = pagesData[currentPageIdx]?.notes || '';
    this.disabled = true;
    this.textContent = '优化中...';
    fetch('/ai_optimize', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({content: content, type: 'latex', note: note})
    }).then(res => res.json()).then(data => {
      if(data.success && data.result) {
        document.getElementById('ai-result').value = data.result;
        var modal = new bootstrap.Modal(document.getElementById('aiModal'));
        modal.show();
      } else {
        alert('AI优化失败：' + (data.error || '未知错误'));
      }
    }).catch(()=>alert('AI请求失败')).finally(()=>{
      this.disabled = false;
      this.textContent = '代码优化';
    });
  };
  document.getElementById('apply-ai-result').onclick = function() {
    const val = document.getElementById('ai-result').value;
    if(val) {
      pagesData[currentPageIdx].content = val;
      renderSingleEditor();
      saveProject();
      queueCompile();
    }
    var modal = bootstrap.Modal.getInstance(document.getElementById('aiModal'));
    modal.hide();
  };

  // AI script optimization (讲稿)
  const aiScriptBtn = document.getElementById('ai-script-optimize');
  if(aiScriptBtn) aiScriptBtn.addEventListener('click', function(){
    const content = pagesData[currentPageIdx]?.script || '';
    const page_tex = pagesData[currentPageIdx]?.content || '';
    this.disabled = true;
    this.textContent = '优化中...';
    fetch('/ai_optimize', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({content: content, type: 'script', page_tex: page_tex})
    }).then(res => res.json()).then(data => {
      if(data.success && data.result) {
        document.getElementById('ai-script-result').value = data.result;
        var modal = new bootstrap.Modal(document.getElementById('aiScriptModal'));
        modal.show();
      } else {
        alert('AI讲稿优化失败：' + (data.error || '未知错误'));
      }
    }).catch(()=>alert('AI请求失败')).finally(()=>{
      this.disabled = false;
      this.textContent = '优化讲稿';
    });
  });

  document.getElementById('apply-ai-script-result').onclick = function(){
    const val = document.getElementById('ai-script-result').value;
    if(val){
      pagesData[currentPageIdx].script = val;
      document.getElementById('page-script').value = val;
      saveProject();
      queueCompile();
    }
    var modal = bootstrap.Modal.getInstance(document.getElementById('aiScriptModal'));
    modal.hide();
  };
  
  document.getElementById('ai-note-optimize').onclick = function() {
    const note = pagesData[currentPageIdx]?.notes || '';
    const page_tex = pagesData[currentPageIdx]?.content || '';
    this.disabled = true;
    this.textContent = '优化中...';
    fetch('/ai_optimize', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({content: note, type: 'note', page_tex: page_tex})
  }).then(res => res.json()).then(data => {
      if(data.success && data.result) {
        document.getElementById('ai-note-result').value = data.result;
        var modal = new bootstrap.Modal(document.getElementById('aiNoteModal'));
        modal.show();
      } else {
        alert('AI优化失败：' + (data.error || '未知错误'));
      }
    }).catch(()=>alert('AI请求失败')).finally(()=>{
      this.disabled = false;
      this.textContent = '笔记优化';
    });
  };
  document.getElementById('apply-ai-note-result').onclick = function() {
    const val = document.getElementById('ai-note-result').value;
    if(val) {
      pagesData[currentPageIdx].notes = val;
      if(currentEditMode === 'markdown' && singleEditor) {
        singleEditor.setValue(val);
      }
      renderMarkdownPreview();
      saveProject();
      queueCompile();
    }
    var modal = bootstrap.Modal.getInstance(document.getElementById('aiNoteModal'));
    modal.hide();
  };
  
  document.getElementById('play-note').onclick = function() {
    const script = pagesData[currentPageIdx]?.script || '';
    if(!script.trim()) return alert('当前页讲稿为空');
    this.disabled = true;
    this.textContent = '生成中...';
    fetch('/tts', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({text: script})
    }).then(res=>res.json()).then(data=>{
      if(data.success && data.audio) {
        const audio = new Audio('data:audio/mp3;base64,' + data.audio);
        audio.play();
      } else {
        alert('TTS失败：'+(data.error||'未知错误'));
      }
    }).catch(()=>alert('TTS请求失败')).finally(()=>{
      this.disabled = false;
      this.textContent = '播放笔记';
    });
  };
  
  // legacy export-audio removed (use unified export modal)
  
  
  let bibData = [];
  document.getElementById('edit-bib').onclick = function() {
    fetch(PROJECT_ENDPOINTS.project || '/project').then(res=>res.json()).then(data=>{
      bibData = data.bib || [];
      renderBibList();
      var modal = new bootstrap.Modal(document.getElementById('bibModal'));
      modal.show();
    });
  };

  function renderBibList() {
    const list = document.getElementById('bib-list');
    list.innerHTML = '';

    (pagesData[currentPageIdx]?.bib || []).forEach((bib, idx) => {
      let doi = '';
      let url = '';
      const doiMatch = bib.match(/doi\s*=\s*[{"]([^}\"]+)/i);
      if(doiMatch) doi = doiMatch[1];
      const urlMatch = bib.match(/url\s*=\s*[{"]([^}\"]+)/i);
      if(urlMatch) url = urlMatch[1];
      let link = url || (doi ? ('https://doi.org/' + doi) : '');
      const item = document.createElement('div');
      item.className = 'list-group-item';
      item.innerHTML = `<pre style="white-space:pre-wrap;word-break:break-all;">[本页] ${bib}</pre>`;
      if(link) {
        item.style.cursor = 'pointer';
        item.title = '点击跳转到文献';
        item.onclick = ()=>window.open(link, '_blank');
      }
      list.appendChild(item);
    });

    bibData.forEach((bib, idx) => {
      let doi = '';
      let url = '';
      const doiMatch = bib.match(/doi\s*=\s*[{"]([^}\"]+)/i);
      if(doiMatch) doi = doiMatch[1];
      const urlMatch = bib.match(/url\s*=\s*[{"]([^}\"]+)/i);
      if(urlMatch) url = urlMatch[1];
      let link = url || (doi ? ('https://doi.org/' + doi) : '');
      const item = document.createElement('div');
      item.className = 'list-group-item';
      item.innerHTML = `<pre style="white-space:pre-wrap;word-break:break-all;">[全局] ${bib}</pre>`;
      if(link) {
        item.style.cursor = 'pointer';
        item.title = '点击跳转到文献';
        item.onclick = ()=>window.open(link, '_blank');
      }
      list.appendChild(item);
    });
  }

  document.getElementById('add-bib-btn').onclick = function() {
    const val = document.getElementById('bib-input').value.trim();
    if(!val) return;
    this.disabled = true;
    this.textContent = '生成中...';
    const scope = document.getElementById('bib-scope').value;
    fetch('/ai_bib', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ref: val})
    }).then(res=>res.json()).then(data=>{
      if(data.success && data.bib) {
        if(scope === 'page') {
          pagesData[currentPageIdx].bib = pagesData[currentPageIdx].bib || [];
          pagesData[currentPageIdx].bib.push(data.bib);
          saveProject();
        } else {
          bibData.push(data.bib);
      fetch(PROJECT_ENDPOINTS.projectSave || '/project', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({bib: bibData})
      });
        }
        renderBibList();
        document.getElementById('bib-input').value = '';
      } else {
        alert('AI生成失败：'+(data.error||'未知错误'));
      }
    }).catch(()=>alert('AI请求失败')).finally(()=>{
      this.disabled = false;
      this.textContent = 'AI生成并添加';
    });
  };

  document.getElementById('add-url-bib-btn').onclick = function() {
    let val = document.getElementById('bib-input').value.trim();
    if(!val) return;
    const scope = document.getElementById('bib-scope').value;
    let cleanVal = val;
    try {
      const parsed = new URL(cleanVal);
      parsed.search = '';
      parsed.hash = '';
      cleanVal = parsed.toString();
    } catch(e) {
      const noQuery = cleanVal.split('?')[0];
      cleanVal = noQuery.split('#')[0];
    }
    const bib = `@misc{url${Date.now()},\n  url={${cleanVal}}\n}`;
    if(scope === 'page') {
      pagesData[currentPageIdx].bib = pagesData[currentPageIdx].bib || [];
      pagesData[currentPageIdx].bib.push(bib);
      saveProject();
    } else {
      bibData.push(bib);
      fetch(PROJECT_ENDPOINTS.projectSave || '/project', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({bib: bibData})
      });
    }
    renderBibList();
    document.getElementById('bib-input').value = '';
  };

  // Resource upload & listing
  function getCurrentPageIndex() {
    return currentPageIdx; // zero-based
  }

  async function parseJsonSafe(input) {
    if (input instanceof Response) {
      try {
        const json = await input.clone().json();
        return { json };
      } catch (e) {
        try {
          const text = await input.clone().text();
          return { text };
        } catch (_) {
          return { text: '' };
        }
      }
    }
    if (typeof input === 'string') {
      try {
        return { json: JSON.parse(input) };
      } catch (e) {
        return { text: input };
      }
    }
    return { text: String(input || '') };
  }

  function urlToLatexPath(url){
    if(!url) return '';
    const withoutQuery = url.split('?')[0];
    const normalized = withoutQuery.replace(/\\/g, '/');
    const parts = normalized.split('/').filter(Boolean);
    return parts.length ? parts[parts.length - 1] : normalized;
  }

  async function refreshResourceLists() {
    // If resources modal is open, refresh its content. Otherwise no-op.
    const modalEl = document.getElementById('resourcesModal');
    if(modalEl && bootstrap.Modal.getInstance(modalEl)){
      await loadResourcesModal();
    }
  }

  // Manage Resources Modal handlers
  document.getElementById('manage-resources').addEventListener('click', async function(){
    await loadResourcesModal();
    var modal = new bootstrap.Modal(document.getElementById('resourcesModal'));
    modal.show();
  });

  async function loadResourcesModal(){
    const scope = document.getElementById('resources-scope').value;
    const modalList = document.getElementById('resources-list-modal');
    modalList.innerHTML = '<div class="text-muted p-2">加载中...</div>';
    // show current page
    const cp = getCurrentPageIndex()+1;
    const cpEl = document.getElementById('resources-current-page');
    if(cpEl) cpEl.textContent = cp;
    try{
      const pageIdx = getCurrentPageIndex();
      let url = '/resources/list';
      if(scope === 'page') url += `?page=${pageIdx}`;
      const res = await fetch(url);
      const data = res.ok ? await res.json() : {files: []};
      if(data.ossError){
        console.warn('资源 OSS 状态:', data.ossError);
      }
      // resources list
      const resList = document.getElementById('resources-list-modal');
      const files = Array.isArray(data.files) ? data.files : [];
      const names = files.map(f => f && f.name).filter(Boolean);
      if(scope === 'page' && pagesData[pageIdx]) {
        pagesData[pageIdx].resources = names.slice();
      }
      if(scope !== 'page') {
        globalResources = names.slice();
      }
      resList.innerHTML = '';
      files.forEach(f => {
        const item = document.createElement('div');
        item.className = 'list-group-item d-flex justify-content-between align-items-center';
        const left = document.createElement('div');
        const name = document.createElement('a');
        const localUrl = f.localUrl || '';
        const ossUrl = f.ossUrl || '';
        const preferredUrl = f.url || localUrl || ossUrl || '';
        const hasLocal = !!localUrl && f.exists !== false ? true : !!localUrl;
        const hasRemote = !!ossUrl;
        name.href = preferredUrl || '#';
        name.textContent = f.name;
        if(preferredUrl){
          name.target = '_blank';
        } else {
          name.classList.add('disabled');
        }
        if(!hasLocal){
          name.classList.add('text-muted');
          name.title = hasRemote ? '本地缺失，仅 OSS 可用' : '文件缺失';
        }
        left.appendChild(name);
        if(!hasLocal){
          const badge = document.createElement('span');
          badge.className = 'badge bg-warning text-dark ms-2';
          badge.textContent = '缺失';
          left.appendChild(badge);
        }
        if(hasRemote && !hasLocal){
          const ossBadge = document.createElement('span');
          ossBadge.className = 'badge bg-info text-dark ms-2';
          ossBadge.textContent = 'OSS';
          left.appendChild(ossBadge);
        }
        const actions = document.createElement('div');
        const openBtn = document.createElement('button');
        openBtn.className = 'btn btn-sm btn-outline-secondary me-2';
        openBtn.textContent = '打开';
        openBtn.onclick = function(){
          if(preferredUrl){
            window.open(preferredUrl, '_blank');
          } else {
            alert('当前资源没有可用的链接');
          }
        };
        if(!preferredUrl){
          openBtn.disabled = true;
        }
        const copyBtn = document.createElement('button');
        copyBtn.className = 'btn btn-sm btn-outline-primary me-2';
        copyBtn.textContent = '复制链接';
        copyBtn.onclick = function(){
          if(!preferredUrl){ alert('当前资源没有可用的链接'); return; }
          navigator.clipboard.writeText(preferredUrl).then(()=>{
            copyBtn.textContent = '已复制';
            setTimeout(()=>{ copyBtn.textContent = '复制链接'; }, 2000);
          }).catch(()=>alert('复制失败，请手动复制链接'));
        };
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn btn-sm btn-outline-danger';
        deleteBtn.textContent = '删除';
        deleteBtn.onclick = async function(){
          if(!confirm('确认删除此资源吗？')) return;
          try{
            const res = await fetch('/resources/delete', {method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({name: f.name})});
            const parsed = await parseJsonSafe(res);
            if(res.ok){
              if(parsed.json && parsed.json.success === false){
                alert('删除失败：' + (parsed.json.error || (parsed.text ? parsed.text : '未知错误')));
              } else {
                globalResources = globalResources.filter(name => name !== f.name);
                pagesData.forEach(p => {
                  if(Array.isArray(p.resources)) {
                    p.resources = p.resources.filter(name => name !== f.name);
                  }
                });
                await loadResourcesModal();
                await refreshResourceLists();
                queueCompile();
              }
            } else {
              const message = parsed.json && parsed.json.error ? parsed.json.error : (parsed.text || ('HTTP ' + res.status));
              alert('删除失败：' + message);
            }
          }catch(e){ console.error(e); alert('删除失败：' + e.message); }
        };
      actions.appendChild(openBtn);
      actions.appendChild(copyBtn);
      actions.appendChild(deleteBtn);
        item.appendChild(left);
        item.appendChild(actions);
        resList.appendChild(item);
      });
      if((data.files||[]).length === 0) resList.innerHTML = '<div class="text-muted p-2">没有资源</div>';

    }catch(e){ modalList.innerHTML = '<div class="text-danger p-2">加载失败</div>'; }
  }

  const refreshResourcesBtn = document.getElementById('refresh-resources');
  if(refreshResourcesBtn) refreshResourcesBtn.addEventListener('click', loadResourcesModal);
  const resourcesScopeEl = document.getElementById('resources-scope');
  if(resourcesScopeEl) resourcesScopeEl.addEventListener('change', loadResourcesModal);

  // modal upload handlers
  const modalUploadBtn = document.getElementById('modal-resource-upload-btn');
  if(modalUploadBtn) modalUploadBtn.addEventListener('click', async function(){
    const input = document.getElementById('modal-resource-upload-input');
    if(!input.files || input.files.length === 0) return alert('请选择文件');
    const file = input.files[0];
    const fd = new FormData();
    fd.append('file', file);
    fd.append('page', getCurrentPageIndex());
    this.disabled = true;
    this.textContent = '上传中...';
    try{
      const res = await fetch('/upload_resource', {method: 'POST', body: fd});
      const parsed = await parseJsonSafe(res);
      if(res.ok){
        if(parsed.json && parsed.json.success === false){
          alert('上传失败：' + (parsed.json.error || parsed.text || '未知错误'));
        } else {
          input.value = '';
          const payload = parsed.json || {};
          if(payload.scope === 'page' && typeof payload.page === 'number' && payload.name){
            const idx = payload.page;
            if(pagesData[idx]){
              const list = Array.isArray(pagesData[idx].resources) ? pagesData[idx].resources : (pagesData[idx].resources = []);
              if(!list.includes(payload.name)) list.push(payload.name);
            }
          }
          await loadResourcesModal();
          await refreshResourceLists();
          queueCompile();
        }
      } else {
        alert('上传失败：' + (parsed.json && parsed.json.error ? parsed.json.error : parsed.text || ('HTTP ' + res.status)));
      }
    }catch(e){ console.error(e); alert('上传失败：' + e.message); }
    this.disabled = false;
    this.textContent = '上传到本页';
  });

  const modalUploadGlobalBtn = document.getElementById('modal-resource-upload-global-btn');
  if(modalUploadGlobalBtn) modalUploadGlobalBtn.addEventListener('click', async function(){
    const input = document.getElementById('modal-resource-upload-input');
    if(!input.files || input.files.length === 0) return alert('请选择文件');
    const file = input.files[0];
    const fd = new FormData();
    fd.append('file', file);
    this.disabled = true;
    this.textContent = '上传中...';
    try{
      const res = await fetch('/upload_resource', {method: 'POST', body: fd});
      const parsed = await parseJsonSafe(res);
      if(res.ok){
        if(parsed.json && parsed.json.success === false){
          alert('上传失败：' + (parsed.json.error || parsed.text || '未知错误'));
        } else {
          input.value = '';
          const payload = parsed.json || {};
          if(payload.scope === 'global' && payload.name){
            if(!globalResources.includes(payload.name)) globalResources.push(payload.name);
          } else if(payload.scope === 'page' && typeof payload.page === 'number' && payload.name){
            const idx = payload.page;
            if(pagesData[idx]){
              const list = Array.isArray(pagesData[idx].resources) ? pagesData[idx].resources : (pagesData[idx].resources = []);
              if(!list.includes(payload.name)) list.push(payload.name);
            }
          }
          await loadResourcesModal();
          await refreshResourceLists();
          queueCompile();
        }
      } else {
        const message = parsed.json && parsed.json.error ? parsed.json.error : (parsed.text || ('HTTP ' + res.status));
        alert('上传失败：' + message);
      }
    }catch(e){ console.error(e); alert('上传失败：' + e.message); }
    this.disabled = false;
    this.textContent = '上传为全局';
  });

  async function loadAttachmentsModal(){
    const listEl = document.getElementById('attachments-list-modal');
    if(!listEl) return;
    listEl.innerHTML = '<div class="text-muted p-2">加载中...</div>';
    try{
      const res = await fetch('/attachments/list');
      const data = res.ok ? await res.json() : {files: []};
      listEl.innerHTML = '';

      (data.files || []).forEach(f => {
        const preferredUrl = f.preferredUrl || f.localUrl || f.ossUrl || '';
        const item = document.createElement('div');
        item.className = 'list-group-item';
        const wrapper = document.createElement('div');
        wrapper.className = 'd-flex flex-column flex-md-row justify-content-between align-items-start gap-2';
        const left = document.createElement('div');
        left.className = 'me-md-3 flex-grow-1';
        const name = document.createElement('a');
        name.textContent = f.name;
        if(preferredUrl){
          name.href = preferredUrl;
          name.target = '_blank';
        } else {
          name.href = '#';
          name.classList.add('disabled');
        }
        left.appendChild(name);

        if(f.location){
          const badge = document.createElement('span');
          badge.className = 'badge rounded-pill ms-2';
          if(f.location === 'synced'){
            badge.classList.add('bg-success');
            badge.textContent = '已同步';
          } else if(f.location === 'local'){
            badge.classList.add('bg-secondary');
            badge.textContent = '仅本地';
          } else if(f.location === 'oss'){
            badge.classList.add('bg-info');
            badge.textContent = '仅 OSS';
          } else {
            badge.classList.add('bg-warning');
            badge.textContent = '未知';
          }
          left.appendChild(badge);
        }

        if(f.ossUrl && f.localUrl && f.ossUrl !== f.localUrl){
          const remoteLink = document.createElement('div');
          remoteLink.className = 'small text-muted';
          remoteLink.innerHTML = `远程：<a href="${f.ossUrl}" target="_blank">${f.ossUrl}</a>`;
          left.appendChild(remoteLink);
        }

        const actions = document.createElement('div');
        actions.className = 'd-flex flex-wrap gap-1';

        const insertBtn = document.createElement('button');
        insertBtn.type = 'button';
        insertBtn.className = 'btn btn-sm btn-primary';
        insertBtn.textContent = '插入';
        insertBtn.onclick = function(){
          if(!singleEditor) return;
          const formatSelect = document.getElementById('attachment-insert-format');
          const choice = formatSelect ? formatSelect.value : 'auto';
          let mode = choice === 'auto' ? (typeof currentEditMode === 'string' ? currentEditMode : 'latex') : choice;
          if(mode !== 'markdown' && mode !== 'latex') mode = 'latex';
          const isImage = /\.(png|jpe?g|gif|svg|webp|bmp|heic|heif)$/i.test(f.name || '');
          const doc = singleEditor.getDoc();
          const cursor = doc.getCursor();
          let snippet = '';
          if(mode === 'latex'){
            if(isImage){
              if(!f.localUrl){
                alert('该图片仅存在于 OSS，请先同步到本地再在 LaTeX 中引用。');
                return;
              }
              const path = urlToLatexPath(f.localUrl);
              snippet = `\\begin{center}\n  \\includegraphics[width=0.7\\textwidth]{${path}}\n\\end{center}\n`;
            } else {
              if(!preferredUrl){
                alert('当前附件没有可用的访问链接');
                return;
              }
              snippet = `\\textbf{附件:} \\href{${preferredUrl}}{${f.name}}\n`;
            }
          } else {
            if(!preferredUrl){
              alert('当前附件没有可用的访问链接');
              return;
            }
            snippet = isImage ? `![${f.name}](${preferredUrl})\n` : `[${f.name}](${preferredUrl})\n`;
          }
          doc.replaceRange(snippet, cursor);
        };

        const previewBtn = document.createElement('button');
        previewBtn.type = 'button';
        previewBtn.className = 'btn btn-sm btn-outline-secondary';
        previewBtn.textContent = '预览';
        previewBtn.onclick = function(){
          const isImage = /\.(png|jpe?g|gif|svg|webp|bmp|heic|heif)$/i.test(f.name || '');
          const targetUrl = f.localUrl || f.ossUrl || preferredUrl;
          if(isImage && attachmentPreviewModalEl && attachmentPreviewImage){
            if(!targetUrl){
              alert('当前附件没有可用的访问链接');
              return;
            }
            attachmentPreviewImage.src = targetUrl;
            if(attachmentPreviewMeta){
              const parts = [];
              parts.push(f.location === 'oss' ? '来源：OSS' : '来源：本地');
              if(f.ossUrl && f.localUrl && f.ossUrl !== f.localUrl){
                parts.push('已同步');
              }
              attachmentPreviewMeta.textContent = `${f.name}${parts.length ? '（' + parts.join('，') + '）' : ''}`;
            }
            if(attachmentPreviewOpen){
              attachmentPreviewOpen.href = targetUrl || '#';
              attachmentPreviewOpen.classList.toggle('disabled', !targetUrl);
            }
            const modal = bootstrap.Modal.getOrCreateInstance(attachmentPreviewModalEl);
            modal.show();
          } else {
            if(targetUrl){
              window.open(targetUrl, '_blank');
            } else {
              alert('当前附件没有可用的访问链接');
            }
          }
        };

        const openBtn = document.createElement('button');
        openBtn.type = 'button';
        openBtn.className = 'btn btn-sm btn-outline-secondary';
        openBtn.textContent = '打开';
        openBtn.onclick = function(){
          if(preferredUrl){
            window.open(preferredUrl, '_blank');
          } else {
            alert('当前附件没有可用的访问链接');
          }
        };

        const copyNameBtn = document.createElement('button');
        copyNameBtn.type = 'button';
        copyNameBtn.className = 'btn btn-sm btn-outline-primary';
        copyNameBtn.textContent = '复制名称';
        copyNameBtn.onclick = function(){
          navigator.clipboard.writeText(f.name || '').then(()=>{
            copyNameBtn.textContent = '已复制';
            setTimeout(()=>{ copyNameBtn.textContent = '复制名称'; }, 2000);
          }).catch(()=>alert('复制失败，请手动复制'));
        };

        const copyLinkBtn = document.createElement('button');
        copyLinkBtn.type = 'button';
        copyLinkBtn.className = 'btn btn-sm btn-outline-primary';
        copyLinkBtn.textContent = '复制链接';
        copyLinkBtn.onclick = function(){
          if(!preferredUrl){
            alert('当前附件没有可用的链接');
            return;
          }
          navigator.clipboard.writeText(preferredUrl).then(()=>{
            copyLinkBtn.textContent = '已复制';
            setTimeout(()=>{ copyLinkBtn.textContent = '复制链接'; }, 2000);
          }).catch(()=>alert('复制失败，请手动复制链接'));
        };

        const renameBtn = document.createElement('button');
        renameBtn.type = 'button';
        renameBtn.className = 'btn btn-sm btn-outline-secondary';
        renameBtn.textContent = '重命名';
        renameBtn.onclick = function(){
          if(!attachmentRenameModalEl || !attachmentRenameInput){
            alert('当前界面不支持重命名');
            return;
          }
          attachmentRenameTarget = f.name;
          attachmentRenameInput.value = f.name;
          const modal = bootstrap.Modal.getOrCreateInstance(attachmentRenameModalEl);
          modal.show();
        };

        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.className = 'btn btn-sm btn-outline-danger';
        deleteBtn.textContent = '删除';
        deleteBtn.onclick = async function(){
          if(!confirm('确认删除此附件吗？')) return;
          try{
            const res = await fetch('/attachments/delete', {method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({path: f.path})});
            const parsed = await parseJsonSafe(res);
            if(res.ok && (!parsed.json || parsed.json.success !== false)){
              await loadAttachmentsModal();
            } else {
              const message = (parsed.json && parsed.json.error) ? parsed.json.error : (parsed.text || ('HTTP ' + res.status));
              alert('删除失败：' + message);
            }
          }catch(e){ console.error(e); alert('删除失败：' + e.message); }
        };

        actions.appendChild(insertBtn);
        actions.appendChild(previewBtn);
        actions.appendChild(openBtn);
        actions.appendChild(copyNameBtn);
        actions.appendChild(copyLinkBtn);
        actions.appendChild(renameBtn);
        actions.appendChild(deleteBtn);

        wrapper.appendChild(left);
        wrapper.appendChild(actions);
        item.appendChild(wrapper);
        listEl.appendChild(item);
      });

      if((data.files || []).length === 0){
        listEl.innerHTML = '<div class="text-muted p-2">没有附件</div>';
      }
    }catch(e){
      console.warn('加载附件失败', e);
      listEl.innerHTML = '<div class="text-danger p-2">加载失败</div>';
    }
  }

  const manageAttachmentsBtn = document.getElementById('manage-attachments');
  if(manageAttachmentsBtn) manageAttachmentsBtn.addEventListener('click', async function(){
    await loadAttachmentsModal();
    var modal = new bootstrap.Modal(document.getElementById('attachmentsModal'));
    modal.show();
  });

  const manageSyncBtn = document.getElementById('manage-sync');
  if(manageSyncBtn && ossSyncModalEl){
    manageSyncBtn.addEventListener('click', async function(){
      await refreshOssSyncModal();
      const modal = bootstrap.Modal.getOrCreateInstance(ossSyncModalEl);
      modal.show();
    });
  }

  if(ossSyncToggleMain && !ossSyncToggleMain.dataset.bound){
    ossSyncToggleMain.dataset.bound = 'true';
    ossSyncToggleMain.addEventListener('change', async function(){
      if(this.dataset.configured !== 'true'){
        this.checked = false;
        alert('当前未配置 OSS，同步不可用');
        return;
      }
      const desired = this.checked;
      this.disabled = true;
      const prevLabel = this.nextElementSibling ? this.nextElementSibling.textContent : '';
      if(this.nextElementSibling) this.nextElementSibling.textContent = desired ? '开启中...' : '关闭中...';
      try{
        const res = await fetch('/attachments/sync', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({enabled: desired})
        });
        const parsed = await parseJsonSafe(res);
        if(!(res.ok && (!parsed.json || parsed.json.success !== false))){
          const message = (parsed.json && parsed.json.error) ? parsed.json.error : (parsed.text || (`HTTP ${res.status}`));
          alert('同步开关更新失败：' + message);
          this.checked = !desired;
        } else {
          await refreshOssSyncModal();
          await loadAttachmentsModal();
          await loadResourcesModal();
        }
      }catch(e){
        alert('同步开关更新失败：' + e.message);
        this.checked = !desired;
      }
      if(this.nextElementSibling) this.nextElementSibling.textContent = prevLabel || '启用 OSS 同步';
      this.disabled = false;
    });
  }

  if(ossSyncRunBtn && !ossSyncRunBtn.dataset.bound){
    ossSyncRunBtn.dataset.bound = 'true';
    ossSyncRunBtn.addEventListener('click', async function(){
      this.disabled = true;
      const original = this.textContent;
      this.textContent = '同步中...';
      if(ossSyncStatusBox) ossSyncStatusBox.textContent = '正在与 OSS 同步...';
      try{
        const res = await fetch('/oss/sync_now', {method: 'POST'});
        const parsed = await parseJsonSafe(res);
        if(res.ok && (!parsed.json || parsed.json.success !== false)){
          const payload = parsed.json || {};
          const summary = payload.synced || {};
          const messageLines = [];
          messageLines.push(`附件：${renderSyncEntry(summary.attachments)}`);
          messageLines.push(`资源：${renderSyncEntry(summary.resources)}`);
          messageLines.push(`项目 YAML：${renderSyncEntry(summary.yaml)}`);
          await loadAttachmentsModal();
          await loadResourcesModal();
          await refreshOssSyncModal();
          if(ossSyncStatusBox) ossSyncStatusBox.innerHTML = messageLines.join('<br>');
        } else {
          const message = (parsed.json && parsed.json.error) ? parsed.json.error : (parsed.text || (`HTTP ${res.status}`));
          if(ossSyncStatusBox) ossSyncStatusBox.textContent = '同步失败：' + message;
          alert('同步失败：' + message);
        }
      }catch(e){
        if(ossSyncStatusBox) ossSyncStatusBox.textContent = '同步失败：' + e.message;
        alert('同步失败：' + e.message);
      }
      this.textContent = original || '立即同步';
      this.disabled = false;
    });
  }

  const attachmentUploadBtn = document.getElementById('modal-attachment-upload-btn');
  if(attachmentUploadBtn) attachmentUploadBtn.addEventListener('click', async function(){
    const input = document.getElementById('modal-attachment-upload-input');
    if(!input.files || input.files.length === 0) return alert('请选择文件');
    const file = input.files[0];
    const fd = new FormData();
    fd.append('file', file);
    this.disabled = true;
    this.textContent = '上传中...';
    try{
      const res = await fetch('/attachments/upload', {method: 'POST', body: fd});
      const text = await res.text();
      const parsed = await parseJsonSafe(text);
      if(res.ok){
        const payload = parsed.json || {};
        if(payload.success === false){
          alert('上传失败：' + (payload.error || parsed.text || '未知错误'));
        } else {
          input.value = '';
          await loadAttachmentsModal();
        }
      } else {
        const message = (parsed.json && parsed.json.error) ? parsed.json.error : (parsed.text || ('HTTP ' + res.status));
        alert('上传失败：' + message);
      }
    }catch(e){ console.error(e); alert('上传失败：' + e.message); }
    this.disabled = false;
    this.textContent = '上传附件';
  });

  if(attachmentRenameConfirm && !attachmentRenameConfirm.dataset.bound){
    attachmentRenameConfirm.dataset.bound = 'true';
    attachmentRenameConfirm.addEventListener('click', async function(){
      if(!attachmentRenameTarget){
        alert('请先选择要重命名的附件');
        return;
      }
      if(!attachmentRenameInput){
        alert('无法读取新文件名');
        return;
      }
      const newName = attachmentRenameInput.value.trim();
      if(!newName){
        alert('文件名不能为空');
        return;
      }
      const originalText = this.textContent;
      this.disabled = true;
      this.textContent = '保存中...';
      try{
        const res = await fetch('/attachments/rename', {method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({oldName: attachmentRenameTarget, newName})});
        const parsed = await parseJsonSafe(res);
        if(res.ok && (!parsed.json || parsed.json.success !== false)){
          if(parsed.json){
            const payload = parsed.json;
            if(payload.name && payload.name !== newName){
              alert(`文件名已更新为：${payload.name}`);
            }
            const status = payload.ossStatus;
            if(status && (status.error || status.delete_error)){
              const msg = status.error || status.delete_error;
              alert('OSS 同步出现问题：' + msg);
            }
          }
          const modal = attachmentRenameModalEl ? bootstrap.Modal.getInstance(attachmentRenameModalEl) : null;
          if(modal) modal.hide();
          attachmentRenameTarget = null;
          await loadAttachmentsModal();
        } else {
          const message = (parsed.json && parsed.json.error) ? parsed.json.error : (parsed.text || ('HTTP ' + res.status));
          alert('重命名失败：' + message);
        }
      }catch(e){
        alert('重命名失败：' + e.message);
      }
      this.disabled = false;
      this.textContent = originalText || '保存';
    });
  }

  // Side-panel upload handlers removed — resource management is modal-only

  // ensure modal content refreshes when page changes
  const origRenderSingleEditor = renderSingleEditor;
  renderSingleEditor = function(){ origRenderSingleEditor(); if(document.getElementById('resourcesModal') && bootstrap.Modal.getInstance(document.getElementById('resourcesModal'))) loadResourcesModal(); };

</script>
</body>
</html>
