<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Benort</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
  <script>
    window.BENORT_COMPONENT_LIBRARY = {{ (component_library or {})|tojson }};
    window.BENORT_UI_THEME = {{ (ui_theme or {})|tojson }};
  </script>
  <style>
    #editor-preview-wrapper {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    @media (min-width: 992px) {
      #editor-preview-wrapper {
        flex-direction: row;
      }
    }
    .editor-pane,
    .preview-pane {
      flex: 1 1 0;
      min-height: 70vh;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }
    #editor-container,
    #pdf-container,
    #markdown-preview {
      height: 70vh;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: #fff;
      overflow: auto;
    }
    body.theme-dark {
      background: #0f172a;
      color: #e2e8f0;
    }
    body.theme-dark .navbar {
      background: linear-gradient(120deg, rgba(15, 23, 42, 0.95) 0%, rgba(17, 34, 64, 0.96) 55%, rgba(11, 25, 60, 0.98) 100%);
      border-bottom: 1px solid rgba(96, 165, 250, 0.25);
      box-shadow: 0 10px 28px rgba(8, 47, 73, 0.35);
    }
    body.theme-dark .navbar .btn {
      color: inherit;
      background: transparent;
    }
    body.theme-dark #editor-container,
    body.theme-dark #pdf-container,
    body.theme-dark #markdown-preview {
      background: #1a2333;
      border-color: #253047;
      color: #e2e8f0;
    }
    body.theme-dark .modal-content {
      background: #111827;
      color: #e2e8f0;
      border: 1px solid #1f2937;
    }
    body.theme-dark .form-control,
    body.theme-dark .form-select,
    body.theme-dark .input-group-text {
      background-color: #1f2937;
      border-color: #334155;
      color: #e2e8f0;
    }
    body.theme-dark .list-group-item {
      background-color: #111827;
      color: #e2e8f0;
      border-color: #1f2937;
    }
    body.theme-dark .list-group-item-action:hover,
    body.theme-dark .list-group-item-action:focus {
      background-color: #1f2937;
    }
    .resource-list .resource-item {
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start;
      justify-content: space-between;
      gap: 0.75rem;
    }
    .resource-list .resource-name {
      flex: 1 1 240px;
      min-width: 0;
      word-break: break-word;
      overflow-wrap: anywhere;
    }
    .resource-list .resource-name a {
      word-break: inherit;
      overflow-wrap: inherit;
    }
    .resource-list .resource-actions {
      flex: 0 0 auto;
      margin-left: auto;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .resource-list .resource-actions .btn {
      margin-right: 0;
    }
    #resource-rename-preview {
      word-break: break-word;
      overflow-wrap: anywhere;
    }
    .js-nav-btn {
      min-height: 34px;
      padding: 6px 14px;
      border-radius: 999px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      line-height: 1.25;
      transition: transform 0.15s ease, background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
    }
    .mobile-page-control-group {
      gap: 0.5rem;
    }
    .mobile-page-control-group .mobile-page-btn {
      margin-right: 0;
    }
    .js-nav-btn:hover {
      transform: translateY(-1px);
    }
    .js-nav-btn:active {
      transform: translateY(0);
    }
    body.theme-dark .dropdown-menu {
      background: #101b33;
      border: 1px solid rgba(148, 163, 184, 0.18);
      box-shadow: 0 12px 26px rgba(8, 47, 73, 0.4);
    }
    body.theme-dark .dropdown-item,
    body.theme-dark .dropdown-item-text {
      color: #cbd5f5;
    }
    body.theme-dark .dropdown-item:hover,
    body.theme-dark .dropdown-item:focus,
    body.theme-dark .dropdown-item.active {
      background: rgba(59, 130, 246, 0.15);
      color: #e0e7ff;
    }
    .btn-theme {
      --btn-bg: #2563eb;
      --btn-hover: #1d4ed8;
      --btn-text: #ffffff;
      --btn-border: #2563eb;
      --btn-outline-hover: rgba(15, 23, 42, 0.06);
      border-width: 1px;
    }
    .btn-theme[data-theme-variant="solid"] {
      background: var(--btn-bg);
      color: var(--btn-text);
      border-color: transparent;
    }
    .btn-theme[data-theme-variant="solid"]:hover,
    .btn-theme[data-theme-variant="solid"]:focus {
      background: var(--btn-hover);
      color: var(--btn-text);
    }
    .btn-theme[data-theme-variant="outline"] {
      background: transparent;
      color: var(--btn-text);
      border-color: var(--btn-border);
    }
    .btn-theme[data-theme-variant="outline"]:hover,
    .btn-theme[data-theme-variant="outline"]:focus {
      background: var(--btn-outline-hover);
      color: var(--btn-border);
    }
    .btn-theme:hover {
      transform: translateY(-1px);
    }
    .btn-theme:active {
      transform: translateY(0);
    }
    body.theme-dark .btn-theme {
      box-shadow: none;
    }
    body.theme-dark .btn-theme[data-theme-variant="outline"] {
      border-color: var(--btn-border);
      color: var(--btn-border);
    }
    body.theme-dark .btn-theme[data-theme-variant="outline"]:hover,
    body.theme-dark .btn-theme[data-theme-variant="outline"]:focus {
      background: var(--btn-outline-hover);
    }
    body.theme-dark .btn-theme[data-theme-variant="solid"] {
      box-shadow: 0 0 0 1px rgba(148, 163, 184, 0.16);
    }
    .btn-theme:focus-visible {
      outline: 2px solid rgba(59,130,246,0.65);
      outline-offset: 1px;
    }
    body.theme-dark .btn-theme:focus-visible {
      outline-color: rgba(148, 163, 184, 0.65);
    }
    .btn-theme .badge {
      font-weight: 500;
    }
    body.theme-dark .CodeMirror {
      background: #0b1120;
      color: #e2e8f0;
    }
    body.theme-dark .CodeMirror-gutters {
      background: #0b1120;
      border-right: 1px solid #1f2937;
      color: #64748b;
    }
    body.theme-dark .CodeMirror-linenumber {
      color: #475569;
    }
    body.theme-dark .CodeMirror-cursor {
      border-left: 2px solid #f8fafc;
    }
    body.theme-dark .CodeMirror-selected {
      background: rgba(59, 130, 246, 0.25) !important;
    }
    body.theme-dark .markdown-preview-content {
      color: #e2e8f0;
    }
    body.theme-dark .markdown-preview-content a {
      color: #93c5fd;
    }
    body.theme-dark .markdown-preview-content img {
      box-shadow: 0 24px 60px rgba(8, 47, 73, 0.55);
    }
    body.theme-dark .markdown-preview-content figcaption {
      color: #94a3b8;
    }
    body.theme-dark .markdown-preview-table-wrapper {
      border-color: #1f2a44;
      background: rgba(15, 23, 42, 0.62);
      box-shadow: 0 24px 52px rgba(7, 26, 60, 0.48);
    }
    body.theme-dark .markdown-preview-table-wrapper table {
      color: #e2e8f0;
      background: rgba(17, 26, 46, 0.88);
    }
    body.theme-dark .markdown-preview-table-wrapper caption {
      color: #e2e8f0;
    }
    body.theme-dark .markdown-preview-table-wrapper thead th {
      background: rgba(34, 45, 70, 0.96);
      color: #f8fafc;
      box-shadow: inset 0 -1px 0 rgba(59, 130, 246, 0.45);
    }
    body.theme-dark .markdown-preview-table-wrapper tbody tr:nth-child(odd) {
      background: rgba(43, 56, 92, 0.54);
    }
    body.theme-dark .markdown-preview-table-wrapper th,
    body.theme-dark .markdown-preview-table-wrapper td {
      border-color: rgba(79, 99, 149, 0.55);
    }
    body.theme-dark .markdown-table-expand-btn {
      background: rgba(37, 99, 235, 0.18);
      border-color: rgba(59, 130, 246, 0.5);
      color: #dbeafe;
    }
    body.theme-dark .markdown-table-expand-btn:hover {
      background: rgba(37, 99, 235, 0.28);
      color: #fff;
    }
    body.theme-dark #markdown-preview {
      background: #0b1120;
      border-color: #1e293b;
    }
    body.theme-dark #pdf-container {
      background: #0b1120;
      border-color: #1e293b;
    }
    body.theme-dark .modal-header,
    body.theme-dark .modal-footer {
      border-color: #1f2937;
    }
    body.theme-dark .btn-outline-light {
      color: #f8fafc;
      border-color: #f8fafc;
    }
    body.theme-dark .btn-outline-light:hover {
      background-color: rgba(248, 250, 252, 0.1);
    }
    #editor-container {
      background: #f8f9fa;
      padding: 0;
    }
    .CodeMirror {
      height: 100% !important;
    }
    .CodeMirror-scroll {
      max-height: 100% !important;
    }
    #pdf-container {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 1rem;
    }
    #markdown-preview {
      padding: 1rem;
    }
    .markdown-preview-content pre {
      background: #f5f5f5;
      border-radius: 4px;
      padding: 0.75rem;
      overflow: auto;
    }
    .markdown-preview-content img {
      max-width: min(100%, 720px);
      height: auto;
      display: block;
      margin: 1.25rem auto;
      border-radius: 0.75rem;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.18);
      cursor: zoom-in;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .markdown-preview-content img:hover {
      transform: translateY(-2px) scale(1.01);
      box-shadow: 0 24px 55px rgba(15, 23, 42, 0.24);
    }
    .markdown-preview-content img:focus {
      outline: 3px solid rgba(59, 130, 246, 0.45);
      outline-offset: 4px;
    }
    .markdown-preview-content figure {
      margin: 1.5rem auto;
      text-align: center;
    }
    .markdown-preview-content figcaption {
      margin-top: 0.75rem;
      font-size: 0.9rem;
      color: #6b7280;
    }
    .markdown-heading-with-copy {
      position: relative;
      padding-right: 2.5rem;
    }
    .markdown-heading-copy-btn {
      position: absolute;
      top: 50%;
      right: 0.25rem;
      transform: translateY(-50%);
      font-size: 0.8rem;
      padding: 0.2rem 0.55rem;
      border-radius: 999px;
      border: 1px solid rgba(59, 130, 246, 0.4);
      background: rgba(59, 130, 246, 0.06);
      color: #1d4ed8;
      cursor: pointer;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.18s ease, background 0.18s ease, color 0.18s ease, border-color 0.18s ease;
    }
    .markdown-heading-copy-btn:focus,
    .markdown-heading-copy-btn:hover {
      background: rgba(59, 130, 246, 0.17);
      color: #1e3a8a;
      border-color: rgba(59, 130, 246, 0.6);
    }
    .markdown-heading-with-copy:hover .markdown-heading-copy-btn,
    .markdown-heading-copy-btn:focus {
      opacity: 1;
      pointer-events: auto;
    }
    body.theme-dark .markdown-heading-copy-btn {
      border-color: rgba(96, 165, 250, 0.45);
      background: rgba(37, 99, 235, 0.12);
      color: #93c5fd;
    }
    body.theme-dark .markdown-heading-copy-btn:hover,
    body.theme-dark .markdown-heading-copy-btn:focus {
      background: rgba(59, 130, 246, 0.35);
      color: #dbeafe;
      border-color: rgba(147, 197, 253, 0.8);
    }
    .markdown-preview-content .markdown-heading-highlight {
      background: rgba(191, 219, 254, 0.45);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
      border-radius: 0.5rem;
      transition: background 1.2s ease, box-shadow 1.2s ease;
    }
    .markdown-preview-table-wrapper {
      position: relative;
      margin: 1.25rem 0;
      border: 1px solid #c0ccf4;
      border-radius: 0.9rem;
      background: rgba(241, 244, 255, 0.94);
      overflow: auto;
      max-width: 100%;
      max-height: clamp(320px, 58vh, 640px);
      box-shadow: 0 18px 42px rgba(15, 23, 42, 0.18);
      padding: 1.75rem 1rem 1.4rem;
      scrollbar-width: thin;
      scrollbar-color: rgba(99, 102, 241, 0.45) transparent;
    }
    .markdown-preview-table-wrapper::-webkit-scrollbar {
      height: 8px;
      width: 8px;
    }
    .markdown-preview-table-wrapper::-webkit-scrollbar-thumb {
      background: rgba(99, 102, 241, 0.35);
      border-radius: 4px;
    }
    .markdown-preview-table-wrapper::-webkit-scrollbar-track {
      background: transparent;
    }
    .markdown-preview-table-wrapper table {
      width: 100%;
      min-width: 100%;
      border-collapse: collapse;
      background: rgba(235, 239, 255, 0.96);
      table-layout: auto;
    }
    .markdown-preview-table-wrapper caption {
      caption-side: top;
      text-align: left;
      font-weight: 600;
      margin-bottom: 0.75rem;
      color: #1f2937;
    }
    .markdown-preview-table-wrapper thead th {
      position: sticky;
      top: 0;
      z-index: 5;
      background: rgba(210, 219, 255, 0.98);
      color: #111827;
      box-shadow: inset 0 -1px 0 rgba(131, 146, 199, 0.45);
    }
    .markdown-preview-table-wrapper tbody tr:nth-child(odd) {
      background: rgba(206, 214, 255, 0.58);
    }
    .markdown-preview-table-wrapper th,
    .markdown-preview-table-wrapper td {
      border: 1px solid rgba(138, 151, 199, 0.45);
      padding: 0.6rem 0.75rem;
      text-align: left;
      vertical-align: middle;
      word-break: break-word;
      white-space: normal;
    }
    .markdown-table-expand-btn {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      z-index: 10;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.3rem 0.75rem;
      font-size: 0.8rem;
      font-weight: 600;
      background: rgba(99, 102, 241, 0.12);
      border: 1px solid rgba(99, 102, 241, 0.35);
      border-radius: 999px;
      color: #3730a3;
      backdrop-filter: blur(6px);
      cursor: pointer;
      transition: background 0.2s ease, color 0.2s ease, border-color 0.2s ease;
    }
    .markdown-table-expand-btn:hover,
    .markdown-table-expand-btn:focus {
      background: rgba(99, 102, 241, 0.22);
      border-color: rgba(67, 56, 202, 0.55);
      color: #1e1b4b;
      outline: none;
    }
    .markdown-table-expand-btn:focus-visible {
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.35);
    }
    .copy-trigger-wrapper {
      position: relative;
      display: block;
    }
    .copy-trigger-wrapper.inline-copy {
      display: inline-block;
      vertical-align: baseline;
    }
    .copy-trigger-btn {
      position: absolute;
      top: 0.35rem;
      right: 0.35rem;
      opacity: 0;
      transition: opacity 0.2s ease;
      padding: 0.1rem 0.4rem;
      line-height: 1.2;
      font-size: 0.75rem;
    }
    .copy-trigger-wrapper:hover .copy-trigger-btn,
    .copy-trigger-btn:focus {
      opacity: 1;
    }
    #pdf-pages {
      width: 100%;
    }
    .pdf-page-canvas {
      max-width: 100%;
      height: auto;
      background: #fff;
    }
    .navbar .btn-outline-primary {
      border-width: 2px;
    }
    .navbar-nav {
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }
    .navbar-nav .nav-item {
      display: flex;
      align-items: center;
    }
    .navbar-nav .dropdown-divider {
      height: 1.5rem;
      margin: 0 0.35rem;
    }
    @media (max-width: 991.98px) {
      .navbar-nav {
        flex-direction: row;
        justify-content: flex-start;
      }
    }
    @media (max-width: 575.98px) {
      .navbar-nav {
        gap: 0.4rem;
      }
    }
    @media (max-width: 767.98px) {
      .editor-pane,
      .preview-pane {
        min-height: 60vh;
      }
    }
    #markdownImageModal .modal-dialog {
      max-width: min(92vw, 1080px);
    }
    #markdownImageModal .modal-content {
      background: rgba(15, 23, 42, 0.92);
      color: #f8fafc;
      border: none;
      border-radius: 1rem;
      backdrop-filter: blur(12px);
      position: relative;
      overflow: hidden;
    }
    body.theme-dark #markdownImageModal .modal-content {
      background: rgba(15, 23, 42, 0.9);
    }
    body:not(.theme-dark) #markdownImageModal .modal-content {
      background: rgba(15, 23, 42, 0.94);
    }
    #markdownImageModal .modal-body {
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      background: transparent;
    }
    #markdownImageModal .image-wrapper {
      display: flex;
      justify-content: center;
      align-items: center;
      background: rgba(15, 23, 42, 0.82);
      border-radius: 0.75rem;
      padding: 1rem;
    }
    body:not(.theme-dark) #markdownImageModal .image-wrapper {
      background: rgba(241, 245, 249, 0.9);
    }
    #markdownImageModal .image-wrapper img {
      max-width: 100%;
      max-height: 80vh;
      width: auto;
      height: auto;
      border-radius: 0.5rem;
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.45);
    }
    #markdownImageCaption {
      font-size: 0.95rem;
      text-align: center;
      color: rgba(248, 250, 252, 0.78);
    }
    body:not(.theme-dark) #markdownImageCaption {
      color: rgba(30, 41, 59, 0.78);
    }
    #markdownTableModal .modal-dialog {
      max-width: min(95vw, 1280px);
    }
    #markdownTableModal .modal-content {
      border-radius: 1rem;
      border: none;
      background: rgba(248, 249, 253, 0.96);
      box-shadow: 0 32px 80px rgba(15, 23, 42, 0.35);
    }
    body.theme-dark #markdownTableModal .modal-content {
      background: rgba(15, 23, 42, 0.94);
      color: #e2e8f0;
    }
    #markdownTableModal .modal-body {
      padding: 1.75rem;
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }
    #markdownTableModalBody {
      max-height: 80vh;
      overflow: auto;
      border-radius: 0.9rem;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(240, 244, 255, 0.96);
      padding: 1.25rem;
      box-shadow: inset 0 0 0 1px rgba(210, 219, 255, 0.65);
    }
    body.theme-dark #markdownTableModalBody {
      background: rgba(15, 23, 42, 0.82);
      border-color: rgba(59, 130, 246, 0.35);
      box-shadow: inset 0 0 0 1px rgba(59, 130, 246, 0.18);
    }
    body.theme-dark #markdownTableModalBody table {
      background: rgba(17, 26, 46, 0.88);
      color: #e2e8f0;
    }
    #markdownTableModalBody table {
      width: max-content;
      min-width: min(1080px, 100%);
      max-width: none;
      border-collapse: collapse;
      margin: 0 auto;
      background: rgba(232, 237, 255, 0.96);
    }
    #markdownTableModalBody th,
    #markdownTableModalBody td {
      border: 1px solid rgba(138, 151, 199, 0.45);
      padding: 0.65rem 0.85rem;
      text-align: left;
      vertical-align: middle;
    }
    body.theme-dark #markdownTableModalBody th,
    body.theme-dark #markdownTableModalBody td {
      border-color: rgba(79, 99, 149, 0.55);
    }
    #markdownTableModalBody tbody tr:nth-child(odd) {
      background: rgba(205, 214, 255, 0.58);
    }
    #markdownTableModalBody caption {
      caption-side: top;
      text-align: left;
      font-weight: 600;
      margin-bottom: 0.75rem;
      color: #1f2937;
    }
    #markdownTableModalBody thead th {
      position: sticky;
      top: 0;
      background: rgba(224, 231, 255, 0.95);
      z-index: 3;
    }
    body.theme-dark #markdownTableModalBody thead th {
      background: rgba(30, 41, 59, 0.94);
      color: #f8fafc;
      box-shadow: inset 0 -1px 0 rgba(59, 130, 246, 0.45);
    }
    body.theme-dark #markdownTableModalBody tbody tr:nth-child(odd) {
      background: rgba(43, 56, 92, 0.54);
    }
    body.theme-dark #markdownTableModalBody caption {
      color: #e2e8f0;
    }
    #markdownTableModalCaption {
      font-size: 0.95rem;
      text-align: right;
      color: rgba(100, 116, 139, 0.95);
    }
    body.theme-dark #markdownTableModalCaption {
      color: rgba(203, 213, 225, 0.86);
    }
    #tabsModal #page-tabs {
      gap: 0.75rem;
    }
    #tabsModal #page-tabs .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 3.25rem;
      padding: 0.7rem 1.05rem;
      font-size: 1.05rem;
      border-radius: 1.75rem;
      cursor: grab;
      user-select: none;
    }
    #tabsModal #page-tabs .badge:active {
      cursor: grabbing;
    }
    @media (max-width: 1024px) {
      body.mobile-compact nav.navbar .navbar-nav > li { display: none !important; }
      body.mobile-compact nav.navbar .navbar-nav > li.mobile-allowed { display: flex !important; align-items: center; justify-content: center; }
      body.mobile-compact nav.navbar .navbar-nav > li hr { display: none !important; }
      body.mobile-compact #project-dropdown { display: none !important; }
      body.mobile-compact nav.navbar .navbar-nav { width: 100%; justify-content: center; }
      body.mobile-compact nav.navbar .navbar-nav > li.mobile-allowed { margin: 0 auto; width: 100%; padding: 0 12px; }
      body.mobile-compact .mobile-page-control-group { width: 100%; gap: 0.85rem; }
      body.mobile-compact .mobile-page-control-group .mobile-page-btn { flex: 1; padding: 16px 0; font-size: 1.25rem; border-radius: 1.8rem; }
      body.mobile-compact .mobile-page-control-group #page-status { flex: 1.3; }
      body.mobile-compact .preview-pane { display: none !important; }
      body.mobile-compact .editor-pane { flex: 1 1 100%; max-width: 100%; padding: 0 8px 16px; }
      body.mobile-compact #pages-list { padding: 6px 0; }
      body.mobile-compact #project-search-btn,
      body.mobile-compact #mode-switch-btn,
      body.mobile-compact #add-page,
      body.mobile-compact #insert-component,
      body.mobile-compact #edit-template,
      body.mobile-compact #export-btn,
      body.mobile-compact #ai-optimize,
      body.mobile-compact #ai-note-optimize,
      body.mobile-compact #ai-script-optimize,
      body.mobile-compact #ai-learn-helper,
      body.mobile-compact #play-note,
      body.mobile-compact #edit-bib,
      body.mobile-compact #manage-resources,
      body.mobile-compact #manage-attachments,
      body.mobile-compact #manage-sync,
      body.mobile-compact .page-script-container { display: none !important; }
      body.mobile-compact .js-nav-btn { font-size: 1.1rem; border-radius: 1.5rem; }
      body.mobile-compact .CodeMirror,
      body.mobile-compact .CodeMirror-scroll {
        font-size: clamp(1.15rem, 4.5vw, 1.35rem);
      }
      body.mobile-compact .CodeMirror { min-height: 72vh; border-radius: 1.2rem; }
      body.mobile-compact .CodeMirror pre { font-size: inherit; line-height: 1.7; }
      body.mobile-compact .CodeMirror-scroll { padding: 14px 18px; }
      body.mobile-compact textarea.form-control {
        font-size: clamp(1.15rem, 4.5vw, 1.35rem);
        line-height: 1.7;
        border-radius: 1.2rem;
        padding: 16px 18px;
      }
      body.mobile-compact .editor-pane textarea::placeholder { font-size: clamp(1rem, 3.6vw, 1.1rem); }
      body.mobile-compact #pages-list .CodeMirror { box-shadow: 0 10px 24px rgba(15, 23, 42, 0.18); }
      body.mobile-compact #tabsModal .modal-dialog { max-width: 95vw; margin: 1.5rem auto; }
      body.mobile-compact #tabsModal .modal-content { border-radius: 1.25rem; padding: 18px 16px; }
      body.mobile-compact #page-tabs { gap: 1rem; justify-content: center; }
      body.mobile-compact #page-tabs .badge {
        font-size: clamp(1.2rem, 4.6vw, 1.5rem);
        padding: 0.85rem 1.2rem;
        min-width: 3.4rem;
        border-radius: 2rem;
      }
      body.mobile-compact #tabs-actions,
      body.mobile-compact #tabs-actions-hint {
        display: none !important;
      }
    }
  </style>
</head>
<body class="{% if ui_theme and ui_theme.get('color_mode') == 'dark' %}theme-dark{% endif %}" data-bs-theme="{{ ui_theme.get('color_mode', 'light') if ui_theme else 'light' }}">
<div id="status-area" class="position-fixed top-0 start-50 translate-middle-x p-3" style="z-index:2000;"></div>
 
<nav class="navbar navbar-expand-lg navbar-light bg-light mb-3">
  <div class="container-fluid">
    <div class="d-flex align-items-center gap-3">
      <div class="dropdown">
        <button class="btn btn-outline-primary fw-semibold px-3 js-nav-btn" id="project-dropdown" data-bs-toggle="dropdown" aria-expanded="false">Benort</button>
        <ul class="dropdown-menu" id="project-menu" aria-labelledby="project-dropdown">
          <li><span class="dropdown-item-text text-muted">加载项目...</span></li>
        </ul>
      </div>
    </div>
  <div class="navbar-collapse show ms-3">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">

        <li class="nav-item mobile-allowed">
          <div class="mobile-page-control-group d-flex align-items-center">
            <button class="btn btn-outline-primary js-nav-btn mobile-page-btn" id="prev-page" title="上一页">上</button>
            <button type="button" class="btn btn-outline-primary js-nav-btn mobile-page-btn" id="page-status" >
              <span id="page-num">1</span> / <span id="page-count">1</span>
            </button>
            <button class="btn btn-outline-primary js-nav-btn mobile-page-btn" id="next-page" title="下一页">下</button>
          </div>
        </li>
        <li class="nav-item d-flex align-items-center">
          <button class="btn btn-outline-primary me-2 js-nav-btn" id="project-search-btn" title="检索当前项目">检索</button>
        </li>
        <li class="nav-item"><button class="btn btn-outline-primary me-2 js-nav-btn" id="mode-switch-btn" title="切换LaTeX/Markdown">模式</button></li>
        <li class="nav-item"><button class="btn btn-outline-secondary me-2 js-nav-btn" id="add-page" title="添加新页">加页</button></li>
        <li class="nav-item"><button class="btn btn-outline-warning me-2 js-nav-btn" id="insert-component" title="插入常用组件">插入</button></li>
        <li class="nav-item"><button class="btn btn-outline-info me-2 js-nav-btn" id="edit-template" title="编辑LaTeX样式模板">样式</button></li>
        <li><hr class="dropdown-divider m-1"></li>

  <li class="nav-item"><button class="btn btn-outline-success me-2 js-nav-btn" id="export-btn" title="导出">导出</button></li>
        <li><hr class="dropdown-divider m-1"></li>

        <li class="nav-item"><button class="btn btn-outline-danger me-2 js-nav-btn" id="ai-optimize" title="Latex优化">tex优化</button></li>
  <li class="nav-item"><button class="btn btn-outline-secondary me-2 js-nav-btn" id="ai-note-optimize" title="Markdown优化">md优化</button></li>
  <li class="nav-item"><button class="btn btn-outline-secondary me-2 js-nav-btn" id="ai-script-optimize" title="Speech script优化">script优化</button></li>
  <li class="nav-item"><button class="btn btn-outline-success me-2 js-nav-btn" id="ai-learn-helper" title="AI学习助手">ai助理</button></li>
        <li><hr class="dropdown-divider m-1"></li>
  <li class="nav-item"><button class="btn btn-outline-dark me-2 js-nav-btn" id="play-note" title="播放当前页讲稿">播放讲稿</button></li>
        <li><hr class="dropdown-divider m-1"></li>

        <li class="nav-item"><button class="btn btn-outline-primary me-2 js-nav-btn" id="edit-bib" title="管理文献">管理文献</button></li>
        <li class="nav-item"><button class="btn btn-outline-primary me-2 js-nav-btn" id="manage-resources" title="管理资源">管理资源</button></li>
        <li class="nav-item"><button class="btn btn-outline-primary me-2 js-nav-btn" id="manage-attachments" title="管理附件">管理附件</button></li>
        <li class="nav-item"><button class="btn btn-outline-primary me-2 js-nav-btn" id="manage-sync" title="OSS 同步设置">同步设置</button></li>

      <div class="modal fade" id="bibModal" tabindex="-1" aria-labelledby="bibModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="bibModalLabel">参考文献管理</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="row g-2 align-items-center mb-3">
                <div class="col-12 col-lg">
                  <input id="bib-input" class="form-control" placeholder="输入DOI、文献链接或完整bibtex">
                </div>
                <div class="col-6 col-sm-4 col-lg-2">
                  <select id="bib-scope" class="form-select">
                    <option value="global">全局</option>
                    <option value="page">本页</option>
                  </select>
                </div>
                <div class="col-6 col-sm-4 col-lg-2">
                  <button class="btn btn-success w-100" id="add-bib-btn">AI生成</button>
                </div>
                <div class="col-6 col-sm-4 col-lg-2">
                  <button class="btn btn-outline-primary w-100" id="add-url-bib-btn">直接保存</button>
                </div>
              </div>
              <div class="row g-2 mb-3">
                <div class="col-12 col-md-6">
                  <input id="bib-label-input" class="form-control" placeholder="可选：给文献起一个记忆用的名字">
                </div>
                <div class="col-12 col-md-6">
                  <input id="bib-note-input" class="form-control" placeholder="可选：备注这篇文献的重点">
                </div>
              </div>
              <div id="bib-list" class="d-flex flex-column gap-3">
                <div>
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">本页文献</h6>
                    <small class="text-muted" id="bib-page-count"></small>
                  </div>
                  <div id="bib-page-list" class="list-group"></div>
                </div>
                <div>
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">全局文献</h6>
                    <small class="text-muted" id="bib-global-count"></small>
                  </div>
                  <div id="bib-global-list" class="list-group"></div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="bibEntryModal" tabindex="-1" aria-labelledby="bibEntryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="bibEntryModalLabel">编辑文献信息</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="bib-edit-label" class="form-label">文献名称</label>
            <input type="text" class="form-control" id="bib-edit-label" placeholder="输入显示名称">
          </div>
          <div class="mb-3">
            <label for="bib-edit-note" class="form-label">备注</label>
            <textarea class="form-control" id="bib-edit-note" rows="3" placeholder="补充这篇文献的重点"></textarea>
          </div>
          <div class="border rounded p-3 bg-light" id="bib-edit-details">
            <div class="text-muted">暂无文献信息</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" id="bib-edit-save">保存</button>
        </div>
      </div>
    </div>
  </div>
  
      <!-- Resources Modal -->
      <div class="modal fade" id="resourcesModal" tabindex="-1" aria-labelledby="resourcesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="resourcesModalLabel">资源管理</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="mb-3 text-muted">当前页: <span id="resources-current-page">1</span></div>

                  <div class="input-group mb-3">
                    <input id="modal-resource-upload-input" type="file" class="form-control" />
                    <button id="modal-resource-upload-btn" class="btn btn-primary">上传到本页</button>
                    <button id="modal-resource-upload-global-btn" class="btn btn-secondary">上传为全局</button>
                  </div>

                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">本页资源</h6>
                    <small class="text-muted" id="resources-page-count"></small>
                  </div>
                  <div id="resources-page-list" class="list-group mb-3 resource-list"></div>

                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">全局资源</h6>
                    <small class="text-muted" id="resources-global-count"></small>
                  </div>
                  <div id="resources-global-list" class="list-group resource-list"></div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
              </div>
            </div>
          </div>

      <!-- Resource Preview Modal -->
      <div class="modal fade" id="resourcePreviewModal" tabindex="-1" aria-labelledby="resourcePreviewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="resourcePreviewModalLabel">资源预览</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
              <img id="resource-preview-image" src="" alt="preview" class="img-fluid" style="max-height:70vh;" />
              <div class="text-muted small mt-2" id="resource-preview-meta"></div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
              <a id="resource-preview-open" href="#" target="_blank" class="btn btn-primary">新标签页打开</a>
            </div>
          </div>
        </div>
      </div>

      <!-- Resource Rename Modal -->
      <div class="modal fade" id="resourceRenameModal" tabindex="-1" aria-labelledby="resourceRenameModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="resourceRenameModalLabel">重命名资源</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="resource-rename-input" class="form-label">新文件名</label>
                <input type="text" class="form-control" id="resource-rename-input" />
                <div class="form-text">名称会自动清理非法字符，请保留正确的扩展名。</div>
                <div class="form-text text-break mt-2" id="resource-rename-preview"></div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
              <button type="button" class="btn btn-primary" id="resource-rename-confirm">保存</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Attachments Modal -->
      <div class="modal fade" id="attachmentsModal" tabindex="-1" aria-labelledby="attachmentsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="attachmentsModalLabel">附件管理</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="input-group input-group-sm mb-3">
                <span class="input-group-text">筛选</span>
                <input id="attachment-filter-input" type="search" class="form-control" placeholder="输入关键词快速查找附件">
                <button class="btn btn-outline-secondary" type="button" id="attachment-filter-clear">清除</button>
              </div>
              <div class="input-group mb-3">
                <input id="modal-attachment-upload-input" type="file" class="form-control" />
                <button id="modal-attachment-upload-btn" class="btn btn-primary">上传附件</button>
              </div>
              <div id="attachments-usage-hint" class="alert alert-warning d-none small py-2 px-3"></div>
              <div id="attachments-list-modal" class="list-group"></div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
          </div>
        </div>
      </div>


      <div class="modal fade" id="searchModal" tabindex="-1" aria-labelledby="searchModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="searchModalLabel">内容检索</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="input-group input-group-sm mb-3">
                <input type="search" class="form-control" id="search-modal-input" placeholder="输入关键词检索当前项目" autocomplete="off">
                <button class="btn btn-outline-primary" type="button" id="search-modal-submit">检索</button>
              </div>
              <div class="mb-3 text-muted" id="search-summary">请输入关键词后检索当前项目。</div>
              <div id="search-results" class="list-group"></div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
          </div>
        </div>
      </div>

      
          <div class="modal fade" id="aiNoteModal" tabindex="-1" aria-labelledby="aiNoteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="aiNoteModalLabel">笔记AI优化结果</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <textarea id="ai-note-result" class="form-control" rows="8"></textarea>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
              <button type="button" class="btn btn-primary" id="apply-ai-note-result">应用到当前笔记</button>
            </div>
          </div>
        </div>
      </div>  

      <div class="modal fade" id="aiModal" tabindex="-1" aria-labelledby="aiModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="aiModalLabel">AI优化结果</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <textarea id="ai-result" class="form-control" rows="8"></textarea>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
              <button type="button" class="btn btn-primary" id="apply-ai-result">应用到当前页</button>
            </div>
          </div>
        </div>
      </div>
    
      <div class="modal fade" id="aiLearnModal" tabindex="-1" aria-labelledby="aiLearnModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="aiLearnModalLabel">AI 学习助手</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="row g-3">
                <div class="col-lg-6">
                  <label for="ai-learn-content" class="form-label">学习内容</label>
                  <textarea id="ai-learn-content" class="form-control" rows="8" placeholder="在此输入或粘贴想要学习的内容"></textarea>
                  <div class="d-flex justify-content-between align-items-center mt-2">
                    <small class="text-muted" id="ai-learn-content-hint">可自动捕获当前编辑器中的选中文字。</small>
                    <button class="btn btn-sm btn-outline-secondary" type="button" id="ai-learn-fill-selection">获取选中内容</button>
                  </div>
                </div>
                <div class="col-lg-6">
                  <label for="ai-learn-context" class="form-label">上下文（可选）</label>
                  <textarea id="ai-learn-context" class="form-control" rows="8" placeholder="添加额外背景、页面内容或你的学习目标，以便获得更精确的回答。"></textarea>
                  <div class="d-flex justify-content-between align-items-center mt-2">
                    <small class="text-muted">上下文会一并发送给 AI，可包含当前页 LaTeX、笔记、讲稿等信息。</small>
                    <button class="btn btn-sm btn-outline-secondary" type="button" id="ai-learn-fetch-context">获取上下文</button>
                  </div>
                </div>
              </div>
              <hr class="my-3">
              <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                <h6 class="mb-0">默认提示词</h6>
                <div class="d-flex align-items-center gap-2">
                  <button class="btn btn-sm btn-outline-secondary" type="button" id="ai-learn-refresh-prompts">刷新</button>
                  <button class="btn btn-sm btn-outline-dark" type="button" id="ai-learn-run-raw">无提示词</button>
                </div>
              </div>
              <div id="ai-learn-default-prompts" class="d-flex flex-wrap gap-2 mt-2"></div>
              <div class="mt-4 d-flex justify-content-between align-items-center flex-wrap gap-2">
                <h6 class="mb-0">自定义提示词</h6>
                <button class="btn btn-sm btn-outline-primary" type="button" id="ai-learn-add-prompt">新增提示词</button>
              </div>
              <div id="ai-learn-custom-prompts" class="d-flex flex-column gap-2 mt-2"></div>
              <hr class="my-3">
              <div>
                <h6 class="mb-2">学习结果</h6>
                <div id="ai-learn-results" class="d-flex flex-column gap-3">
                  <div class="text-muted small" id="ai-learn-results-empty">点击上方提示词开始学习，AI 的回答会显示在这里。</div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
          </div>
        </div>
      </div>

      <div class="modal fade" id="aiLearnPromptModal" tabindex="-1" aria-labelledby="aiLearnPromptModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="aiLearnPromptModalLabel">新增提示词</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="ai-learn-prompt-name" class="form-label">名称</label>
                <input type="text" class="form-control" id="ai-learn-prompt-name" placeholder="例如：雅思口语练习">
              </div>
              <div class="mb-3">
                <label for="ai-learn-prompt-description" class="form-label">用途描述（可选）</label>
                <input type="text" class="form-control" id="ai-learn-prompt-description" placeholder="提示词的适用场景或目标">
              </div>
              <div class="mb-3">
                <label for="ai-learn-prompt-system" class="form-label">系统提示（可选）</label>
                <textarea id="ai-learn-prompt-system" class="form-control" rows="3" placeholder="指定 AI 扮演的角色或总体风格，留空则使用默认导师提示。"></textarea>
              </div>
              <div class="mb-3">
                <label for="ai-learn-prompt-template" class="form-label">用户提示模板</label>
                <textarea id="ai-learn-prompt-template" class="form-control" rows="8" placeholder="可以使用 {content} 和 {context} 作为占位符。"></textarea>
                <div class="form-text">模板示例：<code>请分析以下内容：\n{content}\n\n上下文：\n{context}</code></div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
              <button type="button" class="btn btn-primary" id="ai-learn-prompt-save">保存</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Attachment Preview Modal -->
      <div class="modal fade" id="attachmentPreviewModal" tabindex="-1" aria-labelledby="attachmentPreviewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="attachmentPreviewModalLabel">附件预览</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
              <img id="attachment-preview-image" src="" alt="preview" class="img-fluid" style="max-height:70vh;" />
              <div class="text-muted small mt-2" id="attachment-preview-meta"></div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
              <a id="attachment-preview-open" href="#" target="_blank" class="btn btn-primary">新标签页打开</a>
            </div>
          </div>
        </div>
      </div>

      <!-- Attachment Rename Modal -->
      <div class="modal fade" id="attachmentRenameModal" tabindex="-1" aria-labelledby="attachmentRenameModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="attachmentRenameModalLabel">重命名附件</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="attachment-rename-input" class="form-label">新文件名</label>
                <input type="text" class="form-control" id="attachment-rename-input" />
                <div class="form-text">名称会自动清理非法字符，请保留正确的扩展名。</div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
              <button type="button" class="btn btn-primary" id="attachment-rename-confirm">保存</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Project Create Modal -->
      <div class="modal fade" id="projectCreateModal" tabindex="-1" aria-labelledby="projectCreateModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="projectCreateModalLabel">新建项目</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <label for="project-create-name" class="form-label">项目名称</label>
              <input type="text" class="form-control" id="project-create-name" placeholder="请输入项目名称" />
              <div class="form-text">名称仅支持字母、数字、下划线和中划线。</div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
              <button type="button" class="btn btn-primary" id="project-create-confirm">创建</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Project Rename Modal -->
      <div class="modal fade" id="projectRenameModal" tabindex="-1" aria-labelledby="projectRenameModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="projectRenameModalLabel">重命名项目</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <p class="mb-2" id="project-rename-current"></p>
              <label for="project-rename-name" class="form-label">新名称</label>
              <input type="text" class="form-control" id="project-rename-name" placeholder="请输入新名称" />
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
              <button type="button" class="btn btn-primary" id="project-rename-confirm">保存</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Project Delete Modal -->
      <div class="modal fade" id="projectDeleteModal" tabindex="-1" aria-labelledby="projectDeleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="projectDeleteModalLabel">删除项目</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <p class="text-danger" id="project-delete-warning">此操作无法撤销。</p>
              <label for="project-delete-confirm-name" class="form-label">请输入项目名称以确认删除</label>
              <input type="text" class="form-control" id="project-delete-confirm-name" />
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
              <button type="button" class="btn btn-danger" id="project-delete-confirm">删除</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Project Password Modal -->
      <div class="modal fade" id="projectPasswordModal" tabindex="-1" aria-labelledby="projectPasswordModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="projectPasswordModalLabel">项目密码</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="project-password-current" class="form-label">当前密码（若已有密码）</label>
                <input type="password" class="form-control" id="project-password-current" autocomplete="current-password" />
              </div>
              <div class="mb-3">
                <label for="project-password-new" class="form-label">新密码</label>
                <input type="password" class="form-control" id="project-password-new" autocomplete="new-password" />
              </div>
              <div class="mb-3">
                <label for="project-password-confirm" class="form-label">确认新密码</label>
                <input type="password" class="form-control" id="project-password-confirm" autocomplete="new-password" />
              </div>
              <div class="alert alert-warning d-none" id="project-password-warning"></div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-danger me-auto" id="project-password-remove">移除密码</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
              <button type="button" class="btn btn-primary" id="project-password-confirm">保存</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Project Unlock Modal -->
      <div class="modal fade" id="projectUnlockModal" tabindex="-1" aria-labelledby="projectUnlockModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="projectUnlockModalLabel">解锁项目</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <p id="project-unlock-target" class="mb-2"></p>
              <label for="project-unlock-password" class="form-label">输入项目密码</label>
              <input type="password" class="form-control" id="project-unlock-password" autocomplete="current-password" />
              <div class="alert alert-danger d-none mt-3" id="project-unlock-error"></div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
              <button type="button" class="btn btn-primary" id="project-unlock-confirm">解锁</button>
            </div>
          </div>
        </div>
      </div>

      <!-- OSS Sync Modal -->
      <div class="modal fade" id="ossSyncModal" tabindex="-1" aria-labelledby="ossSyncModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="ossSyncModalLabel">OSS 同步设置</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" id="oss-sync-toggle-main" />
                <label class="form-check-label" for="oss-sync-toggle-main">启用 OSS 同步</label>
              </div>
              <div class="alert alert-warning d-none" id="oss-sync-warning-main"></div>
              <dl class="row small mb-3" id="oss-sync-paths">
                <dt class="col-sm-4">附件目录</dt><dd class="col-sm-8 text-break" id="oss-sync-attachments"></dd>
                <dt class="col-sm-4">资源目录</dt><dd class="col-sm-8 text-break" id="oss-sync-resources"></dd>
                <dt class="col-sm-4">项目 YAML</dt><dd class="col-sm-8 text-break" id="oss-sync-yaml"></dd>
              </dl>
              <div class="border rounded p-2 bg-light text-break" id="oss-sync-status" style="min-height:3rem"></div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" id="oss-sync-run">立即同步</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
          </div>
        </div>
      </div>

      <!-- AI Script Modal (optimized speaking script) -->
      <div class="modal fade" id="aiScriptModal" tabindex="-1" aria-labelledby="aiScriptModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="aiScriptModalLabel">讲稿 AI 优化结果</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <textarea id="ai-script-result" class="form-control" rows="8"></textarea>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
              <button type="button" class="btn btn-primary" id="apply-ai-script-result">应用到当前讲稿</button>
            </div>
          </div>
        </div>
      </div>
      </ul>
    </div>
  </div>
</nav>
<div class="container-fluid">
  <div id="editor-preview-wrapper" class="mb-3">
    <div class="editor-pane">
      
      <form id="tex-form" class="flex-grow-1 d-flex flex-column">
        <div id="editor-container">
          <div id="pages-list"></div>
        </div>
      </form>

      <div class="modal fade" id="tabsModal" tabindex="-1" aria-labelledby="tabsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="tabsModalLabel">页面拖拽排序</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div id="page-tabs" class="d-flex flex-wrap"></div>
              <div class="text-muted mt-2">拖动页码标签可调整顺序，点击页码可跳转</div>
              <div class="d-flex flex-wrap gap-2 mt-3" id="tabs-actions">
                <button type="button" class="btn btn-outline-secondary btn-sm" id="tabs-copy-page-id">复制 pageId</button>
                <button type="button" class="btn btn-outline-danger btn-sm" id="tabs-delete-page">删除当前页</button>
                <button type="button" class="btn btn-outline-primary btn-sm" id="tabs-copy-page-link">复制打开链接</button>
              </div>
              <div class="form-text mt-1" id="tabs-actions-hint">复制后的链接包含项目与 pageId，可分享给他人直接打开该页。</div>
            </div>
          </div>
        </div>
      </div>

      <div class="modal fade" id="componentModal" tabindex="-1" aria-labelledby="componentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="componentModalLabel">插入常用页面组件</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="list-group" id="component-list">
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
          </div>
        </div>
      </div>

      <div class="modal fade" id="templateModal" tabindex="-1" aria-labelledby="templateModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="templateModalLabel">编辑样式模板</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label">选择基础模板</label>
                <select id="template-select" class="form-select mb-2">
                  <option value="">自定义（当前模板）</option>
                </select>
                <div class="form-text" id="template-helper-text">选择后仍可在下方继续调整。</div>
              </div>
              <div id="template-latex-fields">
                <label class="form-label">文档头部（第一页前）</label>
                <textarea id="template-header" class="form-control mb-2" rows="4"></textarea>
                <label class="form-label">文档主体（每页前）</label>
                <textarea id="template-before-pages" class="form-control mb-2" rows="2"></textarea>
                <label class="form-label">文档结尾（最后一页后）</label>
                <textarea id="template-footer" class="form-control" rows="2"></textarea>
              </div>
              <div id="template-markdown-fields" class="d-none">
                <label class="form-label">Markdown 全局 CSS</label>
                <textarea id="template-markdown-css" class="form-control mb-2" rows="10" placeholder="为预览页面定义全局样式"></textarea>
                <div class="form-text">CSS 会实时应用于右侧预览，同时随项目一同保存。</div>
                <label class="form-label">预览容器附加 class（可选）</label>
                <input type="text" id="template-markdown-wrapper" class="form-control mb-2" placeholder="例如：markdown-note prose">
                <div class="form-text">指定多个 class 时使用空格分隔，将添加在 Markdown 预览根节点上。</div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
              <button type="button" class="btn btn-primary" id="save-template">保存模板</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="preview-pane">
      
      <div id="pdf-container" class="d-none">
        <div id="pdf-pages" class="w-100 d-flex flex-column align-items-center gap-3"></div>
      </div>
      <div id="markdown-preview">
        <div id="markdown-preview-content" class="markdown-preview-content mt-4"></div>
      </div>
    </div>
  </div>

  <div class="mb-4 mt-2 page-script-container">
    <textarea id="page-script" class="form-control" rows="4" placeholder="这里是本页的讲稿，支持导出语音。"></textarea>
  </div>
  
  <!-- Export Modal -->
  <div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exportModalLabel">导出选项</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="exportOption" id="exportPagePdfOption" value="page_pdf" checked>
            <label class="form-check-label" for="exportPagePdfOption">导出 当前页 PDF</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="exportOption" id="exportPageNotesOption" value="page_notes">
            <label class="form-check-label" for="exportPageNotesOption">导出 当前页 Markdown</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="exportOption" id="exportPageNotesHtmlOption" value="page_notes_html">
            <label class="form-check-label" for="exportPageNotesHtmlOption">导出 当前页 Markdown（HTML）</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="exportOption" id="exportPageAudioOption" value="page_audio">
            <label class="form-check-label" for="exportPageAudioOption">导出 当前页讲稿语音 (MP3)</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="exportOption" id="exportNotesOption" value="notes">
            <label class="form-check-label" for="exportNotesOption">导出 全部笔记 (Markdown)</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="exportOption" id="exportTexOption" value="tex">
            <label class="form-check-label" for="exportTexOption">导出 全部 TeX</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="exportOption" id="exportLearnOption" value="learn">
            <label class="form-check-label" for="exportLearnOption">导出 学习记录 (learn_project.yaml)</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="exportOption" id="exportAttachmentsOption" value="attachments">
            <label class="form-check-label" for="exportAttachmentsOption">导出 资料、附件和 yaml (zip)</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="exportOption" id="exportAudioOption" value="audio">
            <label class="form-check-label" for="exportAudioOption">导出 全部讲稿语音 (MP3)</label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
          <button type="button" class="btn btn-primary" id="doExportBtn">开始导出</button>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="markdownImageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content">
      <div class="modal-body">
        <div class="image-wrapper">
          <img id="markdownImageModalImg" class="img-fluid" alt="">
        </div>
        <div id="markdownImageCaption" class="d-none"></div>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="markdownTableModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content">
      <div class="modal-body">
        <div id="markdownTableModalBody"></div>
        <div id="markdownTableModalCaption" class="d-none"></div>
      </div>
    </div>
  </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/stex/stex.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/markdown/markdown.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script>
  if (window.hljs) {
    hljs.configure({ignoreUnescapedHTML: true});
  }
</script>
<script>
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$', '$$'], ['\\[', '\\]']],
      processEscapes: true
    },
    svg: { fontCache: 'global' }
  };
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script>
  marked.setOptions({
    breaks: true,
    gfm: true,
    highlight: function(code, lang) {
      if (window.hljs) {
        try {
          if (lang && hljs.getLanguage(lang)) {
            return hljs.highlight(code, {language: lang}).value;
          }
          return hljs.highlightAuto(code).value;
        } catch (err) {
          console.warn('代码高亮失败', err);
        }
      }
      return code;
    }
  });

  function escapeHtml(text) {
    if (text === null || text === undefined) return '';
    return String(text).replace(/[&<"'>]/g, function(ch) {
      switch (ch) {
        case '&': return '&amp;';
        case '<': return '&lt;';
        case '>': return '&gt;';
        case '"': return '&quot;';
        case "'": return '&#39;';
        default: return ch;
      }
    });
  }

  function highlightExcerptText(excerpt, query) {
    if (!excerpt) return '';
    if (!query) return escapeHtml(excerpt);
    try {
      const escapedQuery = query.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
      if (!escapedQuery) return escapeHtml(excerpt);
      const regex = new RegExp(escapedQuery, 'gi');
      let cursor = 0;
      let html = '';
      let match;
      while ((match = regex.exec(excerpt)) !== null) {
        const chunk = excerpt.slice(cursor, match.index);
        html += escapeHtml(chunk);
        html += '<mark>' + escapeHtml(match[0]) + '</mark>';
        cursor = match.index + match[0].length;
        if (regex.lastIndex === match.index) {
          regex.lastIndex += 1;
        }
      }
      html += escapeHtml(excerpt.slice(cursor));
      return html || escapeHtml(excerpt);
    } catch (err) {
      return escapeHtml(excerpt);
    }
  }

  
  function updatePageNumLabel() {
    document.getElementById('page-num').textContent = currentPageIdx+1;
    document.getElementById('page-count').textContent = pagesData.length;
  }

  function jumpToPage(targetIdx) {
    if (!Array.isArray(pagesData) || !pagesData.length) return;
    let idx = Number(targetIdx);
    if (!Number.isFinite(idx)) idx = 0;
    idx = Math.trunc(idx);
    if (idx < 0) idx = 0;
    if (idx >= pagesData.length) idx = pagesData.length - 1;
    if (idx === currentPageIdx) return;
    currentPageIdx = idx;
    renderSingleEditor();
    updatePageNumLabel();
  }

  
  const COMPONENT_LIBRARY = window.BENORT_COMPONENT_LIBRARY || {};
  let markdownImageModalInstance = null;
  let markdownTableModalInstance = null;

  function getComponentGroups(mode) {
    if (mode === 'markdown') {
      return Array.isArray(COMPONENT_LIBRARY.markdown) ? COMPONENT_LIBRARY.markdown : [];
    }
    return Array.isArray(COMPONENT_LIBRARY.latex) ? COMPONENT_LIBRARY.latex : [];
  }

  document.getElementById('insert-component').onclick = function() {
    const list = document.getElementById('component-list');
    list.innerHTML = '';
    const mode = currentEditMode === 'markdown' ? 'markdown' : 'latex';
    const groups = getComponentGroups(mode);
    const modalLabel = document.getElementById('componentModalLabel');
    if (modalLabel) {
      modalLabel.textContent = mode === 'markdown' ? '插入 Markdown 片段' : '插入 LaTeX 组件';
    }
    if (!groups.length) {
      list.innerHTML = '<div class="text-center text-muted py-3">暂无可用组件</div>';
      const fallbackModal = new bootstrap.Modal(document.getElementById('componentModal'));
      fallbackModal.show();
      return;
    }

    const container = document.createElement('div');
    container.className = 'd-flex';
    const nav = document.createElement('div');
    nav.className = 'list-group me-3';
    nav.style.minWidth = '140px';
    const compArea = document.createElement('div');
    compArea.style.flex = '1';

    function renderCompList(idx) {
      compArea.innerHTML = '';
      const currentGroup = groups[idx];
      if (!currentGroup || !Array.isArray(currentGroup.items)) {
        compArea.innerHTML = '<div class="text-muted">该分类暂无片段</div>';
        return;
      }
      currentGroup.items.forEach(comp => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'list-group-item list-group-item-action mb-1 text-start';
        btn.textContent = comp.name;
        btn.onclick = function() {
          if(singleEditor) {
            const doc = singleEditor.getDoc();
            const cursor = doc.getCursor();
            const snippet = typeof comp.code === 'string' ? comp.code : '';
            let extra = '';
            if (!snippet.endsWith('\n')) {
              extra += '\n';
            }
            if (mode === 'markdown') {
              extra += '\n';
            }
            doc.replaceRange(snippet + extra, cursor);
          }
          const modalInstance = bootstrap.Modal.getInstance(document.getElementById('componentModal'));
          if (modalInstance) modalInstance.hide();
        };
        compArea.appendChild(btn);
      });
    }

    groups.forEach((group, idx) => {
      const navBtn = document.createElement('button');
      navBtn.type = 'button';
      navBtn.className = 'list-group-item list-group-item-action' + (idx === 0 ? ' active' : '');
      navBtn.textContent = group.group;
      navBtn.onclick = function() {
        Array.from(nav.children).forEach(btn => btn.classList.remove('active'));
        navBtn.classList.add('active');
        renderCompList(idx);
      };
      nav.appendChild(navBtn);
    });

    renderCompList(0);
    container.appendChild(nav);
    container.appendChild(compArea);
    list.appendChild(container);
    const modal = new bootstrap.Modal(document.getElementById('componentModal'));
    modal.show();
  };
  let pagesData = [];

  function generatePageId() {
    if (typeof crypto !== 'undefined' && typeof crypto.randomUUID === 'function') {
      return crypto.randomUUID();
    }
    const rand = Math.random().toString(16).slice(2);
    return 'pg_' + rand + Date.now().toString(16);
  }
  let globalResources = [];
  let latexTemplate = {
    header: '\\documentclass{beamer}\n\\usepackage[utf8]{inputenc}\n\\usetheme{Madrid}',
    beforePages: '\\begin{document}',
    footer: '\\end{document}'
  };
  let markdownTemplate = {
    css: '',
    wrapperClass: ''
  };

  
  let currentPageIdx = 0;
  let singleEditor = null;
  let currentEditMode = 'markdown';
  let currentProject = '';
  const INITIAL_URL_STATE = (() => {
    try {
      const url = new URL(window.location.href);
      const params = url.searchParams;
      const projectParam = (params.get('project') || params.get('proj') || '').trim();
      let combined = '';
      if (url.search) combined += url.search;
      if (url.hash) combined += url.hash;
      const deepLink = combined ? parseMarkdownInternalLink(combined) : null;
      return {project: projectParam, deepLink};
    } catch (err) {
      return {project: '', deepLink: null};
    }
  })();
  if (INITIAL_URL_STATE.project) {
    currentProject = INITIAL_URL_STATE.project;
  }
  let initialDeepLinkTarget = INITIAL_URL_STATE.deepLink;
  let initialDeepLinkApplied = false;
  let compileTimer = null;
  let isCompiling = false;
  let compilePending = false;
  let availableTemplates = { latex: [], markdown: [] };
  let templatesLoaded = false;
  let selectedTemplateName = { latex: '', markdown: '' };
  let saveProjectTimer = null;
  let saveRequestQueue = Promise.resolve();
  let pendingSaveCallbacks = [];
  let searchModalInstance = null;
  let searchResultsCache = [];
  let searchQueryCache = '';
  let searchAbortController = null;
  let searchRequestId = 0;
  let searchDebounceTimer = null;
  let isMobileCompactView = false;
  let mobileEditingDisabled = false;
  let mobileWarnedProject = '';
  let markdownHeadingHighlightTimer = null;
  let markdownHeadingActiveEl = null;

  let resourceRenameTarget = null;
  let attachmentRenameTarget = null;
  const SCRIPT_ROOT = {{ request.script_root|tojson }} || '';
  function buildApiUrl(path){
    if(!path) return SCRIPT_ROOT || '';
    if(path.startsWith('http://') || path.startsWith('https://')) return path;
    if(path.startsWith('/')) return (SCRIPT_ROOT || '') + path;
    return (SCRIPT_ROOT || '') + '/' + path;
  }
  const PROJECT_ENDPOINTS = {
    list: buildApiUrl('/projects'),
    create: buildApiUrl('/projects/create'),
    rename: buildApiUrl('/projects/rename'),
    delete: buildApiUrl('/projects/delete'),
    password: buildApiUrl('/projects/password'),
    unlock: buildApiUrl('/projects/unlock'),
    lock: buildApiUrl('/projects/lock'),
    project: buildApiUrl('/project'),
    projectSave: buildApiUrl('/project'),
  };
  const resourceRenameModalEl = document.getElementById('resourceRenameModal');
  const resourceRenameInput = document.getElementById('resource-rename-input');
  const resourceRenamePreview = document.getElementById('resource-rename-preview');
  const resourceRenameConfirm = document.getElementById('resource-rename-confirm');
  const resourcePreviewModalEl = document.getElementById('resourcePreviewModal');
  const resourcePreviewImage = document.getElementById('resource-preview-image');
  const resourcePreviewMeta = document.getElementById('resource-preview-meta');
  const resourcePreviewOpen = document.getElementById('resource-preview-open');
  const attachmentRenameModalEl = document.getElementById('attachmentRenameModal');
  const attachmentRenameInput = document.getElementById('attachment-rename-input');
  const attachmentRenameConfirm = document.getElementById('attachment-rename-confirm');
  const attachmentPreviewModalEl = document.getElementById('attachmentPreviewModal');
  const attachmentPreviewImage = document.getElementById('attachment-preview-image');
  const attachmentPreviewMeta = document.getElementById('attachment-preview-meta');
  const attachmentPreviewOpen = document.getElementById('attachment-preview-open');
  const ossSyncModalEl = document.getElementById('ossSyncModal');
  const ossSyncToggleMain = document.getElementById('oss-sync-toggle-main');
  const ossSyncWarningMain = document.getElementById('oss-sync-warning-main');
  const ossSyncAttachments = document.getElementById('oss-sync-attachments');
  const ossSyncResources = document.getElementById('oss-sync-resources');
  const ossSyncYaml = document.getElementById('oss-sync-yaml');
  const ossSyncStatusBox = document.getElementById('oss-sync-status');
  const ossSyncRunBtn = document.getElementById('oss-sync-run');
  const searchInputEl = document.getElementById('search-modal-input');
  const searchSubmitBtn = document.getElementById('search-modal-submit');
  let projectMetadata = {};
  let projectRenameTarget = '';
  let projectDeleteTarget = '';
  let projectPasswordTarget = '';
  let projectUnlockTargetName = '';
  const projectCreateModalEl = document.getElementById('projectCreateModal');
  const projectCreateNameInput = document.getElementById('project-create-name');
  const projectCreateConfirmBtn = document.getElementById('project-create-confirm');
  const projectRenameModalEl = document.getElementById('projectRenameModal');
  const projectRenameCurrent = document.getElementById('project-rename-current');
  const projectRenameInput = document.getElementById('project-rename-name');
  const projectRenameConfirmBtn = document.getElementById('project-rename-confirm');
  const projectDeleteModalEl = document.getElementById('projectDeleteModal');
  const projectDeleteWarning = document.getElementById('project-delete-warning');
  const projectDeleteConfirmInput = document.getElementById('project-delete-confirm-name');
  const projectDeleteConfirmBtn = document.getElementById('project-delete-confirm');
  const projectPasswordModalEl = document.getElementById('projectPasswordModal');
  const projectPasswordCurrentInput = document.getElementById('project-password-current');
  const projectPasswordNewInput = document.getElementById('project-password-new');
  const projectPasswordConfirmInput = document.getElementById('project-password-confirm');
  const projectPasswordWarning = document.getElementById('project-password-warning');
  const projectPasswordConfirmBtn = document.getElementById('project-password-confirm');
  const projectPasswordRemoveBtn = document.getElementById('project-password-remove');
  const projectUnlockModalEl = document.getElementById('projectUnlockModal');
  const projectUnlockTargetLabel = document.getElementById('project-unlock-target');
  const projectUnlockPasswordInput = document.getElementById('project-unlock-password');
  const projectUnlockErrorBox = document.getElementById('project-unlock-error');
  const projectUnlockConfirmBtn = document.getElementById('project-unlock-confirm');

  if(resourceRenameModalEl){
    resourceRenameModalEl.addEventListener('hidden.bs.modal', () => {
      resourceRenameTarget = null;
      if(resourceRenameInput) {
        resourceRenameInput.value = '';
        resourceRenameInput.removeAttribute('title');
      }
      if(resourceRenamePreview) resourceRenamePreview.textContent = '';
    });
    resourceRenameModalEl.addEventListener('shown.bs.modal', () => {
      if(!resourceRenameInput) return;
      requestAnimationFrame(() => {
        resourceRenameInput.focus();
        resourceRenameInput.select();
      });
    });
  }

  if(resourceRenameInput && resourceRenamePreview && !resourceRenameInput.dataset.previewBound){
    resourceRenameInput.dataset.previewBound = 'true';
    resourceRenameInput.addEventListener('input', () => {
      const currentValue = resourceRenameInput.value;
      resourceRenamePreview.textContent = currentValue ? `完整名称：${currentValue}` : '';
      if(currentValue){
        resourceRenameInput.title = currentValue;
      } else {
        resourceRenameInput.removeAttribute('title');
      }
    });
  }
  if(resourcePreviewModalEl){
    resourcePreviewModalEl.addEventListener('hidden.bs.modal', () => {
      if(resourcePreviewImage) resourcePreviewImage.removeAttribute('src');
      if(resourcePreviewMeta) resourcePreviewMeta.textContent = '';
      if(resourcePreviewOpen){
        resourcePreviewOpen.href = '#';
        resourcePreviewOpen.classList.add('disabled');
      }
    });
  }

  if(attachmentRenameModalEl){
    attachmentRenameModalEl.addEventListener('hidden.bs.modal', () => {
      attachmentRenameTarget = null;
      if(attachmentRenameInput) attachmentRenameInput.value = '';
    });
  }

  if(attachmentPreviewModalEl){
    attachmentPreviewModalEl.addEventListener('hidden.bs.modal', () => {
      if(attachmentPreviewImage) attachmentPreviewImage.removeAttribute('src');
      if(attachmentPreviewMeta) attachmentPreviewMeta.textContent = '';
    });
  }

  if(projectCreateModalEl){
    projectCreateModalEl.addEventListener('hidden.bs.modal', () => {
      if(projectCreateNameInput) projectCreateNameInput.value = '';
    });
    projectCreateModalEl.addEventListener('shown.bs.modal', () => {
      if(projectCreateNameInput) projectCreateNameInput.focus();
    });
  }

  if(projectRenameModalEl){
    projectRenameModalEl.addEventListener('hidden.bs.modal', () => {
      projectRenameTarget = '';
      if(projectRenameInput) projectRenameInput.value = '';
    });
    projectRenameModalEl.addEventListener('shown.bs.modal', () => {
      if(projectRenameInput) projectRenameInput.focus();
    });
  }

  if(projectDeleteModalEl){
    projectDeleteModalEl.addEventListener('hidden.bs.modal', () => {
      projectDeleteTarget = '';
      if(projectDeleteConfirmInput){
        projectDeleteConfirmInput.value = '';
        projectDeleteConfirmInput.classList.remove('is-invalid');
      }
    });
    projectDeleteModalEl.addEventListener('shown.bs.modal', () => {
      if(projectDeleteConfirmInput) projectDeleteConfirmInput.focus();
    });
  }

  if(projectPasswordModalEl){
    projectPasswordModalEl.addEventListener('hidden.bs.modal', () => {
      projectPasswordTarget = '';
      if(projectPasswordCurrentInput) projectPasswordCurrentInput.value = '';
      if(projectPasswordNewInput) projectPasswordNewInput.value = '';
      if(projectPasswordConfirmInput) projectPasswordConfirmInput.value = '';
      if(projectPasswordWarning){
        projectPasswordWarning.textContent = '';
        projectPasswordWarning.classList.add('d-none');
      }
    });
    projectPasswordModalEl.addEventListener('shown.bs.modal', () => {
      if(projectPasswordNewInput) projectPasswordNewInput.focus();
    });
  }

  if(projectUnlockModalEl){
    projectUnlockModalEl.addEventListener('hidden.bs.modal', () => {
      projectUnlockTargetName = '';
      if(projectUnlockPasswordInput) projectUnlockPasswordInput.value = '';
      if(projectUnlockErrorBox){
        projectUnlockErrorBox.classList.add('d-none');
        projectUnlockErrorBox.textContent = '';
      }
    });
    projectUnlockModalEl.addEventListener('shown.bs.modal', () => {
      if(projectUnlockPasswordInput) projectUnlockPasswordInput.focus();
    });
  }

  function renderSyncEntry(entry){
    if(!entry) return '无数据';
    if(entry.error) return `失败：${entry.error}`;
    if(Object.prototype.hasOwnProperty.call(entry, 'uploaded') && Object.prototype.hasOwnProperty.call(entry, 'removed')){
      const uploaded = Array.isArray(entry.uploaded) ? entry.uploaded.length : 0;
      const removed = Array.isArray(entry.removed) ? entry.removed.length : 0;
      const failed = Array.isArray(entry.failed) ? entry.failed.length : 0;
      return `上传 ${uploaded}，删除 ${removed}，失败 ${failed}`;
    }
    if(Object.prototype.hasOwnProperty.call(entry, 'uploaded') && Object.prototype.hasOwnProperty.call(entry, 'url')){
      if(entry.error) return `失败：${entry.error}`;
      if(entry.uploaded) return entry.url ? `已上传 (${entry.url})` : '已上传';
      return '未上传';
    }
    return JSON.stringify(entry);
  }

  function getProjectMeta(name){
    if(!name) return {};
    return projectMetadata && Object.prototype.hasOwnProperty.call(projectMetadata, name) ? (projectMetadata[name] || {}) : {};
  }

  function closeProjectDropdown(){
    const dropdownToggle = document.getElementById('project-dropdown');
    if(!dropdownToggle) return;
    const dropdown = bootstrap.Dropdown.getInstance(dropdownToggle);
    if(dropdown) dropdown.hide();
  }

  function openProjectUnlockModal(name){
    projectUnlockTargetName = name || currentProject || '';
    if(projectUnlockTargetLabel){
      const labelName = projectUnlockTargetName || '当前项目';
      projectUnlockTargetLabel.textContent = `项目「${labelName}」已加密，请输入密码解锁。`;
    }
    if(projectUnlockErrorBox){
      projectUnlockErrorBox.classList.add('d-none');
      projectUnlockErrorBox.textContent = '';
    }
    if(projectUnlockPasswordInput) projectUnlockPasswordInput.value = '';
    if(projectUnlockModalEl){
      const modal = bootstrap.Modal.getOrCreateInstance(projectUnlockModalEl);
      modal.show();
    }
  }

  function handleProjectLocked(message){
    const info = message || '项目已加密，请先解锁';
    showStatus(info, 'warning', 6000);
    openProjectUnlockModal(currentProject);
  }

  function ensureSearchModal() {
    if (searchModalInstance) return searchModalInstance;
    const modalEl = document.getElementById('searchModal');
    if (!modalEl) return null;
    searchModalInstance = bootstrap.Modal.getOrCreateInstance(modalEl);
    modalEl.addEventListener('shown.bs.modal', () => {
      if (searchInputEl) {
        searchInputEl.focus();
        searchInputEl.select();
      }
    });
    modalEl.addEventListener('hidden.bs.modal', () => {
      const resultsEl = document.getElementById('search-results');
      if (resultsEl) {
        resultsEl.scrollTop = 0;
      }
      if (searchDebounceTimer) {
        clearTimeout(searchDebounceTimer);
        searchDebounceTimer = null;
      }
      if (searchInputEl) {
        searchInputEl.removeAttribute('data-loading');
      }
    });
    return searchModalInstance;
  }

  function setSearchSummary(message, tone = 'muted') {
    const summaryEl = document.getElementById('search-summary');
    if (!summaryEl) return;
    summaryEl.textContent = message || '';
    summaryEl.classList.remove('text-muted', 'text-danger', 'text-success');
    if (tone === 'danger') summaryEl.classList.add('text-danger');
    else if (tone === 'success') summaryEl.classList.add('text-success');
    else summaryEl.classList.add('text-muted');
  }

  function renderSearchResults(results, query) {
    const list = document.getElementById('search-results');
    if (!list) return;
    list.innerHTML = '';

    if (!Array.isArray(results) || results.length === 0) {
      const message = query ? `未找到与“${query}”相关的内容。` : '请输入关键词后检索当前项目。';
      setSearchSummary(message, query ? 'danger' : 'muted');
      return;
    }

    setSearchSummary(`找到 ${results.length} 条与 “${query}” 相关的内容。`, 'success');

    results.forEach((match, idx) => {
      const item = document.createElement('button');
      item.type = 'button';
      item.className = 'list-group-item list-group-item-action text-start';
      item.dataset.searchResultIndex = String(idx);

      const pageLabel = match.pageLabel || `第 ${match.pageIndex + 1} 页`;
      const fieldLabel = match.fieldLabel || match.field || '';
      const matchCount = typeof match.matchCount === 'number' ? match.matchCount : 1;
      const excerptHtml = highlightExcerptText(match.excerpt || '', query);

      item.innerHTML = `
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
          <div class="fw-semibold">${escapeHtml(pageLabel)}</div>
          <div class="d-flex align-items-center gap-2">
            <span class="badge bg-primary-subtle text-primary-emphasis border border-primary-subtle">${escapeHtml(fieldLabel)}</span>
            <span class="badge bg-light text-muted border">${matchCount} 次命中</span>
          </div>
        </div>
        <div class="mt-2 text-muted small">${excerptHtml}</div>
      `;

      item.addEventListener('click', () => {
        navigateToSearchMatch(match, query);
      });

      list.appendChild(item);
    });
  }

  function resetSearchState() {
    searchResultsCache = [];
    searchQueryCache = '';
    renderSearchResults([], '');
    setSearchSummary('请输入关键词后检索当前项目。', 'muted');
  }

  function handleSearchError(message) {
    renderSearchResults([], searchQueryCache);
    setSearchSummary(message || '检索失败，请稍后再试。', 'danger');
  }

  function highlightScriptMatch(match, query) {
    const scriptInput = document.getElementById('page-script');
    if (!scriptInput) return;
    const value = scriptInput.value || '';
    let start = typeof match.position === 'number' ? match.position : -1;
    const searchTerm = query || '';
    if (start < 0 && searchTerm) {
      start = value.toLowerCase().indexOf(searchTerm.toLowerCase());
    }
    if (start < 0) return;
    const len = Math.min(match.matchLength || searchTerm.length || 1, value.length - start);
    scriptInput.focus();
    scriptInput.setSelectionRange(start, start + len);
  }

  function highlightEditorMatch(match, query) {
    if (!singleEditor) return;
    const doc = singleEditor.getDoc();
    const value = doc.getValue();
    if (!value) return;
    const searchTerm = query || '';
    let start = typeof match.position === 'number' ? match.position : -1;
    if (start < 0 && searchTerm) {
      start = value.toLowerCase().indexOf(searchTerm.toLowerCase());
    }
    if (start < 0) return;
    const length = Math.min(match.matchLength || searchTerm.length || 1, value.length - start);
    const from = doc.posFromIndex(start);
    const to = doc.posFromIndex(start + length);
    doc.setSelection(from, to);
    singleEditor.focus();
    singleEditor.scrollIntoView({from, to}, 100);
  }

  function navigateToSearchMatch(match, query) {
    if (!match || typeof match.pageIndex !== 'number') return;
    const idx = match.pageIndex;
    if (idx < 0 || idx >= pagesData.length) return;

    currentPageIdx = idx;
    updatePageNumLabel();

    if (match.field === 'script') {
      renderSingleEditor();
      refreshPreview();
      setTimeout(() => highlightScriptMatch(match, query), 80);
      return;
    }

    const desiredMode = match.field === 'notes' ? 'markdown' : 'latex';
    const needSwitch = currentEditMode !== desiredMode;
    if (needSwitch) {
      setEditMode(desiredMode);
      setTimeout(() => {
        refreshPreview();
        highlightEditorMatch(match, query);
      }, 100);
    } else {
      renderSingleEditor();
      refreshPreview();
      setTimeout(() => highlightEditorMatch(match, query), 80);
    }
  }

  function performProjectSearch(rawQuery) {
    if (searchDebounceTimer) {
      clearTimeout(searchDebounceTimer);
      searchDebounceTimer = null;
    }
    const button = document.getElementById('project-search-btn');
    const query = (rawQuery || '').trim();
    if (searchInputEl && searchInputEl.value !== query) {
      searchInputEl.value = query;
    }

    const modal = ensureSearchModal();
    if (modal) modal.show();

    if (searchAbortController) {
      try {
        searchAbortController.abort();
      } catch (err) {}
      searchAbortController = null;
    }

    if (!query) {
      resetSearchState();
      if (searchInputEl) {
        searchInputEl.focus();
        searchInputEl.removeAttribute('data-loading');
      }
      return;
    }

    searchQueryCache = query;
    setSearchSummary(`正在检索 “${query}”…`, 'muted');
    renderSearchResults([], query);

    if (button) button.disabled = true;
    if (searchInputEl) searchInputEl.setAttribute('data-loading', 'true');

    const controller = new AbortController();
    searchAbortController = controller;
    const requestToken = ++searchRequestId;

    fetch('/search', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({query}),
      signal: controller.signal,
    }).then(async res => {
      if (requestToken !== searchRequestId) return;
      if (button) button.disabled = false;
      if (searchInputEl) searchInputEl.removeAttribute('data-loading');

      if (res.status === 401) {
        handleProjectLocked();
        handleSearchError('项目已加密，请先解锁。');
        return;
      }

      if (!res.ok) {
        let message = `检索失败：HTTP ${res.status}`;
        try {
          const data = await res.json();
          if (data && data.error) message = data.error;
        } catch (err) {
          try {
            const text = await res.text();
            if (text) message = text;
          } catch (_) {}
        }
        handleSearchError(message);
        return;
      }

      const data = await res.json();
      if (requestToken !== searchRequestId) return;

      searchResultsCache = Array.isArray(data.matches) ? data.matches : [];
      renderSearchResults(searchResultsCache, data.query || query);
    }).catch(err => {
      if (requestToken !== searchRequestId) return;
      if (button) button.disabled = false;
      if (searchInputEl) searchInputEl.removeAttribute('data-loading');
      if (err && err.name === 'AbortError') return;
      handleSearchError(err?.message || '检索失败，请稍后再试。');
    });
  }

  function createMenuAction(menu, {id, label, handler, disabled}) {
    const li = document.createElement('li');
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'dropdown-item';
    if(id) btn.id = id;
    btn.textContent = label;
    if(disabled) btn.disabled = true;
    btn.addEventListener('click', () => {
      closeProjectDropdown();
      if(typeof handler === 'function') handler();
    });
    li.dataset.projectAction = 'item';
    li.appendChild(btn);
    menu.appendChild(li);
    return btn;
  }

  function buildProjectMenu(menu, projects){
    menu.innerHTML = '';
    const header = document.createElement('li');
    header.innerHTML = '<h6 class="dropdown-header">项目</h6>';
    menu.appendChild(header);

    if(!projects.length){
      const empty = document.createElement('li');
      empty.innerHTML = '<span class="dropdown-item-text text-muted">无项目</span>';
      menu.appendChild(empty);
    } else {
      projects.forEach(name => {
        const li = document.createElement('li');
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'dropdown-item d-flex justify-content-between align-items-center';
        if(name === currentProject) btn.classList.add('active');
        const label = document.createElement('span');
        label.textContent = name;
        btn.appendChild(label);
        const meta = getProjectMeta(name);
        if(meta.locked){
          const badge = document.createElement('span');
          badge.className = 'badge rounded-pill ' + (meta.unlocked ? 'bg-success' : 'bg-warning text-dark');
          badge.textContent = meta.unlocked ? '已解锁' : '需密码';
          btn.appendChild(badge);
        }
        btn.addEventListener('click', () => {
          menu.querySelectorAll('.dropdown-item').forEach(item => item.classList.remove('active'));
          btn.classList.add('active');
          currentProject = name;
          currentPageIdx = 0;
          handleLearningProjectSwitch(name);
          updateProjectButtonLabel();
          const metaNow = getProjectMeta(name);
          if(metaNow.locked && !metaNow.unlocked){
            closeProjectDropdown();
            showStatus('项目已加密，请输入密码后继续', 'warning', 6000);
            openProjectUnlockModal(name);
            return;
          }
          closeProjectDropdown();
          loadProject();
        });
        li.appendChild(btn);
        menu.appendChild(li);
      });
    }
    renderProjectActionsSection(menu);
  }

  function renderProjectActionsSection(menu){
    if(!menu) return;
    menu.querySelectorAll('[data-project-action]').forEach(node => node.remove());

    const divider = document.createElement('li');
    divider.dataset.projectAction = 'divider';
    divider.innerHTML = '<hr class="dropdown-divider">';
    menu.appendChild(divider);

    const manageHeader = document.createElement('li');
    manageHeader.dataset.projectAction = 'header';
    manageHeader.innerHTML = '<h6 class="dropdown-header">管理</h6>';
    menu.appendChild(manageHeader);

    const currentMeta = getProjectMeta(currentProject);
    const hasProject = !!currentProject;
    const locked = !!currentMeta.locked;
    const unlocked = !!currentMeta.unlocked;

    createMenuAction(menu, {
      id: 'project-action-create',
      label: '新建项目',
      handler: openProjectCreateModal,
      disabled: false,
    });
    createMenuAction(menu, {
      id: 'project-action-rename',
      label: '重命名当前项目',
      handler: () => openProjectRenameModal(currentProject),
      disabled: !hasProject,
    });
    createMenuAction(menu, {
      id: 'project-action-delete',
      label: '删除当前项目',
      handler: () => openProjectDeleteModal(currentProject),
      disabled: !hasProject,
    });
    createMenuAction(menu, {
      id: 'project-action-password',
      label: '设置/修改密码',
      handler: () => openProjectPasswordModal(currentProject),
      disabled: !hasProject,
    });
    createMenuAction(menu, {
      id: 'project-action-unlock',
      label: '解锁当前项目',
      handler: () => {
        if(hasProject){
          showStatus('请输入密码解锁项目', 'info', 5000);
          openProjectUnlockModal(currentProject);
        }
      },
      disabled: !(hasProject && locked && !unlocked),
    });
    createMenuAction(menu, {
      id: 'project-action-lock',
      label: '锁定当前项目',
      handler: lockCurrentProject,
      disabled: !(hasProject && locked && unlocked),
    });
  }

  async function refreshOssSyncModal(){
    if(!ossSyncModalEl) return;
    if(ossSyncStatusBox) ossSyncStatusBox.textContent = '加载中...';
    try{
      const res = await fetch('/oss/status');
      const parsed = await parseJsonSafe(res);
      const payload = parsed.json || {};
      if(!(res.ok && payload.success !== false)){
        const errorMsg = (payload.error) ? payload.error : (parsed.text || `HTTP ${res.status}`);
        if(ossSyncStatusBox) ossSyncStatusBox.textContent = `获取状态失败：${errorMsg}`;
        if(ossSyncToggleMain){
          ossSyncToggleMain.disabled = true;
          ossSyncToggleMain.checked = false;
        }
        if(ossSyncWarningMain){
          ossSyncWarningMain.classList.remove('d-none');
          ossSyncWarningMain.textContent = '无法读取 OSS 状态';
        }
        if(ossSyncRunBtn) ossSyncRunBtn.disabled = true;
        return;
      }

      const configured = !!payload.ossConfigured;
      const enabled = !!payload.syncEnabled && configured;

      if(ossSyncToggleMain){
        ossSyncToggleMain.dataset.configured = configured ? 'true' : 'false';
        ossSyncToggleMain.disabled = !configured;
        ossSyncToggleMain.checked = enabled;
      }
      if(ossSyncRunBtn){
        ossSyncRunBtn.disabled = !configured;
      }

      if(ossSyncWarningMain){
        if(!configured){
          ossSyncWarningMain.classList.remove('d-none');
          ossSyncWarningMain.textContent = '未检测到 OSS 配置，所有文件仅保存在本地。';
        } else {
          ossSyncWarningMain.classList.add('d-none');
          ossSyncWarningMain.textContent = '';
        }
      }

      if(ossSyncAttachments) ossSyncAttachments.textContent = payload.attachmentsPath || '未知';
      if(ossSyncResources) ossSyncResources.textContent = payload.resourcesPath || '未知';
      if(ossSyncYaml) ossSyncYaml.textContent = payload.yamlPath || '未生成';

      if(ossSyncStatusBox){
        const statusParts = [];
        statusParts.push(configured ? (enabled ? '同步已开启' : '同步已关闭') : 'OSS 未配置');
        if(payload.project) statusParts.push(`项目：${payload.project}`);
        if(payload.message) statusParts.push(payload.message);
        ossSyncStatusBox.textContent = statusParts.join('；') || '状态未知';
      }
    }catch(e){
      if(ossSyncStatusBox) ossSyncStatusBox.textContent = `获取状态失败：${e.message}`;
      if(ossSyncToggleMain){
        ossSyncToggleMain.disabled = true;
        ossSyncToggleMain.checked = false;
      }
      if(ossSyncRunBtn) ossSyncRunBtn.disabled = true;
      if(ossSyncWarningMain){
        ossSyncWarningMain.classList.remove('d-none');
        ossSyncWarningMain.textContent = '无法连接服务器获取同步状态';
      }
    }
  }


  function updateModeToggleUI() {
    const switchBtn = document.getElementById('mode-switch-btn');
    if (!switchBtn) return;
    const isMarkdown = currentEditMode === 'markdown';
    switchBtn.textContent = isMarkdown ? 'Markdown 模式' : 'LaTeX 模式';
    switchBtn.setAttribute('aria-pressed', isMarkdown ? 'true' : 'false');
    switchBtn.title = isMarkdown ? '当前为 Markdown 编辑，点击切换至 LaTeX' : '当前为 LaTeX 编辑，点击切换至 Markdown';
    switchBtn.classList.toggle('btn-primary', isMarkdown);
    switchBtn.classList.toggle('btn-outline-primary', !isMarkdown);
  }

  function showStatus(message, type = 'info', timeout = 4000) {
    const area = document.getElementById('status-area');
    if (!area) return;
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show shadow`;
    alertDiv.setAttribute('role', 'alert');
    alertDiv.textContent = message;
    area.appendChild(alertDiv);
    setTimeout(() => {
      alertDiv.classList.remove('show');
      alertDiv.classList.add('fade');
      setTimeout(() => alertDiv.remove(), 200);
    }, timeout);
  }

  async function exportTex() {
    try {
      const res = await fetch('/export_tex');
      if (!res.ok) {
        const parsed = await parseJsonSafe(res);
        const message = (parsed.json && parsed.json.error) ? parsed.json.error : (parsed.text || `HTTP ${res.status}`);
        showStatus('导出 TeX 失败：' + message, 'danger', 6000);
        return;
      }
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'exported_full.tex';
      document.body.appendChild(link);
      link.click();
      link.remove();
      URL.revokeObjectURL(url);
      showStatus('TeX 导出完成', 'success', 2500);
    } catch (err) {
      console.error('导出 TeX 失败', err);
      showStatus('导出 TeX 失败：' + (err?.message || '未知错误'), 'danger', 6000);
    }
  }

  function updateProjectButtonLabel() {
    const btn = document.getElementById('project-dropdown');
    if (!btn) return;
    if(!currentProject){
      btn.textContent = 'Benort';
      renderProjectActionsSection(document.getElementById('project-menu'));
      return;
    }
    const meta = getProjectMeta(currentProject);
    let suffix = '';
    if(meta.locked){
      suffix = meta.unlocked ? '（已解锁）' : '（已加密）';
    }
    btn.textContent = `Benort · ${currentProject}${suffix}`;
    renderProjectActionsSection(document.getElementById('project-menu'));
  }

  function normalizeTemplateText(text) {
    return (text || '').replace(/\r\n/g, '\n').trim();
  }

  function normalizeCssText(text) {
    return (text || '').replace(/\r\n/g, '\n').trim();
  }

  function detectCurrentTemplate(mode) {
    if (!templatesLoaded) return;
    if (mode === 'markdown') {
      const css = normalizeCssText(markdownTemplate.css);
      const wrapper = (markdownTemplate.wrapperClass || '').trim();
      const match = (availableTemplates.markdown || []).find(t =>
        normalizeCssText(t.css) === css &&
        (t.wrapperClass || '') === wrapper
      );
      selectedTemplateName.markdown = match ? match.name : '';
      return;
    }

    const header = normalizeTemplateText(latexTemplate.header);
    const before = normalizeTemplateText(latexTemplate.beforePages);
    const footer = normalizeTemplateText(latexTemplate.footer);
    const match = (availableTemplates.latex || []).find(t =>
      normalizeTemplateText(t.header) === header &&
      normalizeTemplateText(t.beforePages) === before &&
      normalizeTemplateText(t.footer) === footer
    );
    selectedTemplateName.latex = match ? match.name : '';
  }

  function detectAllTemplates() {
    detectCurrentTemplate('latex');
    detectCurrentTemplate('markdown');
  }

  function ensureTemplatesLoaded() {
    if (templatesLoaded) return Promise.resolve(availableTemplates);
    return fetch('/templates/list')
      .then(res => res.json())
      .then(data => {
        const templates = data.templates;
        if (templates && typeof templates === 'object') {
          availableTemplates = {
            latex: Array.isArray(templates.latex) ? templates.latex : [],
            markdown: Array.isArray(templates.markdown) ? templates.markdown : [],
          };
        } else {
          // 兼容旧结构
          const fallbackList = Array.isArray(templates) ? templates : [];
          availableTemplates = {
            latex: fallbackList,
            markdown: [],
          };
        }
        templatesLoaded = true;
        detectAllTemplates();
        return availableTemplates;
      })
      .catch(err => {
        showStatus('加载模板列表失败：' + (err?.message || '未知错误'), 'danger', 6000);
        throw err;
      });
  }

  function populateTemplateSelect(mode) {
    const select = document.getElementById('template-select');
    if (!select) return;
    const groups = mode === 'markdown' ? (availableTemplates.markdown || []) : (availableTemplates.latex || []);
    const currentValue = selectedTemplateName[mode] || '';
    select.innerHTML = '';
    const customOption = document.createElement('option');
    customOption.value = '';
    customOption.textContent = '自定义（当前模板）';
    select.appendChild(customOption);
    groups.forEach(t => {
      const opt = document.createElement('option');
      opt.value = t.name;
      opt.textContent = t.name;
      select.appendChild(opt);
    });
    select.value = currentValue;
  }

  function applyTemplateByName(name, mode) {
    const list = mode === 'markdown' ? (availableTemplates.markdown || []) : (availableTemplates.latex || []);
    const tmpl = list.find(t => t.name === name);
    if (!tmpl) return;
    if (mode === 'markdown') {
      document.getElementById('template-markdown-css').value = tmpl.css || '';
      document.getElementById('template-markdown-wrapper').value = tmpl.wrapperClass || '';
      selectedTemplateName.markdown = name;
    } else {
      document.getElementById('template-header').value = tmpl.header || '';
      document.getElementById('template-before-pages').value = tmpl.beforePages || '';
      document.getElementById('template-footer').value = tmpl.footer || '';
      selectedTemplateName.latex = name;
    }
  }

  function applyMarkdownStyles() {
    const styleId = 'markdown-template-style';
    const head = document.head || document.getElementsByTagName('head')[0];
    if (head) {
      let styleEl = document.getElementById(styleId);
      if (!styleEl) {
        styleEl = document.createElement('style');
        styleEl.id = styleId;
        head.appendChild(styleEl);
      }
      styleEl.textContent = markdownTemplate.css || '';
    }
    const previewRoot = document.getElementById('markdown-preview-content');
    if (previewRoot) {
      const baseClasses = ['markdown-preview-content', 'mt-4'];
      const extra = (markdownTemplate.wrapperClass || '').trim();
      const classSet = new Set(baseClasses);
      if (extra) {
        extra.split(/\s+/).filter(Boolean).forEach(cls => classSet.add(cls));
      }
      previewRoot.className = Array.from(classSet).join(' ');
    }
  }

  function getMarkdownImageModal() {
    const modalEl = document.getElementById('markdownImageModal');
    if (!modalEl || !window.bootstrap || !window.bootstrap.Modal) {
      return null;
    }
    if (!markdownImageModalInstance) {
      markdownImageModalInstance = new window.bootstrap.Modal(modalEl);
    }
    if (!modalEl.dataset.markdownModalBound) {
      modalEl.addEventListener('hidden.bs.modal', () => {
        const modalImg = document.getElementById('markdownImageModalImg');
        const captionEl = document.getElementById('markdownImageCaption');
        if (modalImg) {
          modalImg.removeAttribute('src');
          modalImg.removeAttribute('srcset');
          modalImg.alt = '';
        }
        if (captionEl) {
          captionEl.textContent = '';
          captionEl.classList.add('d-none');
        }
      });
      modalEl.dataset.markdownModalBound = '1';
    }
    return markdownImageModalInstance;
  }

  function getMarkdownTableModal() {
    const modalEl = document.getElementById('markdownTableModal');
    if (!modalEl || !window.bootstrap || !window.bootstrap.Modal) {
      return null;
    }
    if (!markdownTableModalInstance) {
      markdownTableModalInstance = new window.bootstrap.Modal(modalEl);
    }
    if (!modalEl.dataset.markdownTableBound) {
      modalEl.addEventListener('hidden.bs.modal', () => {
        const body = document.getElementById('markdownTableModalBody');
        const caption = document.getElementById('markdownTableModalCaption');
        if (body) {
          body.innerHTML = '';
        }
        if (caption) {
          caption.textContent = '';
          caption.classList.add('d-none');
        }
      });
      modalEl.dataset.markdownTableBound = '1';
    }
    return markdownTableModalInstance;
  }

  function openTableInModal(table) {
    if (!table) return;
    const modalInstance = getMarkdownTableModal();
    const body = document.getElementById('markdownTableModalBody');
    const captionEl = document.getElementById('markdownTableModalCaption');
    if (!modalInstance || !body) return;
    body.innerHTML = '';
    const clonedTable = table.cloneNode(true);
    clonedTable.removeAttribute('id');
    clonedTable.removeAttribute('data-markdown-preview-table-enhanced');
    Array.from(clonedTable.querySelectorAll('[data-markdown-preview-table-enhanced]')).forEach(node => {
      node.removeAttribute('data-markdown-preview-table-enhanced');
    });
    Array.from(clonedTable.querySelectorAll('button.markdown-table-expand-btn')).forEach(btn => btn.remove());
    body.appendChild(clonedTable);
    if (captionEl) {
      const caption = table.querySelector('caption');
      if (caption && caption.textContent.trim()) {
        captionEl.textContent = caption.textContent.trim();
        captionEl.classList.remove('d-none');
      } else {
        captionEl.textContent = '';
        captionEl.classList.add('d-none');
      }
    }
    modalInstance.show();
  }

  function enhanceMarkdownImages(container) {
    if (!container) return;
    const modalEl = document.getElementById('markdownImageModal');
    const modalImg = document.getElementById('markdownImageModalImg');
    const captionEl = document.getElementById('markdownImageCaption');
    if (!modalEl || !modalImg) return;
    container.querySelectorAll('img').forEach(img => {
      if (!(img instanceof HTMLImageElement)) return;
      if (img.dataset.markdownPreviewEnhanced === '1') return;
      img.dataset.markdownPreviewEnhanced = '1';
      if (!img.getAttribute('loading')) {
        img.setAttribute('loading', 'lazy');
      }
      if (!img.getAttribute('decoding')) {
        img.setAttribute('decoding', 'async');
      }
      img.classList.add('markdown-preview-image');
      if (!img.hasAttribute('tabindex')) {
        img.setAttribute('tabindex', '0');
      }
      if (!img.hasAttribute('role')) {
        img.setAttribute('role', 'button');
      }
      const openModal = event => {
        if (event) {
          event.preventDefault();
          event.stopPropagation();
        }
        const modalInstance = getMarkdownImageModal();
        if (!modalInstance) return;
        const source = img.currentSrc || img.src || img.getAttribute('data-src');
        if (source) {
          modalImg.src = source;
        } else {
          modalImg.removeAttribute('src');
        }
        if (img.srcset) {
          modalImg.srcset = img.srcset;
        } else {
          modalImg.removeAttribute('srcset');
        }
        const altText = img.getAttribute('alt') || img.getAttribute('title') || '';
        modalImg.alt = altText || '';
        if (captionEl) {
          if (altText) {
            captionEl.textContent = altText;
            captionEl.classList.remove('d-none');
          } else {
            captionEl.textContent = '';
            captionEl.classList.add('d-none');
          }
        }
        modalInstance.show();
      };
      img.addEventListener('click', openModal);
      img.addEventListener('keydown', event => {
        if (event.key === 'Enter' || event.key === ' ') {
          openModal(event);
        }
      });
      const parentLink = img.closest('a');
      if (parentLink) {
        parentLink.addEventListener('click', event => {
          if (event.target === img || event.currentTarget === event.target) {
            openModal(event);
          }
        });
        parentLink.addEventListener('keydown', event => {
          if (event.key === 'Enter' || event.key === ' ') {
            openModal(event);
          }
        });
      }
    });
  }

  function enhanceMarkdownTables(container) {
    if (!container) return;
    container.querySelectorAll('table').forEach(table => {
      if (!(table instanceof HTMLTableElement)) return;
      if (table.dataset.markdownPreviewTableEnhanced === '1') {
        return;
      }
      table.dataset.markdownPreviewTableEnhanced = '1';
      let wrapper = table.closest('.markdown-preview-table-wrapper');
      if (!wrapper) {
        wrapper = document.createElement('div');
        wrapper.className = 'markdown-preview-table-wrapper';
        table.parentNode.insertBefore(wrapper, table);
        wrapper.appendChild(table);
      }
      if (!wrapper.getAttribute('tabindex')) {
        wrapper.setAttribute('tabindex', '0');
      }
      if (!wrapper.hasAttribute('role')) {
        wrapper.setAttribute('role', 'region');
      }
      if (!wrapper.hasAttribute('aria-label')) {
        wrapper.setAttribute('aria-label', '表格预览区域，可滚动，按 Enter 放大查看');
      }
      if (!wrapper.dataset.markdownTableHotkeyBound) {
        wrapper.addEventListener('keydown', event => {
          if ((event.key === 'Enter' || event.key === ' ') && event.target === wrapper) {
            event.preventDefault();
            openTableInModal(table);
          }
        });
        wrapper.dataset.markdownTableHotkeyBound = '1';
      }
      let expandBtn = wrapper.querySelector('.markdown-table-expand-btn');
      if (!expandBtn) {
        expandBtn = document.createElement('button');
        expandBtn.type = 'button';
        expandBtn.className = 'markdown-table-expand-btn';
        expandBtn.innerHTML = '<span class="fw-semibold">放大表格</span>';
        expandBtn.title = '放大查看完整表格 (Enter)';
        expandBtn.setAttribute('aria-label', '放大查看完整表格');
        expandBtn.addEventListener('click', event => {
          event.preventDefault();
          openTableInModal(table);
        });
        wrapper.appendChild(expandBtn);
      }
    });
  }

  function applyNavbarTheme() {
    const theme = window.BENORT_UI_THEME || {};
    const config = theme.navbar_buttons || {};
    const preset = (config.preset || 'modern').toLowerCase();
    const colorMode = (theme.color_mode || 'light').toLowerCase();
    const style = (config.style || 'uniform').toLowerCase();
    const variant = (config.variant || 'outline').toLowerCase() === 'solid' ? 'solid' : 'outline';
    const palette = Array.isArray(config.palette) && config.palette.length ? config.palette : ['primary', 'success', 'warning', 'danger', 'info', 'secondary'];
    const uniformColor = (config.color || palette[0] || 'primary').toLowerCase();
    const colorClassPattern = /^btn(?:-outline)?-(primary|secondary|success|danger|warning|info|light|dark)$/;
    const paletteLight = {
      primary: { bg: '#2563eb', hover: '#1d4ed8', text: '#ffffff', border: '#1d4ed8', outlineHover: 'rgba(37, 99, 235, 0.12)' },
      success: { bg: '#16a34a', hover: '#15803d', text: '#ffffff', border: '#15803d', outlineHover: 'rgba(34, 197, 94, 0.12)' },
      warning: { bg: '#f59e0b', hover: '#d97706', text: '#1f2937', border: '#d97706', outlineHover: 'rgba(245, 158, 11, 0.18)' },
      danger: { bg: '#ef4444', hover: '#dc2626', text: '#ffffff', border: '#dc2626', outlineHover: 'rgba(248, 113, 113, 0.18)' },
      info: { bg: '#0ea5e9', hover: '#0284c7', text: '#ffffff', border: '#0284c7', outlineHover: 'rgba(14, 165, 233, 0.15)' },
      secondary: { bg: '#64748b', hover: '#475569', text: '#ffffff', border: '#475569', outlineHover: 'rgba(100, 116, 139, 0.18)' },
      dark: { bg: '#1f2937', hover: '#111827', text: '#f8fafc', border: '#111827', outlineHover: 'rgba(15, 23, 42, 0.12)' }
    };
    const paletteDark = {
      primary: { bg: '#1d4ed8', hover: '#2563eb', text: '#dbeafe', border: '#3b82f6', outlineHover: 'rgba(59, 130, 246, 0.18)' },
      success: { bg: '#166534', hover: '#17813f', text: '#bbf7d0', border: '#34d399', outlineHover: 'rgba(52, 211, 153, 0.2)' },
      warning: { bg: '#9a4f06', hover: '#c97a0e', text: '#fde68a', border: '#fbbf24', outlineHover: 'rgba(251, 191, 36, 0.22)' },
      danger: { bg: '#991b1b', hover: '#c81e1e', text: '#fecaca', border: '#f87171', outlineHover: 'rgba(248, 113, 113, 0.24)' },
      info: { bg: '#0f4c81', hover: '#1f6ad9', text: '#bae6fd', border: '#60a5fa', outlineHover: 'rgba(96, 165, 250, 0.24)' },
      secondary: { bg: '#283347', hover: '#3b465e', text: '#f8fafc', border: '#94a3b8', outlineHover: 'rgba(148, 163, 184, 0.22)' },
      dark: { bg: '#111827', hover: '#1c2940', text: '#e2e8f0', border: '#334155', outlineHover: 'rgba(148, 163, 184, 0.2)' }
    };
    const paletteTokens = colorMode === 'dark' ? paletteDark : paletteLight;
    const fallbackTokens = paletteTokens.primary;
    const resolveTokens = name => {
      const key = name && paletteTokens[name] ? name : 'primary';
      return paletteTokens[key] || fallbackTokens;
    };
    const buttons = document.querySelectorAll('.js-nav-btn');
    if (!buttons.length) return;
    buttons.forEach((btn, idx) => {
      const classes = Array.from(btn.classList);
      classes.forEach(cls => {
        if (colorClassPattern.test(cls)) {
          btn.classList.remove(cls);
        }
      });
      btn.classList.remove('btn-theme');
      ['--btn-bg', '--btn-hover', '--btn-text', '--btn-border', '--btn-outline-hover'].forEach(prop => btn.style.removeProperty(prop));
      btn.style.removeProperty('color');
      btn.style.removeProperty('background');
      btn.style.removeProperty('border-color');
      const explicitVariant = (btn.dataset.themeVariant || '').toLowerCase();
      const resolvedVariant = explicitVariant === 'solid' || explicitVariant === 'outline' ? explicitVariant : variant;
      const sourceColor = btn.dataset.themeColor || (style === 'palette' ? palette[idx % palette.length] : uniformColor) || 'primary';
      const normalized = sourceColor.trim().toLowerCase() || 'primary';
      const tokens = resolveTokens(normalized);
      const textColor = resolvedVariant === 'solid' ? tokens.text : tokens.border;
      const outlineHover = tokens.outlineHover || (colorMode === 'dark' ? 'rgba(148, 163, 184, 0.16)' : 'rgba(15, 23, 42, 0.08)');
      const applyModern = preset === 'modern' || preset === 'neo';
      if (applyModern) {
        btn.classList.add('btn', 'btn-theme');
        btn.style.setProperty('--btn-bg', tokens.bg);
        btn.style.setProperty('--btn-hover', tokens.hover);
        btn.style.setProperty('--btn-text', textColor);
        btn.style.setProperty('--btn-border', tokens.border);
        btn.style.setProperty('--btn-outline-hover', outlineHover);
        btn.dataset.themeActiveVariant = resolvedVariant;
        btn.dataset.themeActiveColor = normalized;
      } else {
        btn.removeAttribute('data-theme-active-variant');
        btn.removeAttribute('data-theme-active-color');
        const bootstrapClass = resolvedVariant === 'solid' ? `btn-${normalized}` : `btn-outline-${normalized}`;
        btn.classList.add('btn', bootstrapClass);
      }
    });
  }

  function renderMarkdownPreview() {
    const wrapper = document.getElementById('markdown-preview');
    const preview = document.getElementById('markdown-preview-content') || wrapper;
    if (!wrapper || !preview) return;
    const md = pagesData[currentPageIdx]?.notes || '';
    applyMarkdownStyles();
    if (md.trim()) {
      preview.innerHTML = marked.parse(md);
    } else {
      preview.innerHTML = '<p class="text-muted mb-0">暂无 Markdown 内容</p>';
    }
    enhanceMarkdownHeadingAnchors(preview, wrapper);
    enhanceMarkdownImages(preview);
    enhanceMarkdownTables(preview);
    if (window.hljs && preview.querySelectorAll) {
      preview.querySelectorAll('pre code').forEach(block => {
        hljs.highlightElement(block);
      });
    }
    enhanceCodeCopy(preview);
    if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
      try {
        if (typeof window.MathJax.typesetClear === 'function') {
          window.MathJax.typesetClear([preview]);
        }
      } catch (err) {
        console.warn('清理 MathJax 队列失败', err);
      }
      window.MathJax.typesetPromise([preview])
        .then(() => enhanceMathCopy(preview))
        .catch(err => console.warn('MathJax 渲染失败', err));
    }
  }

  function safeDecodeURIComponent(value) {
    if (typeof value !== 'string') return '';
    try {
      return decodeURIComponent(value);
    } catch (_) {
      return value;
    }
  }

  function cssEscapeIdent(value) {
    if (typeof value !== 'string') return '';
    if (window.CSS && typeof window.CSS.escape === 'function') {
      try {
        return window.CSS.escape(value);
      } catch (_) {
        return value;
      }
    }
    return value;
  }

  function slugifyMarkdownHeading(text, registry) {
    const raw = typeof text === 'string' ? text.trim() : '';
    if (!raw) return '';
    const normalized = typeof raw.normalize === 'function' ? raw.normalize('NFKC') : raw;
    let slug = normalized.replace(/\s+/g, '-');
    slug = slug.replace(/[\u0000-\u001F\u007F]/g, '');
    slug = slug.replace(/[^A-Za-z0-9\u00C0-\uFFFD\-_]/g, '');
    slug = slug.replace(/-+/g, '-').replace(/^-+|-+$/g, '');
    if (!slug) {
      slug = 'heading';
    }
    const base = slug.toLowerCase();
    if (!registry[base] && registry[base] !== 0) {
      registry[base] = 0;
      return base;
    }
    registry[base] += 1;
    return `${base}-${registry[base]}`;
  }

  function getMarkdownScrollContainer(preview, wrapper) {
    if (wrapper && typeof wrapper.scrollTop === 'number') return wrapper;
    if (preview && typeof preview.scrollTop === 'number') return preview;
    return null;
  }

  function focusMarkdownHeading(headingId, {silent = false, instant = false} = {}) {
    if (!headingId) return false;
    const preview = document.getElementById('markdown-preview-content');
    const wrapper = document.getElementById('markdown-preview');
    if (!preview) return false;
    const attemptSelect = (id) => {
      if (!id) return null;
      const selector = `[id="${cssEscapeIdent(id)}"]`;
      return preview.querySelector(selector) || document.getElementById(id);
    };
    let target = attemptSelect(headingId);
    if (!target && headingId) {
      const fallbackId = slugifyMarkdownHeading(headingId, Object.create(null));
      if (fallbackId) {
        target = attemptSelect(fallbackId);
      }
    }
    if (!target) {
      if (!silent && typeof showStatus === 'function') {
        showStatus(`未找到标题 “${headingId}”`, 'warning', 2600);
      }
      return false;
    }

    const scrollContainer = getMarkdownScrollContainer(preview, wrapper);
    if (scrollContainer) {
      const containerRect = scrollContainer.getBoundingClientRect();
      const targetRect = target.getBoundingClientRect();
      const delta = targetRect.top - containerRect.top;
      const desired = scrollContainer.scrollTop + delta - 16;
      if (typeof scrollContainer.scrollTo === 'function') {
        scrollContainer.scrollTo({top: Math.max(desired, 0), behavior: instant ? 'auto' : 'smooth'});
      } else {
        scrollContainer.scrollTop = Math.max(desired, 0);
      }
    } else if (typeof target.scrollIntoView === 'function') {
      target.scrollIntoView({behavior: instant ? 'auto' : 'smooth', block: 'start', inline: 'nearest'});
    }

    if (markdownHeadingActiveEl && markdownHeadingActiveEl !== target) {
      markdownHeadingActiveEl.classList.remove('markdown-heading-highlight');
    }
    markdownHeadingActiveEl = target;
    target.classList.add('markdown-heading-highlight');
    if (markdownHeadingHighlightTimer) {
      clearTimeout(markdownHeadingHighlightTimer);
    }
    markdownHeadingHighlightTimer = setTimeout(() => {
      if (markdownHeadingActiveEl) {
        markdownHeadingActiveEl.classList.remove('markdown-heading-highlight');
        markdownHeadingActiveEl = null;
      }
    }, instant ? 1200 : 2200);
    return true;
  }

  function findPageIndexById(pageId) {
    if (!pageId) return -1;
    const normalized = String(pageId).trim().toLowerCase();
    if (!normalized) return -1;
    for (let idx = 0; idx < pagesData.length; idx++) {
      const page = pagesData[idx];
      if (!page || typeof page !== 'object') continue;
      const rawPid = typeof page.pageId === 'string' ? page.pageId : '';
      const normalizedPid = rawPid ? rawPid.trim().toLowerCase() : '';
      if (normalizedPid && normalizedPid === normalized) {
        return idx;
      }
    }
    return -1;
  }

  function parseMarkdownInternalLink(href) {
    if (typeof href !== 'string') return null;
    let trimmed = href.trim();
    if (!trimmed) return null;

    if (/^(?:https?:|mailto:|tel:|ftp:|file:|data:|\/\/)/i.test(trimmed)) {
      return null;
    }

    if (trimmed.startsWith('#')) {
      const headingId = safeDecodeURIComponent(trimmed.slice(1));
      return headingId ? {headingId, pageIndex: null, pageId: null} : null;
    }

    let working = trimmed;
    if (working.startsWith('./')) working = working.slice(2);
    working = working.replace(/^\/+/, '');

    const hashIndex = working.indexOf('#');
    let headingId = '';
    if (hashIndex !== -1) {
      headingId = safeDecodeURIComponent(working.slice(hashIndex + 1));
      working = working.slice(0, hashIndex);
    }

    if (!working) {
      return headingId ? {headingId, pageIndex: null, pageId: null} : null;
    }

    working = safeDecodeURIComponent(working);
    if (working.startsWith('?')) working = working.slice(1);
    working = working.replace(/\.md$/i, '');

    let pageIndex = null;
    let pageId = null;

    if (working.includes('=')) {
      try {
        const params = new URLSearchParams(working);
        const mapped = Object.create(null);
        params.forEach((value, key) => {
          if (typeof key === 'string') {
            mapped[key.toLowerCase()] = value;
          }
        });
        const getParam = (...keys) => {
          for (const key of keys) {
            const lookup = key.toLowerCase();
            if (Object.prototype.hasOwnProperty.call(mapped, lookup)) {
              return mapped[lookup];
            }
          }
          return undefined;
        };

        const pageParam = getParam('page', 'p');
        if (pageParam !== undefined) {
          const parsed = parseInt(pageParam, 10);
          if (!Number.isNaN(parsed)) pageIndex = parsed - 1;
        }
        const pageIndexParam = getParam('pageindex', 'page_idx', 'index');
        if (pageIndexParam !== undefined) {
          const parsed = parseInt(pageIndexParam, 10);
          if (!Number.isNaN(parsed)) pageIndex = parsed - 1;
        }
        const pageIdParam = getParam('pageid', 'page_id', 'pid', 'id');
        if (pageIdParam !== undefined && pageIdParam !== null) {
          const trimmedPid = String(pageIdParam).trim();
          if (trimmedPid) {
            pageId = trimmedPid;
          }
        }
        if (!headingId) {
          const headingParam = getParam('heading', 'title', 'h');
          if (headingParam !== undefined && headingParam !== null) {
            headingId = String(headingParam).trim();
          }
        }
      } catch (_) {
        // ignore parsing failure, fall back to pattern matching
      }
    }

    if (pageIndex === null && !pageId) {
      let match = working.match(/^(?:page[-_]?|p)(\d+)$/i);
      if (match) {
        pageIndex = parseInt(match[1], 10) - 1;
      } else {
        match = working.match(/^(\d+)$/);
        if (match) {
          pageIndex = parseInt(match[1], 10) - 1;
        } else {
          match = working.match(/^page(?:Id)?[-_:]?([0-9a-f]{32})$/i);
          if (match) {
            pageId = match[1];
          } else {
            match = working.match(/^page(?:Id)?[-_:]?(.+)$/i);
            if (match) {
              const candidate = match[1].trim();
              if (candidate) {
                pageId = candidate;
              }
            } else {
              match = working.match(/^([0-9a-f]{32})$/i);
              if (match) {
                pageId = match[1];
              } else if (!headingId) {
                const candidate = working.trim();
                if (candidate) {
                  // Treat plain text as same-page heading reference
                  return {headingId: candidate, pageIndex: null, pageId: null};
                }
              }
            }
          }
        }
      }
    }

    if (pageIndex !== null && (Number.isNaN(pageIndex) || pageIndex < 0)) {
      pageIndex = null;
    }
    if (!headingId) headingId = '';
    if (!pageId && pageIndex === null) {
      return {headingId, pageIndex: null, pageId: null};
    }
    return {headingId, pageIndex, pageId};
  }

  function navigateMarkdownLinkTarget(target) {
    if (!target) return false;
    const {pageIndex, pageId, headingId} = target;
    if (pageIndex === null && !pageId) {
      if (!headingId) return false;
      return focusMarkdownHeading(headingId, {silent: false});
    }

    let idx = null;
    if (typeof pageIndex === 'number' && pageIndex >= 0 && pageIndex < pagesData.length) {
      idx = pageIndex;
    }
    if (idx === null && pageId) {
      const found = findPageIndexById(pageId);
      if (found !== -1) {
        idx = found;
      }
    }
    if (idx === null || idx < 0 || idx >= pagesData.length) {
      if (typeof showStatus === 'function') {
        showStatus('未找到目标页面', 'warning', 2600);
      }
      return false;
    }

    const performHighlight = () => {
      if (headingId) {
        if (!focusMarkdownHeading(headingId, {silent: true})) {
          if (typeof showStatus === 'function') {
            showStatus(`未找到标题 “${headingId}”`, 'warning', 2600);
          }
        }
      } else {
        const container = document.getElementById('markdown-preview');
        if (container) {
          if (typeof container.scrollTo === 'function') container.scrollTo({top: 0, behavior: 'smooth'});
          else container.scrollTop = 0;
        }
      }
    };

    if (idx === currentPageIdx && currentEditMode === 'markdown') {
      performHighlight();
      return true;
    }

    const needsModeSwitch = currentEditMode !== 'markdown';
    currentPageIdx = idx;
    updatePageNumLabel();
    if (needsModeSwitch) {
      setEditMode('markdown');
    } else {
      renderSingleEditor();
    }
    const delay = needsModeSwitch ? 280 : 160;
    setTimeout(() => {
      if (currentPageIdx !== idx) return;
      performHighlight();
    }, delay);
    return true;
  }

  function handleMarkdownPreviewLinkClick(event) {
    if (event.defaultPrevented) return;
    if (event.button !== 0) return;
    if (event.metaKey || event.ctrlKey || event.shiftKey || event.altKey) return;
    const anchor = event.target.closest('a[href]');
    if (!anchor) return;
    if (anchor.target && anchor.target.toLowerCase() === '_blank') return;
    const href = anchor.getAttribute('href');
    if (!href) return;
    const target = parseMarkdownInternalLink(href);
    if (!target) return;
    event.preventDefault();
    navigateMarkdownLinkTarget(target);
  }

  function applyInitialDeepLinkIfNeeded() {
    if (initialDeepLinkApplied) return;
    if (!initialDeepLinkTarget) {
      initialDeepLinkApplied = true;
      return;
    }
    const handled = navigateMarkdownLinkTarget(initialDeepLinkTarget);
    if (!handled && initialDeepLinkTarget.headingId) {
      focusMarkdownHeading(initialDeepLinkTarget.headingId, {silent: true, instant: true});
    }
    initialDeepLinkTarget = null;
    initialDeepLinkApplied = true;
  }

  function enhanceMarkdownHeadingAnchors(preview, wrapper) {
    if (!preview) return;
    if (markdownHeadingHighlightTimer) {
      clearTimeout(markdownHeadingHighlightTimer);
      markdownHeadingHighlightTimer = null;
    }
    markdownHeadingActiveEl = null;
    const slugRegistry = Object.create(null);
    const headings = preview.querySelectorAll('h1, h2, h3, h4, h5, h6');
    headings.forEach(heading => {
      if (!(heading instanceof HTMLElement)) return;
      const currentId = (heading.getAttribute('id') || '').trim();
      const sourceText = heading.textContent ? heading.textContent.trim() : '';
      if (sourceText && !heading.dataset.markdownHeadingText) {
        heading.dataset.markdownHeadingText = sourceText;
      }
      const source = currentId || sourceText || '';
      const slug = slugifyMarkdownHeading(source, slugRegistry);
      if (!slug) return;
      heading.id = slug;
      heading.dataset.markdownHeadingId = slug;
      attachHeadingCopyControl(heading);
    });
    if (!preview.dataset.markdownLinksBound) {
      preview.addEventListener('click', handleMarkdownPreviewLinkClick);
      preview.dataset.markdownLinksBound = '1';
    }
    const container = getMarkdownScrollContainer(preview, wrapper);
    if (container && !container.dataset.markdownLinksBound) {
      container.dataset.markdownLinksBound = '1';
    }
  }

  function buildMarkdownHeadingLinkSnippet(heading) {
    if (!heading) return null;
    const page = pagesData[currentPageIdx] || {};
    const pageId = typeof page.pageId === 'string' ? page.pageId.trim() : '';
    if (!pageId) return null;
    const slug = ((heading.dataset && heading.dataset.markdownHeadingId) || heading.id || '').trim();
    if (!slug) return null;
    return `[跳转到目标页](?pageId=${pageId}#${slug})`;
  }

  async function copyMarkdownHeadingLink(heading) {
    const snippet = buildMarkdownHeadingLinkSnippet(heading);
    if (!snippet) {
      showStatus('无法生成标题链接，请稍后再试', 'warning', 3200);
      return;
    }
    const ok = await copyTextToClipboard(snippet);
    if (ok) {
      showStatus('跳转链接已复制', 'success', 2400);
    } else {
      window.prompt('当前浏览器无法自动复制，请手动复制链接：', snippet);
    }
  }

  function attachHeadingCopyControl(heading) {
    if (!heading || heading.dataset.headingCopyAttached === '1') return;
    heading.dataset.headingCopyAttached = '1';
    heading.classList.add('markdown-heading-with-copy');
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'markdown-heading-copy-btn';
    btn.textContent = '复制链接';
    btn.title = '复制跳转 Markdown 链接';
    btn.addEventListener('click', (event) => {
      event.preventDefault();
      event.stopPropagation();
      copyMarkdownHeadingLink(heading);
    });
    heading.appendChild(btn);
  }

  async function copyCurrentPageIdToClipboard() {
    const page = pagesData[currentPageIdx] || {};
    const rawId = typeof page.pageId === 'string' ? page.pageId.trim() : '';
    if (!rawId) {
      showStatus('当前页缺少 pageId，无法复制', 'warning', 3200);
      return;
    }
    const ok = await copyTextToClipboard(rawId);
    if (ok) {
      showStatus('pageId 已复制到剪贴板', 'success', 2400);
    } else {
      window.prompt('当前浏览器无法自动复制，请手动复制 pageId：', rawId);
    }
  }

  function buildCurrentPageShareLink() {
    const page = pagesData[currentPageIdx] || {};
    const rawId = typeof page.pageId === 'string' ? page.pageId.trim() : '';
    if (!rawId) return null;
    try {
      const url = new URL(window.location.href);
      url.hash = '';
      url.searchParams.set('pageId', rawId);
      const projectName = typeof currentProject === 'string' ? currentProject.trim() : '';
      if (projectName) {
        url.searchParams.set('project', projectName);
      } else {
        url.searchParams.delete('project');
      }
      url.searchParams.delete('page');
      url.searchParams.delete('p');
      url.searchParams.delete('pageIndex');
      url.searchParams.delete('pageindex');
      return url.toString();
    } catch (err) {
      console.warn('生成分享链接失败', err);
      return null;
    }
  }

  async function copyCurrentPageShareLink() {
    const link = buildCurrentPageShareLink();
    if (!link) {
      showStatus('无法生成当前页链接', 'warning', 3200);
      return;
    }
    const ok = await copyTextToClipboard(link);
    if (ok) {
      showStatus('打开链接已复制，可直接分享', 'success', 2400);
    } else {
      window.prompt('当前浏览器无法自动复制，请手动复制链接：', link);
    }
  }

  function confirmDeleteCurrentPage() {
    if (pagesData.length <= 1) {
      showStatus('至少保留一页内容，删除已取消', 'warning', 3200);
      return;
    }
    const pageNumber = currentPageIdx + 1;
    if (!window.confirm(`确定删除第 ${pageNumber} 页吗？此操作无法撤销。`)) {
      return;
    }
    removeCurrentPage();
    renderTabsModal();
    showStatus(`已删除第 ${pageNumber} 页`, 'success', 2400);
  }

  async function copyTextToClipboard(text) {
    try {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        await navigator.clipboard.writeText(text);
      } else {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.focus();
        textarea.select();
        document.execCommand('copy');
        textarea.remove();
      }
      return true;
    } catch (err) {
      console.warn('复制失败', err);
      return false;
    }
  }

  function attachCopyButton(target, text, label, inline = false) {
    if (!target || !text) return;
    const parent = target.parentElement;
    if (!parent) return;
    const wrapper = document.createElement(inline ? 'span' : 'div');
    wrapper.className = 'copy-trigger-wrapper' + (inline ? ' inline-copy' : '');
    parent.insertBefore(wrapper, target);
    wrapper.appendChild(target);

    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'copy-trigger-btn btn btn-sm btn-outline-secondary';
    btn.textContent = '复制';
    btn.setAttribute('aria-label', `复制${label}`);
    btn.addEventListener('click', async (ev) => {
      ev.preventDefault();
      ev.stopPropagation();
      const ok = await copyTextToClipboard(text);
      if (ok) {
        showStatus(`${label}已复制`, 'success', 2000);
      } else {
        showStatus(`复制${label}失败`, 'warning', 3000);
      }
    });
    wrapper.appendChild(btn);
  }

  function enhanceCodeCopy(preview) {
    if (!preview || !preview.querySelectorAll) return;
    preview.querySelectorAll('pre').forEach(pre => {
      if (pre.closest('.copy-trigger-wrapper')) return;
      const code = pre.querySelector('code');
      const text = code ? code.textContent || '' : pre.textContent || '';
      if (!text.trim()) return;
      attachCopyButton(pre, text, '代码');
    });
  }

  function enhanceMathCopy(preview) {
    if (!preview || !window.MathJax || !MathJax.startup || !MathJax.startup.document) return;
    const items = MathJax.startup.document.math || [];
    items.forEach(item => {
      const root = item && item.typesetRoot;
      if (!root || !preview.contains(root)) return;
      if (!item.display) return; // 仅对块级公式启用复制按钮
      let tex = (item.math || item.originalText || '').trim();
      if (!tex) return;
      if (!/^((\$\$)|(\\\[)|(\\begin))/i.test(tex)) {
        tex = `$$${tex}$$`;
      }
      if (root.closest('.copy-trigger-wrapper')) return;
      attachCopyButton(root, tex, '公式');
    });
  }

  function syncPaneHeights() {
    if (singleEditor) {
      setTimeout(() => singleEditor.refresh(), 0);
    }
  }

  function queueCompile(delay = 600) {
    if (compileTimer) clearTimeout(compileTimer);
    compileTimer = setTimeout(runCompile, delay);
  }

  function runCompile() {
    if (isCompiling) {
      compilePending = true;
      return;
    }
    isCompiling = true;
    compilePending = false;
    fetch('/compile_page', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({page: currentPageIdx})
    }).then(res => res.json()).then(data => {
      if (data.success) {
        loadCurrentPagePDF();
      } else {
        showStatus('编译失败：' + (data.error || '未知错误'), 'danger', 6000);
      }
    }).catch(err => {
      showStatus('编译失败：' + (err?.message || '网络错误'), 'danger', 6000);
    }).finally(() => {
      isCompiling = false;
      if (compilePending) {
        compilePending = false;
        runCompile();
      }
    });
  }

  function refreshPreview() {
    const pdfContainer = document.getElementById('pdf-container');
    const markdownContainer = document.getElementById('markdown-preview');
    if (currentEditMode === 'latex') {
      pdfContainer?.classList.remove('d-none');
      markdownContainer?.classList.add('d-none');
      loadCurrentPagePDF();
    } else {
      pdfContainer?.classList.add('d-none');
      markdownContainer?.classList.remove('d-none');
      renderMarkdownPreview();
    }
    updateModeToggleUI();
    syncPaneHeights();
  }

  function setEditMode(mode) {
    if (currentEditMode === mode) return;
    currentEditMode = mode;
    renderSingleEditor();
  }

  updateModeToggleUI();
  window.addEventListener('resize', syncPaneHeights);
  
  function renderTabsModal() {
    const tabs = document.getElementById('page-tabs');
    tabs.innerHTML = '';
    pagesData.forEach((_, idx) => {
      const tab = document.createElement('div');
      tab.className = 'badge rounded-pill bg-' + (idx === currentPageIdx ? 'primary' : 'secondary') + ' me-1 mb-1';
      tab.textContent = idx + 1;
      tab.setAttribute('draggable', 'true');
      tab.style.cursor = 'grab';
      tab.ondragstart = e => {
        e.dataTransfer.setData('text/plain', idx);
        tab.classList.add('opacity-50');
      };
      tab.ondragend = e => tab.classList.remove('opacity-50');
      tab.ondragover = e => e.preventDefault();
      tab.ondrop = e => {
        e.preventDefault();
        const from = parseInt(e.dataTransfer.getData('text/plain'));
        const to = idx;
        if (from !== to) {
          const moved = pagesData.splice(from, 1)[0];
          pagesData.splice(to, 0, moved);
          if (currentPageIdx === from) currentPageIdx = to;
          else if (from < currentPageIdx && to >= currentPageIdx) currentPageIdx--;
          else if (from > currentPageIdx && to <= currentPageIdx) currentPageIdx++;
          saveProject();
          renderTabsModal();
          renderSingleEditor();
          updatePageNumLabel();
          refreshPreview();
        }
      };
      tab.onclick = () => {
        currentPageIdx = idx;
        renderSingleEditor();
        refreshPreview();
        updatePageNumLabel();
        renderTabsModal();
      };
      tabs.appendChild(tab);
    });
  }

  function updateMobileControlStates() {
    const navButtons = document.querySelectorAll('.js-nav-btn');
    if (!isMobileCompactView) {
      navButtons.forEach(btn => {
        if (btn) btn.disabled = false;
      });
      mobileEditingDisabled = false;
      mobileWarnedProject = '';
      if (singleEditor) {
        singleEditor.setOption('readOnly', false);
      }
      const scriptEl = document.getElementById('page-script');
      if (scriptEl) scriptEl.disabled = false;
      return;
    }
    const isDefaultProject = !currentProject || currentProject === 'default';
    navButtons.forEach(btn => {
      if (!btn) return;
      const allow = isDefaultProject && (btn.id === 'prev-page' || btn.id === 'next-page' || btn.id === 'page-status');
      btn.disabled = !allow;
    });
    const scriptEl = document.getElementById('page-script');
    if (scriptEl) scriptEl.disabled = true;
    if (!isDefaultProject) {
      if (mobileWarnedProject !== currentProject) {
        showStatus('移动端仅支持 default 项目，功能暂不可用。', 'warning', 3500);
        mobileWarnedProject = currentProject;
      }
      mobileEditingDisabled = true;
    } else {
      mobileEditingDisabled = false;
      mobileWarnedProject = '';
    }
    if (singleEditor) {
      singleEditor.setOption('readOnly', mobileEditingDisabled ? 'nocursor' : false);
    }
  }

  function setMobileCompact(enabled) {
    const boolEnabled = !!enabled;
    if (isMobileCompactView === boolEnabled) {
      if (boolEnabled && currentEditMode !== 'markdown' && singleEditor && typeof setEditMode === 'function') {
        setEditMode('markdown');
      }
      if (boolEnabled) {
        updateLearningContext(true);
      }
      if (!boolEnabled) {
        mobileEditingDisabled = false;
        mobileWarnedProject = '';
        if (singleEditor) singleEditor.setOption('readOnly', false);
      }
      updateMobileControlStates();
      return;
    }
    isMobileCompactView = boolEnabled;
    document.body.classList.toggle('mobile-compact', boolEnabled);
    if (boolEnabled) {
      if (currentEditMode !== 'markdown' && singleEditor && typeof setEditMode === 'function') {
        setEditMode('markdown');
      }
      updateLearningContext(true);
    } else {
      mobileEditingDisabled = false;
      mobileWarnedProject = '';
      if (singleEditor) {
        singleEditor.setOption('readOnly', false);
      }
    }
    updateMobileControlStates();
  }

  function applyMobileRestrictions() {
    if (typeof window === 'undefined' || !window.matchMedia) return;
    const matches = window.matchMedia('(max-width: 1024px)').matches;
    setMobileCompact(matches);
  }

  function guessImageExtension(file) {
    const name = file && typeof file.name === 'string' ? file.name.toLowerCase() : '';
    if (name) {
      const match = name.match(/\.([a-z0-9]{2,8})$/);
      if (match && match[1]) {
        const ext = match[1];
        if (ext === 'jpeg') return 'jpg';
        return ext;
      }
    }
    const type = file && typeof file.type === 'string' ? file.type.toLowerCase() : '';
    if (type.startsWith('image/')) {
      const subtype = type.split('/')[1] || '';
      if (!subtype) return 'png';
      if (subtype === 'jpeg' || subtype === 'pjpeg') return 'jpg';
      if (subtype === 'svg+xml') return 'svg';
      return subtype.replace(/[^a-z0-9]/g, '') || 'png';
    }
    return 'png';
  }

  function buildPastedImageFilename(file, index) {
    const date = new Date();
    const pad = (num) => String(num).padStart(2, '0');
    const timestamp = [
      date.getFullYear(),
      pad(date.getMonth() + 1),
      pad(date.getDate()),
      pad(date.getHours()),
      pad(date.getMinutes()),
      pad(date.getSeconds()),
    ].join('');
    const randomPart = Math.random().toString(36).slice(2, 6);
    const extension = guessImageExtension(file);
    return `pasted-${timestamp}-${index + 1}-${randomPart}.${extension}`;
  }

  async function uploadPastedImageFile(file, index) {
    const fd = new FormData();
    const filename = buildPastedImageFilename(file, index);
    fd.append('file', file, filename);
    const res = await fetch('/attachments/upload', {method: 'POST', body: fd});
    const parsed = await parseJsonSafe(res);
    if (res.ok && (!parsed.json || parsed.json.success !== false)) {
      const payload = parsed.json || {};
      if (!payload.filename) {
        payload.filename = filename;
      }
      return payload;
    }
    const message = (parsed.json && parsed.json.error) ? parsed.json.error : (parsed.text || `HTTP ${res.status}`);
    throw new Error(message);
  }

  function buildPastedImageSnippet(payload) {
    if (!payload || typeof payload !== 'object') {
      return {snippet: '', filename: '', warning: '上传结果无效'};
    }
    const filename = payload.filename || payload.name || 'pasted-image';
    const localUrl = payload.localUrl || '';
    const preferredUrl = payload.url || payload.ossUrl || localUrl;
    const mode = (typeof currentEditMode === 'string' && currentEditMode === 'markdown') ? 'markdown' : 'latex';
    if (mode === 'latex') {
      if (!localUrl) {
        return {snippet: '', filename, warning: '图片已上传，但缺少本地路径，无法在 LaTeX 中引用。'};
      }
      const latexPath = urlToLatexPath(localUrl);
      const snippet = `\\begin{center}\n  \\includegraphics[width=0.7\\textwidth]{${latexPath}}\n\\end{center}\n`;
      return {snippet, filename};
    }
    if (!preferredUrl) {
      return {snippet: '', filename, warning: '图片已上传，但缺少可用链接。'};
    }
    return {snippet: `![${filename}](${preferredUrl})\n`, filename};
  }

  async function handleEditorPaste(cm, event) {
    const originalEvent = event && event.originalEvent ? event.originalEvent : event;
    const clipboard = (event && event.clipboardData) || (originalEvent && originalEvent.clipboardData);
    const items = clipboard && clipboard.items ? Array.from(clipboard.items) : [];
    const imageItems = items.filter(item => item && item.kind === 'file' && typeof item.type === 'string' && item.type.startsWith('image/'));
    if (!imageItems.length) {
      return;
    }
    event.preventDefault();
    const files = imageItems.map(item => (typeof item.getAsFile === 'function' ? item.getAsFile() : null)).filter(Boolean);
    if (!files.length) {
      return;
    }
    showStatus(files.length > 1 ? `检测到 ${files.length} 张图片，正在上传...` : '检测到图片，正在上传...', 'info', 2500);
    const doc = cm.getDoc();
    let bookmark = doc.setBookmark(doc.getCursor(), {insertLeft: false});
    let insertedCount = 0;
    for (let idx = 0; idx < files.length; idx++) {
      const file = files[idx];
      try {
        const result = await uploadPastedImageFile(file, idx);
        const {snippet, filename, warning} = buildPastedImageSnippet(result);
        if (warning) {
          showStatus(warning, 'warning', 3500);
        }
        if (!snippet) {
          continue;
        }
        const anchorPos = bookmark && typeof bookmark.find === 'function' ? bookmark.find() : null;
        const insertPos = anchorPos || doc.getCursor();
        const startIndex = doc.indexFromPos(insertPos);
        doc.replaceRange(snippet, insertPos);
        const endPos = doc.posFromIndex(startIndex + snippet.length);
        if (bookmark && typeof bookmark.clear === 'function') {
          bookmark.clear();
        }
        bookmark = doc.setBookmark(endPos, {insertLeft: false});
        doc.setCursor(endPos);
        insertedCount += 1;
        showStatus(`图片已上传并插入：${filename || file.name || '图片'}`, 'success', 2200);
      } catch (err) {
        console.error('粘贴图片上传失败', err);
        showStatus('粘贴图片上传失败：' + (err?.message || '未知错误'), 'danger', 4000);
      }
    }
    if (bookmark && typeof bookmark.clear === 'function') {
      bookmark.clear();
    }
    if (insertedCount > 0 && typeof loadAttachmentsModal === 'function') {
      const attachmentsModalEl = document.getElementById('attachmentsModal');
      if (attachmentsModalEl && typeof bootstrap !== 'undefined' && bootstrap.Modal && typeof bootstrap.Modal.getInstance === 'function' && bootstrap.Modal.getInstance(attachmentsModalEl)) {
        try {
          await loadAttachmentsModal();
        } catch (refreshErr) {
          console.warn('刷新附件列表失败', refreshErr);
        }
      }
    }
  }
  
  function renderSingleEditor() {
    const list = document.getElementById('pages-list');
    list.innerHTML = '';
    const wrapper = document.createElement('div');
    wrapper.className = 'mb-3';
    wrapper.innerHTML = `<textarea id="page-single" class="form-control"></textarea>`;
    list.appendChild(wrapper);
    if (!pagesData[currentPageIdx]) {
      pagesData[currentPageIdx] = {content: '', script: '', notes: '', bib: [], resources: [], pageId: generatePageId()};
    }
    const page = pagesData[currentPageIdx];
    singleEditor = CodeMirror.fromTextArea(wrapper.querySelector('textarea'), {
      mode: currentEditMode === 'markdown' ? 'markdown' : 'stex',
      lineNumbers: true,
      theme: 'default',
      viewportMargin: Infinity,
      lineWrapping: true
    });
    const initialValue = currentEditMode === 'markdown' ? (page.notes || '') : (page.content || '');
    singleEditor.setValue(initialValue);
    singleEditor.setSize('100%', '100%');
    singleEditor.setOption('readOnly', mobileEditingDisabled ? 'nocursor' : false);
    singleEditor.on('paste', handleEditorPaste);
    singleEditor.on('change', function() {
      const value = singleEditor.getValue();
      if (currentEditMode === 'markdown') {
        pagesData[currentPageIdx].notes = value;
        renderMarkdownPreview();
      } else {
        pagesData[currentPageIdx].content = value;
      }
      saveProject();
      queueCompile();
    });
    const scriptInput = document.getElementById('page-script');
    scriptInput.value = page.script || '';
    updateModeToggleUI();
    refreshPreview();
    // refresh resources list for this page
    setTimeout(()=>{ if(window.refreshResourceLists) refreshResourceLists(); }, 50);
    queueCompile();
    updateMobileControlStates();
  }
  
  const pageStatusBtn = document.getElementById('page-status');
  if (pageStatusBtn) {
    let pageStatusClickTimer = null;
    pageStatusBtn.addEventListener('click', event => {
      if (pageStatusClickTimer) {
        clearTimeout(pageStatusClickTimer);
        pageStatusClickTimer = null;
      }
      if (event.detail > 1) {
        return;
      }
      pageStatusClickTimer = setTimeout(() => {
        renderTabsModal();
        const modalEl = document.getElementById('tabsModal');
        if (modalEl && typeof bootstrap !== 'undefined' && bootstrap?.Modal) {
          const modal = typeof bootstrap.Modal.getOrCreateInstance === 'function'
            ? bootstrap.Modal.getOrCreateInstance(modalEl)
            : new bootstrap.Modal(modalEl);
          modal.show();
        }
        pageStatusClickTimer = null;
      }, 180);
    });
    pageStatusBtn.addEventListener('dblclick', event => {
      if (pageStatusClickTimer) {
        clearTimeout(pageStatusClickTimer);
        pageStatusClickTimer = null;
      }
      event.preventDefault();
      event.stopPropagation();
      jumpToPage(0);
    });
  }

  const tabsCopyPageIdBtn = document.getElementById('tabs-copy-page-id');
  if (tabsCopyPageIdBtn && !tabsCopyPageIdBtn.dataset.bound) {
    tabsCopyPageIdBtn.dataset.bound = '1';
    tabsCopyPageIdBtn.addEventListener('click', () => {
      copyCurrentPageIdToClipboard();
    });
  }
  const tabsDeletePageBtn = document.getElementById('tabs-delete-page');
  if (tabsDeletePageBtn && !tabsDeletePageBtn.dataset.bound) {
    tabsDeletePageBtn.dataset.bound = '1';
    tabsDeletePageBtn.addEventListener('click', () => {
      confirmDeleteCurrentPage();
    });
  }
  const tabsCopyPageLinkBtn = document.getElementById('tabs-copy-page-link');
  if (tabsCopyPageLinkBtn && !tabsCopyPageLinkBtn.dataset.bound) {
    tabsCopyPageLinkBtn.dataset.bound = '1';
    tabsCopyPageLinkBtn.addEventListener('click', () => {
      copyCurrentPageShareLink();
    });
  }

  function removeCurrentPage() {
    if(pagesData.length <= 1) return;
    pagesData.splice(currentPageIdx, 1);
    if(currentPageIdx >= pagesData.length) currentPageIdx = pagesData.length - 1;
    saveProject();
    renderSingleEditor();
    updatePageNumLabel();
  }


  
  document.getElementById('add-page').onclick = function() {
    fetch('/add_page', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({idx: currentPageIdx+1})
    }).then(res => res.json()).then(data => {
      pagesData = (data.pages || []).map((p) => {
        if (typeof p !== 'object' || p === null) {
          return {content: String(p || ''), script: '', notes: '', bib: [], resources: [], pageId: generatePageId()};
        }
        const pageObj = {...p};
        pageObj.content = pageObj.content || '';
        pageObj.script = pageObj.script || '';
        pageObj.notes = pageObj.notes || '';
        pageObj.bib = normalizeBibList(pageObj.bib);
        pageObj.resources = Array.isArray(pageObj.resources) ? pageObj.resources : [];
        const pidSource = (typeof pageObj.pageId === 'string' && pageObj.pageId) || (typeof pageObj.id === 'string' && pageObj.id);
        pageObj.pageId = pidSource && pidSource.trim() ? pidSource.trim() : generatePageId();
        delete pageObj.id;
        return pageObj;
      });
      currentPageIdx++;
      renderSingleEditor();
      updatePageNumLabel();
      refreshPreview();
    });
  };

  const projectSearchBtn = document.getElementById('project-search-btn');
  if (projectSearchBtn) {
    projectSearchBtn.addEventListener('click', () => {
      const modal = ensureSearchModal();
      if (modal) modal.show();
      if (searchInputEl) {
        searchInputEl.focus();
        searchInputEl.select();
      }
    });
  }

  if (searchSubmitBtn) {
    searchSubmitBtn.addEventListener('click', () => {
      performProjectSearch(searchInputEl ? searchInputEl.value : '');
    });
  }

  if (searchInputEl) {
    searchInputEl.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        event.preventDefault();
        performProjectSearch(searchInputEl.value);
      } else if (event.key === 'Escape') {
        event.preventDefault();
        const modal = ensureSearchModal();
        if (modal) modal.hide();
      }
    });
    searchInputEl.addEventListener('input', () => {
      if (searchDebounceTimer) clearTimeout(searchDebounceTimer);
      searchDebounceTimer = setTimeout(() => {
        const value = searchInputEl.value;
        const trimmed = value.trim();
        const cached = (searchQueryCache || '').trim();
        if (!trimmed && !cached) {
          performProjectSearch('');
          return;
        }
        if (trimmed === cached) return;
        performProjectSearch(value);
      }, 350);
    });
  }

  const modeSwitchBtn = document.getElementById('mode-switch-btn');
  if (modeSwitchBtn) {
    modeSwitchBtn.addEventListener('click', () => {
      const nextMode = currentEditMode === 'latex' ? 'markdown' : 'latex';
      setEditMode(nextMode);
    });
  }
  updateModeToggleUI();
  applyNavbarTheme();
  
  document.getElementById('edit-template').onclick = function() {
    const mode = currentEditMode === 'markdown' ? 'markdown' : 'latex';
    const latexFields = document.getElementById('template-latex-fields');
    const markdownFields = document.getElementById('template-markdown-fields');
    const helper = document.getElementById('template-helper-text');

    if (mode === 'markdown') {
      latexFields?.classList.add('d-none');
      markdownFields?.classList.remove('d-none');
      if (helper) helper.textContent = 'CSS 将实时作用于 Markdown 预览区域。';
      document.getElementById('template-markdown-css').value = markdownTemplate.css || '';
      document.getElementById('template-markdown-wrapper').value = markdownTemplate.wrapperClass || '';
    } else {
      markdownFields?.classList.add('d-none');
      latexFields?.classList.remove('d-none');
      if (helper) helper.textContent = '选择后仍可在下方继续调整。';
      document.getElementById('template-header').value = latexTemplate.header || '';
      document.getElementById('template-before-pages').value = latexTemplate.beforePages || '';
      document.getElementById('template-footer').value = latexTemplate.footer || '';
    }

    ensureTemplatesLoaded().finally(() => {
      detectCurrentTemplate(mode);
      populateTemplateSelect(mode);
    });
    var modal = new bootstrap.Modal(document.getElementById('templateModal'));
    modal.show();
  };
  document.getElementById('save-template').onclick = function() {
    const mode = currentEditMode === 'markdown' ? 'markdown' : 'latex';
    const selectEl = document.getElementById('template-select');

    if (mode === 'markdown') {
      const cssVal = document.getElementById('template-markdown-css').value;
      const wrapperVal = document.getElementById('template-markdown-wrapper').value.trim();
      markdownTemplate.css = cssVal;
      markdownTemplate.wrapperClass = wrapperVal;
      if (typeof markdownTemplate.customHead === 'string' && !markdownTemplate.customHead.trim()) {
        delete markdownTemplate.customHead;
      }
      const chosen = selectEl ? selectEl.value : '';
      let matchedTemplate = null;
      if (chosen) {
        const tmpl = (availableTemplates.markdown || []).find(t => t.name === chosen);
        if (
          tmpl &&
          normalizeCssText(tmpl.css) === normalizeCssText(cssVal) &&
          (tmpl.wrapperClass || '') === wrapperVal
        ) {
          selectedTemplateName.markdown = chosen;
          matchedTemplate = tmpl;
        } else {
          selectedTemplateName.markdown = '';
          if (selectEl) selectEl.value = '';
        }
      } else {
        selectedTemplateName.markdown = '';
      }
      if (matchedTemplate && matchedTemplate.customHead) {
        markdownTemplate.customHead = matchedTemplate.customHead;
      }
      detectCurrentTemplate('markdown');
      saveProject();
      applyMarkdownStyles();
      renderMarkdownPreview();
    } else {
      const headerVal = document.getElementById('template-header').value;
      const beforeVal = document.getElementById('template-before-pages').value;
      const footerVal = document.getElementById('template-footer').value;
      latexTemplate.header = headerVal;
      latexTemplate.beforePages = beforeVal;
      latexTemplate.footer = footerVal;
      const chosen = selectEl ? selectEl.value : '';
      if (chosen) {
        const tmpl = (availableTemplates.latex || []).find(t => t.name === chosen);
        if (
          tmpl &&
          normalizeTemplateText(tmpl.header) === normalizeTemplateText(headerVal) &&
          normalizeTemplateText(tmpl.beforePages) === normalizeTemplateText(beforeVal) &&
          normalizeTemplateText(tmpl.footer) === normalizeTemplateText(footerVal)
        ) {
          selectedTemplateName.latex = chosen;
        } else {
          selectedTemplateName.latex = '';
          if (selectEl) selectEl.value = '';
        }
      } else {
        selectedTemplateName.latex = '';
      }
      detectCurrentTemplate('latex');
      saveProject();
      queueCompile();
    }
    var modal = bootstrap.Modal.getInstance(document.getElementById('templateModal'));
    modal.hide();
  };

  
  document.getElementById('tex-form').onsubmit = function(e) {
    e.preventDefault();
    saveProject();
  };

  
  // export-tex button removed; unified export flow handled by export modal

  // New unified export flow
  const exportBtn = document.getElementById('export-btn');
  if(exportBtn) exportBtn.addEventListener('click', function(){
    var modal = new bootstrap.Modal(document.getElementById('exportModal'));
    modal.show();
  });

  const templateSelectEl = document.getElementById('template-select');
  if (templateSelectEl) templateSelectEl.addEventListener('change', function(){
    const name = this.value;
    const mode = currentEditMode === 'markdown' ? 'markdown' : 'latex';
    if (name) {
      applyTemplateByName(name, mode);
    } else {
      selectedTemplateName[mode] = '';
      if (mode === 'markdown') {
        applyMarkdownStyles();
      }
    }
  });

  document.getElementById('doExportBtn').addEventListener('click', function(){
    const opt = document.querySelector('input[name="exportOption"]:checked').value;
    var modalEl = document.getElementById('exportModal');
    var modal = bootstrap.Modal.getInstance(modalEl);
    modal.hide();
    if(opt === 'page_pdf') {
      const pageNumber = currentPageIdx + 1;
      fetch(`/export_page_pdf?page=${pageNumber}`).then(res => {
        if(res.ok) return res.blob();
        return res.json().then(data=>{throw new Error(data.error||'导出失败')});
      }).then(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `slide_page_${pageNumber}.pdf`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        showStatus(`第 ${pageNumber} 页 PDF 已导出`, 'success', 2500);
      }).catch(e=>alert('导出失败：'+e.message));
      return;
    }
    if(opt === 'page_notes') {
      const pageNumber = currentPageIdx + 1;
      fetch(`/export_page_notes?page=${pageNumber}`).then(res => {
        if(res.ok) return res.blob();
        return res.json().then(data=>{throw new Error(data.error||'导出失败')});
      }).then(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `page_${pageNumber}_notes.md`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        showStatus(`第 ${pageNumber} 页 Markdown 已导出`, 'success', 2500);
      }).catch(e=>alert('导出失败：'+e.message));
      return;
    }
    if(opt === 'page_notes_html') {
      const pageNumber = currentPageIdx + 1;
      fetch(`/export_page_markdown_html?page=${pageNumber}`).then(res => {
        if(res.ok) return res.blob();
        return res.json().then(data=>{throw new Error(data.error||'导出失败')});
      }).then(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `page_${pageNumber}_notes.html`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        showStatus(`第 ${pageNumber} 页 Markdown HTML 已导出`, 'success', 2500);
      }).catch(e=>alert('导出失败：'+e.message));
      return;
    }
    if(opt === 'page_audio'){
      const pageNumber = currentPageIdx + 1;
      fetch(`/export_page_audio?page=${pageNumber}`).then(res => {
        if(res.ok) return res.blob();
        return res.json().then(data=>{throw new Error(data.error||'导出失败')});
      }).then(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `page_${pageNumber}_script.mp3`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        showStatus(`第 ${pageNumber} 页讲稿语音已导出`, 'success', 2500);
      }).catch(e=>alert('导出失败：'+e.message));
      return;
    }
    if(opt === 'notes'){
      fetch('/export_notes').then(res => {
        if(res.ok) return res.blob();
        return res.json().then(data=>{throw new Error(data.error||'导出失败')});
      }).then(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'notes.md'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        showStatus('全部笔记已导出', 'success', 2500);
      }).catch(e=>alert('导出失败：'+e.message));
      return;
    }
    if(opt === 'learn'){
      fetch('/export_learn_project').then(res => {
        if(res.ok) return res.blob();
        return res.json().then(data=>{throw new Error(data.error||'导出失败')});
      }).then(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'learn_project.yaml'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        showStatus('学习记录已导出', 'success', 2500);
      }).catch(e=>alert('导出失败：'+e.message));
      return;
    }
    if(opt === 'tex') return exportTex();
    if(opt === 'attachments') {
      fetch('/export_attachments').then(res => {
        if(res.ok) return res.blob();
        return res.json().then(data=>{throw new Error(data.error||'导出失败')});
      }).then(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'attachments.zip'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        showStatus('资料与附件已导出', 'success', 2500);
      }).catch(e=>alert('导出失败：'+e.message));
      return;
    }
    if(opt === 'audio'){
      // request the server to produce audio from 'script' (讲稿)
      fetch('/export_audio').then(res => {
        if(res.ok) return res.blob();
        return res.json().then(data=>{throw new Error(data.error||'导出失败')});
      }).then(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'all_notes.mp3'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        showStatus('全部讲稿语音已导出', 'success', 2500);
      }).catch(e=>alert('导出失败：'+e.message));
      return;
    }
  });
  
  function flushProjectSave(callbacks) {
    const payload = {
      template: {...latexTemplate},
      markdownTemplate: {...markdownTemplate},
      pages: pagesData,
      resources: globalResources,
    };
    saveRequestQueue = saveRequestQueue
      .catch(() => {})
      .then(() => fetch(PROJECT_ENDPOINTS.projectSave || '/project', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload),
      }))
      .then(async response => {
        if (!response.ok) {
          let message = '保存接口返回错误';
          try {
            const parsed = await parseJsonSafe(response);
            if(parsed.json && parsed.json.error){
              message = parsed.json.error;
            } else if(parsed.text){
              message = parsed.text;
            } else {
              message = `HTTP ${response.status}`;
            }
          } catch (e) {
            message = `HTTP ${response.status}`;
          }
          throw new Error(message);
        }
        callbacks.forEach(cb => {
          try {
            cb();
          } catch (err) {
            console.error('saveProject 回调执行失败:', err);
          }
        });
      })
      .catch(err => {
        console.error('保存项目失败:', err);
        showStatus('保存失败：' + (err?.message || '网络错误'), 'danger', 6000);
      });
  }

  function saveProject(cb) {
    if (typeof cb === 'function') {
      pendingSaveCallbacks.push(cb);
    }
    if (saveProjectTimer) {
      clearTimeout(saveProjectTimer);
    }
    saveProjectTimer = setTimeout(() => {
      saveProjectTimer = null;
      const callbacks = pendingSaveCallbacks.slice();
      pendingSaveCallbacks = [];
      flushProjectSave(callbacks);
    }, 400);
  }

  
  function loadProject(cb) {
    const targetProject = typeof currentProject === 'string' ? currentProject : '';
    const promptsChanged = handleLearningProjectSwitch(targetProject, {force: false});
    const projectUrl = PROJECT_ENDPOINTS.project || '/project';
    return fetch(projectUrl)
      .then(async res => {
        let data;
        try {
          data = await res.json();
        } catch (e) {
          data = {};
        }
        if (res.status === 401) {
          return null;
        }
        if (!res.ok) {
          const message = data && data.error ? data.error : `HTTP ${res.status}`;
          throw new Error(message);
        }
        return data;
      })
      .then(data => {
        if (!data) return;
        latexTemplate = typeof data.template === 'string' ? {
          header: data.template,
          beforePages: '\\begin{document}',
          footer: '\\end{document}'
        } : (data.template || latexTemplate);
        const mdTemplate = data.markdownTemplate;
        if (typeof mdTemplate === 'string') {
          markdownTemplate = { css: mdTemplate, wrapperClass: '' };
        } else if (mdTemplate && typeof mdTemplate === 'object') {
          markdownTemplate = {
            css: mdTemplate.css || '',
            wrapperClass: mdTemplate.wrapperClass || '',
          };
          if (mdTemplate.customHead) {
            markdownTemplate.customHead = mdTemplate.customHead;
          } else if ('customHead' in markdownTemplate) {
            delete markdownTemplate.customHead;
          }
        } else {
          markdownTemplate = { css: '', wrapperClass: '' };
        }

        pagesData = (data.pages || []).map((p, index) => {
          if (typeof p !== 'object' || p === null) {
            return {content: String(p || ''), script: '', notes: '', bib: [], resources: [], pageId: generatePageId()};
          }
          const pageObj = {...p};
          pageObj.content = pageObj.content || '';
          pageObj.script = pageObj.script || '';
          pageObj.notes = pageObj.notes || '';
          pageObj.bib = normalizeBibList(pageObj.bib);
          pageObj.resources = Array.isArray(pageObj.resources) ? pageObj.resources : [];
          const pidSource = (typeof pageObj.pageId === 'string' && pageObj.pageId) || (typeof pageObj.id === 'string' && pageObj.id);
          pageObj.pageId = pidSource && pidSource.trim() ? pidSource.trim() : generatePageId();
          delete pageObj.id;
          return pageObj;
        });
        if(pagesData.length === 0) pagesData = [{content: '', script: '', notes: '', bib: [], resources: [], pageId: generatePageId()}];
        globalResources = Array.isArray(data.resources) ? data.resources.slice() : [];
        bibData = normalizeBibList(data.bib || []);
        currentPageIdx = Math.min(currentPageIdx, pagesData.length - 1);
        updateProjectButtonLabel();
        renderSingleEditor();
        applyMobileRestrictions();
        updatePageNumLabel();
        ensureTemplatesLoaded().then(() => detectAllTemplates()).catch(() => {});
        applyMarkdownStyles();
        const liveProject = typeof currentProject === 'string' ? currentProject : '';
        if (liveProject === targetProject) {
          const needsReload = promptsChanged || !learningAssistantState.loaded || learningAssistantState.project !== targetProject;
          if (targetProject && needsReload) {
            loadLearningPrompts(true);
          } else if (targetProject) {
            learningAssistantState.pendingProject = targetProject;
          }
        }
        resetSearchState();
        applyInitialDeepLinkIfNeeded();
        if(cb) cb();
      })
      .catch(err => {
        if(!err) return;
        console.error(err);
        showStatus('加载项目失败：' + (err?.message || '未知错误'), 'danger', 6000);
      });
  }
  
  document.addEventListener('input', function(e) {
    if(!e.target) return;
    if(e.target.id === 'page-script') {
      pagesData[currentPageIdx].script = e.target.value;
      saveProject();
      queueCompile();
    }
  });



  
  const pdfPagesContainer = document.getElementById('pdf-pages');
  let currentPdfRequestId = 0;

  function resetPdfViewer() {
    if (pdfPagesContainer) {
      pdfPagesContainer.innerHTML = '';
    }
  }

  function renderMessage(message, requestId) {
    if (!pdfPagesContainer || requestId !== currentPdfRequestId) return;
    resetPdfViewer();
    const holder = document.createElement('div');
    holder.className = 'text-muted small';
    holder.style.padding = '2rem';
    holder.textContent = message;
    pdfPagesContainer.appendChild(holder);
  }

  async function renderPdfDocument(pdf, requestId) {
    if (!pdfPagesContainer || requestId !== currentPdfRequestId) return;
    resetPdfViewer();
    const total = pdf.numPages;
    if (!total) {
      renderMessage('PDF 没有页面', requestId);
      return;
    }
    for (let i = 1; i <= total; i += 1) {
      if (requestId !== currentPdfRequestId) {
        return;
      }
      try {
        const page = await pdf.getPage(i);
        if (requestId !== currentPdfRequestId) {
          return;
        }
        const viewport = page.getViewport({ scale: 1.5 });
        const canvas = document.createElement('canvas');
        canvas.className = 'pdf-page-canvas shadow-sm';
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        pdfPagesContainer.appendChild(canvas);
        const ctx = canvas.getContext('2d');
        if (ctx) {
          await page.render({ canvasContext: ctx, viewport }).promise;
        }
      } catch (err) {
        console.error(`渲染 PDF 第 ${i} 页失败:`, err);
        renderMessage('PDF 渲染失败', requestId);
        return;
      }
    }
  }

  function loadCurrentPagePDF(retry = 0) {
    if (!pdfPagesContainer) return;
    const requestId = ++currentPdfRequestId;
    renderMessage('加载中...', requestId);
    const project = currentProject || '';
    const pdfUrl = `/page_pdf/${currentPageIdx + 1}?project=${encodeURIComponent(project)}&t=${Date.now()}`;
    fetch(pdfUrl, { method: 'HEAD' }).then(res => {
      if (requestId !== currentPdfRequestId) {
        return;
      }
      if (res.ok) {
        pdfjsLib.getDocument(pdfUrl).promise
          .then(pdf => renderPdfDocument(pdf, requestId))
          .catch(err => {
            console.error('加载 PDF 失败:', err);
            renderMessage('PDF 加载失败', requestId);
          });
      } else {
        if (retry < 3) {
          setTimeout(() => loadCurrentPagePDF(retry + 1), 800);
        } else {
          renderMessage('本页未编译', requestId);
        }
      }
    }).catch(err => {
      console.error('请求 PDF 失败:', err);
      if (retry < 3) {
        setTimeout(() => loadCurrentPagePDF(retry + 1), 800);
      } else if (requestId === currentPdfRequestId) {
        renderMessage('无法加载预览', requestId);
      }
    });
    document.getElementById('page-num').textContent = currentPageIdx + 1;
    document.getElementById('page-count').textContent = pagesData.length;
  }

  document.getElementById('prev-page').addEventListener('click', function() {
    if(currentPageIdx > 0) {
      currentPageIdx--;
      renderSingleEditor();
      refreshPreview();
      document.getElementById('page-num').textContent = currentPageIdx+1;
    }
  });
  document.getElementById('next-page').addEventListener('click', function() {
    if(currentPageIdx < pagesData.length-1) {
      currentPageIdx++;
      renderSingleEditor();
      refreshPreview();
      document.getElementById('page-num').textContent = currentPageIdx+1;
    }
  });

// --- multi-project client helpers ---
(function(){
  function getSelectedProject() {
    return currentProject || '';
  }

  function appendProjectQuery(url, key, value) {
    if(typeof url !== 'string') return url;
    const sep = url.indexOf('?') > -1 ? '&' : '?';
    return url + sep + encodeURIComponent(key) + '=' + encodeURIComponent(value);
  }

  function extractContentType(headers){
    if(!headers) return '';
    if(headers instanceof Headers){
      return headers.get('Content-Type') || headers.get('content-type') || '';
    }
    if(Array.isArray(headers)){
      for(const entry of headers){
        if(Array.isArray(entry) && entry.length >= 2 && typeof entry[0] === 'string' && entry[0].toLowerCase() === 'content-type'){
          return entry[1];
        }
      }
      return '';
    }
    if(typeof headers === 'object'){
      return headers['Content-Type'] || headers['content-type'] || '';
    }
    return '';
  }

  const _origFetch = window.fetch.bind(window);
  window.fetch = function(input, init){
    let requestUrl = input;
    let requestInit = init;
    let shouldTrack401 = false;

    try {
      if(typeof requestUrl === 'string' && requestUrl.startsWith('/')){
        shouldTrack401 = true;
        const project = getSelectedProject();
        if(project){
          if(requestInit && requestInit.body instanceof FormData){
            requestUrl = appendProjectQuery(requestUrl, 'project', project);
          } else if(requestInit && requestInit.headers){
            const contentType = extractContentType(requestInit.headers) || '';
            if(contentType.indexOf('application/json') > -1 && requestInit.body){
              try{
                const obj = JSON.parse(requestInit.body);
                obj.project = project;
                requestInit = Object.assign({}, requestInit, { body: JSON.stringify(obj) });
              }catch(e){}
            } else {
              requestUrl = appendProjectQuery(requestUrl, 'project', project);
            }
          } else {
            requestUrl = appendProjectQuery(requestUrl, 'project', project);
          }
        }
      }
    } catch(e) {
      // ignore and fall back to default fetch
    }

    const fetchPromise = _origFetch(requestUrl, requestInit);
    if(shouldTrack401){
      return fetchPromise.then(async res => {
        if(res.status === 401){
          let message = '';
          try{
            const header = res.headers.get('content-type') || res.headers.get('Content-Type') || '';
            if(header && header.indexOf('application/json') > -1){
              const data = await res.clone().json();
              if(data && data.error) message = data.error;
            } else {
              message = await res.clone().text();
            }
          }catch(err){
            message = '';
          }
          handleProjectLocked(message);
        }
        return res;
      });
    }
    return fetchPromise;
  };

  window.loadProjects = async function(){
    try{
      const listUrl = PROJECT_ENDPOINTS.list || '/projects';
      const res = await _origFetch(listUrl);
      if(!res.ok) return;
      const data = await res.json();
      const projects = Array.isArray(data.projects) ? data.projects : [];
      projectMetadata = data && typeof data.metadata === 'object' && data.metadata ? data.metadata : {};

      if(currentProject && projects.length && !projects.includes(currentProject)){
        currentProject = projects[0];
      }
      if(!currentProject){
        currentProject = data.default || projects[0] || '';
      }
      if(!currentProject && data.default){
        currentProject = data.default;
      }

      const menu = document.getElementById('project-menu');
      if(menu){
        buildProjectMenu(menu, projects);
      }
      updateProjectButtonLabel();
      applyMobileRestrictions();
      return data;
    }catch(e){
      console.warn('loadProjects failed', e);
    }
  };
})();

  function openProjectCreateModal(){
    if(!projectCreateModalEl){
      showStatus('当前界面不支持新建项目', 'danger', 6000);
      return;
    }
    const modal = bootstrap.Modal.getOrCreateInstance(projectCreateModalEl);
    modal.show();
  }

  function openProjectRenameModal(target){
    const name = target || currentProject;
    if(!name){
      showStatus('暂无可重命名的项目', 'warning', 4000);
      return;
    }
    projectRenameTarget = name;
    if(projectRenameCurrent) projectRenameCurrent.textContent = `当前项目：${name}`;
    if(projectRenameInput){
      projectRenameInput.value = name;
      setTimeout(() => {
        try{ projectRenameInput.select(); } catch(e){}
      }, 100);
    }
    if(!projectRenameModalEl){
      showStatus('当前界面不支持重命名', 'danger', 6000);
      return;
    }
    const modal = bootstrap.Modal.getOrCreateInstance(projectRenameModalEl);
    modal.show();
  }

  function openProjectDeleteModal(target){
    const name = target || currentProject;
    if(!name){
      showStatus('暂无可删除的项目', 'warning', 4000);
      return;
    }
    projectDeleteTarget = name;
    if(projectDeleteWarning) projectDeleteWarning.textContent = `此操作无法撤销，将永久删除项目「${name}」及其所有附件与资源。`;
    if(projectDeleteConfirmInput){
      projectDeleteConfirmInput.value = '';
      projectDeleteConfirmInput.placeholder = name;
      projectDeleteConfirmInput.classList.remove('is-invalid');
    }
    if(!projectDeleteModalEl){
      showStatus('当前界面不支持删除项目', 'danger', 6000);
      return;
    }
    const modal = bootstrap.Modal.getOrCreateInstance(projectDeleteModalEl);
    modal.show();
  }

  function openProjectPasswordModal(target){
    const name = target || currentProject;
    if(!name){
      showStatus('暂无可设置密码的项目', 'warning', 4000);
      return;
    }
    projectPasswordTarget = name;
    if(projectPasswordModalEl) projectPasswordModalEl.dataset.project = name;
    if(projectPasswordCurrentInput) projectPasswordCurrentInput.value = '';
    if(projectPasswordNewInput) projectPasswordNewInput.value = '';
    if(projectPasswordConfirmInput) projectPasswordConfirmInput.value = '';
    if(projectPasswordWarning){
      projectPasswordWarning.textContent = '';
      projectPasswordWarning.classList.add('d-none');
    }
    if(projectPasswordRemoveBtn){
      const meta = getProjectMeta(name);
      projectPasswordRemoveBtn.disabled = !meta.locked;
    }
    if(!projectPasswordModalEl){
      showStatus('当前界面不支持项目加密设置', 'danger', 6000);
      return;
    }
    const modal = bootstrap.Modal.getOrCreateInstance(projectPasswordModalEl);
    modal.show();
  }

  async function lockCurrentProject(){
    const name = currentProject;
    if(!name){
      showStatus('请选择项目后再锁定', 'warning', 4000);
      return;
    }
    const meta = getProjectMeta(name);
    if(!meta.locked){
      showStatus('当前项目尚未设置密码，无需锁定', 'info', 4000);
      return;
    }
    const lockBtn = document.getElementById('project-action-lock');
    if(lockBtn) lockBtn.disabled = true;
    try{
      const res = await fetch(PROJECT_ENDPOINTS.lock || '/projects/lock', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({project: name}),
      });
      const parsed = await parseJsonSafe(res);
      if(res.ok && (!parsed.json || parsed.json.success !== false)){
        showStatus('项目已锁定，下次访问需密码解锁', 'info', 5000);
        await loadProjects();
      } else {
        const message = (parsed.json && parsed.json.error) ? parsed.json.error : (parsed.text || (`HTTP ${res.status}`));
        showStatus('锁定失败：' + message, 'danger', 6000);
      }
    }catch(e){
      showStatus('锁定失败：' + e.message, 'danger', 6000);
    } finally {
      if(lockBtn) lockBtn.disabled = false;
    }
  }

  if(projectCreateConfirmBtn){
    projectCreateConfirmBtn.addEventListener('click', async function(){
      if(!projectCreateNameInput){
        showStatus('请输入项目名称', 'warning', 4000);
        return;
      }
      const name = projectCreateNameInput.value.trim();
      if(!name){
        showStatus('项目名称不能为空', 'warning', 4000);
        return;
      }
      const original = this.textContent;
      this.disabled = true;
      this.textContent = '创建中...';
      try{
        const res = await fetch(PROJECT_ENDPOINTS.create || '/projects/create', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({name}),
        });
        const parsed = await parseJsonSafe(res);
        if(res.ok && (!parsed.json || parsed.json.success !== false)){
          const payload = parsed.json || {};
          currentProject = payload.project || name;
          handleLearningProjectSwitch(currentProject, {force: true});
          updateProjectButtonLabel();
          if(projectCreateModalEl){
            const modal = bootstrap.Modal.getInstance(projectCreateModalEl);
            if(modal) modal.hide();
          }
          showStatus('项目创建成功', 'success', 4000);
          await loadProjects();
          await loadProject();
        } else {
          const message = (parsed.json && parsed.json.error) ? parsed.json.error : (parsed.text || (`HTTP ${res.status}`));
          showStatus('创建项目失败：' + message, 'danger', 6000);
        }
      }catch(e){
        showStatus('创建项目失败：' + e.message, 'danger', 6000);
      }
      this.disabled = false;
      this.textContent = original || '创建';
    });
  }

  if(projectRenameConfirmBtn){
    projectRenameConfirmBtn.addEventListener('click', async function(){
      if(!projectRenameTarget){
        showStatus('请选择要重命名的项目', 'warning', 4000);
        return;
      }
      const newName = projectRenameInput ? projectRenameInput.value.trim() : '';
      if(!newName){
        showStatus('新名称不能为空', 'warning', 4000);
        return;
      }
      const original = this.textContent;
      this.disabled = true;
      this.textContent = '保存中...';
      try{
        const res = await fetch(PROJECT_ENDPOINTS.rename || '/projects/rename', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({oldName: projectRenameTarget, newName}),
        });
        const parsed = await parseJsonSafe(res);
        if(res.ok && (!parsed.json || parsed.json.success !== false)){
          const payload = parsed.json || {};
          const finalName = payload.project || newName;
          const wasCurrent = currentProject === projectRenameTarget;
          if(wasCurrent){
            currentProject = finalName;
            handleLearningProjectSwitch(currentProject, {force: true});
          }
          updateProjectButtonLabel();
          showStatus('项目已重命名', 'success', 4000);
          if(projectRenameModalEl){
            const modal = bootstrap.Modal.getInstance(projectRenameModalEl);
            if(modal) modal.hide();
          }
          projectRenameTarget = '';
          await loadProjects();
          if(wasCurrent){
            await loadProject();
          }
        } else {
          const message = (parsed.json && parsed.json.error) ? parsed.json.error : (parsed.text || (`HTTP ${res.status}`));
          showStatus('重命名失败：' + message, 'danger', 6000);
        }
      }catch(e){
        showStatus('重命名失败：' + e.message, 'danger', 6000);
      }
      this.disabled = false;
      this.textContent = original || '保存';
    });
  }

  if(projectDeleteConfirmBtn){
    projectDeleteConfirmBtn.addEventListener('click', async function(){
      if(!projectDeleteTarget){
        showStatus('请选择要删除的项目', 'warning', 4000);
        return;
      }
      const confirmation = projectDeleteConfirmInput ? projectDeleteConfirmInput.value.trim() : '';
      if(confirmation !== projectDeleteTarget){
        if(projectDeleteConfirmInput) projectDeleteConfirmInput.classList.add('is-invalid');
        showStatus('请输入准确的项目名称以确认删除', 'warning', 4000);
        return;
      }
      if(projectDeleteConfirmInput) projectDeleteConfirmInput.classList.remove('is-invalid');
      const original = this.textContent;
      this.disabled = true;
      this.textContent = '删除中...';
      try{
        const res = await fetch(PROJECT_ENDPOINTS.delete || '/projects/delete', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({name: projectDeleteTarget}),
        });
        const parsed = await parseJsonSafe(res);
        if(res.ok && (!parsed.json || parsed.json.success !== false)){
          const deleted = projectDeleteTarget;
          if(projectDeleteModalEl){
            const modal = bootstrap.Modal.getInstance(projectDeleteModalEl);
            if(modal) modal.hide();
          }
          showStatus('项目已删除', 'success', 4000);
          if(currentProject === deleted){
            currentProject = '';
            handleLearningProjectSwitch('', {force: true});
            updateProjectButtonLabel();
          }
          projectDeleteTarget = '';
          await loadProjects();
          await loadProject();
        } else {
          const message = (parsed.json && parsed.json.error) ? parsed.json.error : (parsed.text || (`HTTP ${res.status}`));
          showStatus('删除项目失败：' + message, 'danger', 6000);
        }
      }catch(e){
        showStatus('删除项目失败：' + e.message, 'danger', 6000);
      }
      this.disabled = false;
      this.textContent = original || '删除';
    });
  }

  if(projectPasswordConfirmBtn){
    projectPasswordConfirmBtn.addEventListener('click', async function(){
      if(!projectPasswordTarget){
        showStatus('请选择项目后再设置密码', 'warning', 4000);
        return;
      }
      const newPassword = projectPasswordNewInput ? projectPasswordNewInput.value : '';
      const confirmPassword = projectPasswordConfirmInput ? projectPasswordConfirmInput.value : '';
      if(!newPassword){
        if(projectPasswordWarning){
          projectPasswordWarning.textContent = '新密码不能为空';
          projectPasswordWarning.classList.remove('d-none');
        }
        return;
      }
      if(newPassword !== confirmPassword){
        if(projectPasswordWarning){
          projectPasswordWarning.textContent = '两次输入的密码不一致';
          projectPasswordWarning.classList.remove('d-none');
        }
        return;
      }
      if(projectPasswordWarning){
        projectPasswordWarning.textContent = '';
        projectPasswordWarning.classList.add('d-none');
      }
      const original = this.textContent;
      this.disabled = true;
      this.textContent = '保存中...';
      try{
        const payload = {
          project: projectPasswordTarget,
          newPassword,
        };
        const currentPassword = projectPasswordCurrentInput ? projectPasswordCurrentInput.value : '';
        if(currentPassword) payload.currentPassword = currentPassword;
        const res = await fetch(PROJECT_ENDPOINTS.password || '/projects/password', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload),
        });
        const parsed = await parseJsonSafe(res);
        if(res.ok && (!parsed.json || parsed.json.success !== false)){
          if(projectPasswordModalEl){
            const modal = bootstrap.Modal.getInstance(projectPasswordModalEl);
            if(modal) modal.hide();
          }
          showStatus('项目密码已更新', 'success', 4000);
          updateProjectButtonLabel();
          await loadProjects();
          await loadProject();
        } else {
          const message = (parsed.json && parsed.json.error) ? parsed.json.error : (parsed.text || (`HTTP ${res.status}`));
          if(projectPasswordWarning){
            projectPasswordWarning.textContent = message;
            projectPasswordWarning.classList.remove('d-none');
          } else {
            showStatus('更新密码失败：' + message, 'danger', 6000);
          }
        }
      }catch(e){
        if(projectPasswordWarning){
          projectPasswordWarning.textContent = e.message;
          projectPasswordWarning.classList.remove('d-none');
        } else {
          showStatus('更新密码失败：' + e.message, 'danger', 6000);
        }
      }
      this.disabled = false;
      this.textContent = original || '保存';
    });
  }

  if(projectPasswordRemoveBtn){
    projectPasswordRemoveBtn.addEventListener('click', async function(){
      if(this.disabled) return;
      if(!projectPasswordTarget){
        showStatus('请选择项目后再移除密码', 'warning', 4000);
        return;
      }
      const payload = { project: projectPasswordTarget, remove: true };
      const currentPassword = projectPasswordCurrentInput ? projectPasswordCurrentInput.value : '';
      if(currentPassword) payload.currentPassword = currentPassword;
      this.disabled = true;
      try{
        const res = await fetch(PROJECT_ENDPOINTS.password || '/projects/password', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload),
        });
        const parsed = await parseJsonSafe(res);
        if(res.ok && (!parsed.json || parsed.json.success !== false)){
          if(projectPasswordModalEl){
            const modal = bootstrap.Modal.getInstance(projectPasswordModalEl);
            if(modal) modal.hide();
          }
          showStatus('项目密码已移除', 'success', 4000);
          updateProjectButtonLabel();
          await loadProjects();
          await loadProject();
        } else {
          const message = (parsed.json && parsed.json.error) ? parsed.json.error : (parsed.text || (`HTTP ${res.status}`));
          if(projectPasswordWarning){
            projectPasswordWarning.textContent = message;
            projectPasswordWarning.classList.remove('d-none');
          } else {
            showStatus('移除密码失败：' + message, 'danger', 6000);
          }
        }
      }catch(e){
        if(projectPasswordWarning){
          projectPasswordWarning.textContent = e.message;
          projectPasswordWarning.classList.remove('d-none');
        } else {
          showStatus('移除密码失败：' + e.message, 'danger', 6000);
        }
      }
      this.disabled = false;
    });
  }

  if(projectUnlockConfirmBtn){
    projectUnlockConfirmBtn.addEventListener('click', async function(){
      const name = projectUnlockTargetName || currentProject;
      const password = projectUnlockPasswordInput ? projectUnlockPasswordInput.value : '';
      if(!name){
        showStatus('请选择项目后再解锁', 'warning', 4000);
        return;
      }
      if(!password){
        if(projectUnlockErrorBox){
          projectUnlockErrorBox.textContent = '请输入密码';
          projectUnlockErrorBox.classList.remove('d-none');
        }
        return;
      }
      this.disabled = true;
      const original = this.textContent;
      this.textContent = '解锁中...';
      try{
        const res = await fetch(PROJECT_ENDPOINTS.unlock || '/projects/unlock', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({project: name, password}),
        });
        const parsed = await parseJsonSafe(res);
        if(res.ok && (!parsed.json || parsed.json.success !== false)){
          if(projectUnlockModalEl){
            const modal = bootstrap.Modal.getInstance(projectUnlockModalEl);
            if(modal) modal.hide();
          }
          showStatus('项目已解锁', 'success', 4000);
          projectUnlockTargetName = name;
          currentProject = name;
          handleLearningProjectSwitch(currentProject, {force: true});
          updateProjectButtonLabel();
          await loadProjects();
          await loadProject();
        } else {
          const message = (parsed.json && parsed.json.error) ? parsed.json.error : (parsed.text || (`HTTP ${res.status}`));
          if(projectUnlockErrorBox){
            projectUnlockErrorBox.textContent = message || '解锁失败';
            projectUnlockErrorBox.classList.remove('d-none');
          } else {
            showStatus('解锁失败：' + message, 'danger', 6000);
          }
        }
      }catch(e){
        if(projectUnlockErrorBox){
          projectUnlockErrorBox.textContent = e.message;
          projectUnlockErrorBox.classList.remove('d-none');
        } else {
          showStatus('解锁失败：' + e.message, 'danger', 6000);
        }
      }
      this.disabled = false;
      this.textContent = original || '解锁';
    });
  }

// load projects then project data
loadProjects().then(()=>{
  loadProject();
});

  
  document.getElementById('ai-optimize').onclick = function() {
    const content = pagesData[currentPageIdx]?.content || '';
    const note = pagesData[currentPageIdx]?.notes || '';
    this.disabled = true;
    this.textContent = '优化中...';
    fetch('/ai_optimize', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({latex: content, markdown: note, type: 'latex'})
    }).then(res => res.json()).then(data => {
      if(data.success && data.result) {
        document.getElementById('ai-result').value = data.result;
        var modal = new bootstrap.Modal(document.getElementById('aiModal'));
        modal.show();
      } else {
        alert('AI优化失败：' + (data.error || '未知错误'));
      }
    }).catch(()=>alert('AI请求失败')).finally(()=>{
      this.disabled = false;
      this.textContent = '代码优化';
    });
  };
  document.getElementById('apply-ai-result').onclick = function() {
    const val = document.getElementById('ai-result').value;
    if(val) {
      pagesData[currentPageIdx].content = val;
      renderSingleEditor();
      saveProject();
      queueCompile();
    }
    var modal = bootstrap.Modal.getInstance(document.getElementById('aiModal'));
    modal.hide();
  };

  // AI script optimization (讲稿)
  const aiScriptBtn = document.getElementById('ai-script-optimize');
  if(aiScriptBtn) aiScriptBtn.addEventListener('click', function(){
    const content = pagesData[currentPageIdx]?.script || '';
    const page_tex = pagesData[currentPageIdx]?.content || '';
    const note = pagesData[currentPageIdx]?.notes || '';
    this.disabled = true;
    this.textContent = '优化中...';
    fetch('/ai_optimize', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({script: content, latex: page_tex, markdown: note, type: 'script'})
    }).then(res => res.json()).then(data => {
      if(data.success && data.result) {
        document.getElementById('ai-script-result').value = data.result;
        var modal = new bootstrap.Modal(document.getElementById('aiScriptModal'));
        modal.show();
      } else {
        alert('AI讲稿优化失败：' + (data.error || '未知错误'));
      }
    }).catch(()=>alert('AI请求失败')).finally(()=>{
      this.disabled = false;
      this.textContent = '优化讲稿';
    });
  });

  document.getElementById('apply-ai-script-result').onclick = function(){
    const val = document.getElementById('ai-script-result').value;
    if(val){
      pagesData[currentPageIdx].script = val;
      document.getElementById('page-script').value = val;
      saveProject();
      queueCompile();
    }
    var modal = bootstrap.Modal.getInstance(document.getElementById('aiScriptModal'));
    modal.hide();
  };
  
  document.getElementById('ai-note-optimize').onclick = function() {
    const note = pagesData[currentPageIdx]?.notes || '';
    const page_tex = pagesData[currentPageIdx]?.content || '';
    this.disabled = true;
    this.textContent = '优化中...';
    fetch('/ai_optimize', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({markdown: note, latex: page_tex, type: 'note'})
  }).then(res => res.json()).then(data => {
      if(data.success && data.result) {
        document.getElementById('ai-note-result').value = data.result;
        var modal = new bootstrap.Modal(document.getElementById('aiNoteModal'));
        modal.show();
      } else {
        alert('AI优化失败：' + (data.error || '未知错误'));
      }
    }).catch(()=>alert('AI请求失败')).finally(()=>{
      this.disabled = false;
      this.textContent = '笔记优化';
    });
  };
  document.getElementById('apply-ai-note-result').onclick = function() {
    const val = document.getElementById('ai-note-result').value;
    if(val) {
      pagesData[currentPageIdx].notes = val;
      if(currentEditMode === 'markdown' && singleEditor) {
        singleEditor.setValue(val);
      }
      renderMarkdownPreview();
      saveProject();
      queueCompile();
    }
    var modal = bootstrap.Modal.getInstance(document.getElementById('aiNoteModal'));
    modal.hide();
  };

  const learningAssistantState = {
    modal: null,
    promptModal: null,
    loaded: false,
    loadingPrompts: false,
    prompts: [],
    promptsMap: new Map(),
    editingPrompt: null,
    project: '',
    pendingProject: '',
  };

  function handleLearningProjectSwitch(nextProject, options = {}) {
    const normalized = typeof nextProject === 'string' ? nextProject : '';
    const force = options && options.force === true;
    const changed = force || learningAssistantState.project !== normalized;
    learningAssistantState.pendingProject = normalized;
    if (changed) {
      learningAssistantState.loaded = false;
      learningAssistantState.prompts = [];
      learningAssistantState.promptsMap = new Map();
      if (typeof renderLearningPrompts === 'function') {
        renderLearningPrompts();
      }
    }
    return changed;
  }

  function ensureLearningModal() {
    if (!learningAssistantState.modal) {
      const modalEl = document.getElementById('aiLearnModal');
      if (!modalEl) return null;
      learningAssistantState.modal = new bootstrap.Modal(modalEl);
    }
    return learningAssistantState.modal;
  }

  function ensureLearningPromptModal() {
    if (!learningAssistantState.promptModal) {
      const modalEl = document.getElementById('aiLearnPromptModal');
      if (!modalEl) return null;
      learningAssistantState.promptModal = new bootstrap.Modal(modalEl);
    }
    return learningAssistantState.promptModal;
  }

  function getLearningSelection() {
    let selected = '';
    if (singleEditor && typeof singleEditor.getSelection === 'function') {
      selected = singleEditor.getSelection();
    }
    if (!selected) {
      try {
        selected = window.getSelection ? (window.getSelection()?.toString() || '') : '';
      } catch (e) {
        selected = '';
      }
    }
    return (selected || '').trim();
  }

  function buildLearningContext() {
    const page = pagesData[currentPageIdx] || {};
    const chunks = [];
    if (page.content) chunks.push('LaTeX:\n' + page.content);
    if (page.notes) chunks.push('Markdown:\n' + page.notes);
    if (page.script) chunks.push('Script:\n' + page.script);
    const context = chunks.join('\n\n');
    return context.length > 3000 ? context.slice(0, 3000) + '\n\n…（上下文已截断）' : context;
  }

  function updateLearningContext(auto = false, showMessage = false) {
    const contextEl = document.getElementById('ai-learn-context');
    if (!contextEl) return;
    if (auto) return;
    const context = buildLearningContext();
    contextEl.value = context || '';
    if (!showMessage) return;
    if (context) {
      showStatus('已获取当前页上下文', 'info', 2200);
    } else {
      showStatus('当前页没有可用的上下文', 'warning', 2500);
    }
  }

  function toPlainPos(pos) {
    if (!pos || typeof pos.line !== 'number' || typeof pos.ch !== 'number') return null;
    return {line: pos.line, ch: pos.ch};
  }

  function captureLearningApplyMeta() {
    const page = pagesData[currentPageIdx] || {};
    const meta = {
      pageIdx: currentPageIdx,
      pageId: typeof page.pageId === 'string' ? page.pageId : '',
      mode: currentEditMode,
      project: currentProject || '',
      selection: null,
      cursor: null,
    };
    if (!singleEditor || typeof singleEditor.getDoc !== 'function') {
      return meta;
    }
    const doc = singleEditor.getDoc();
    if (!doc) {
      return meta;
    }
    if (typeof doc.getCursor === 'function') {
      const cursor = toPlainPos(doc.getCursor());
      if (cursor) {
        meta.cursor = cursor;
      }
    }
    if (typeof doc.listSelections === 'function') {
      const selections = doc.listSelections();
      if (Array.isArray(selections) && selections.length) {
        const primary = selections[0];
        const anchorPos = toPlainPos(primary.anchor);
        const headPos = toPlainPos(primary.head);
        if (anchorPos && headPos) {
          const anchorIdx = doc.indexFromPos(anchorPos);
          const headIdx = doc.indexFromPos(headPos);
          if (anchorIdx !== headIdx) {
            const from = anchorIdx <= headIdx ? anchorPos : headPos;
            const to = anchorIdx <= headIdx ? headPos : anchorPos;
            meta.selection = {from, to};
          }
        }
      }
    }
    return meta;
  }

  function setLearningPrompts(prompts) {
    learningAssistantState.prompts = Array.isArray(prompts) ? prompts : [];
    learningAssistantState.promptsMap = new Map();
    learningAssistantState.prompts.forEach(item => {
      if (item && item.id) {
        learningAssistantState.promptsMap.set(item.id, item);
      }
    });
    renderLearningPrompts();
    const activeProject = typeof currentProject === 'string' ? currentProject : '';
    if (activeProject || learningAssistantState.pendingProject) {
      learningAssistantState.project = activeProject || learningAssistantState.pendingProject || '';
    }
    learningAssistantState.loaded = true;
  }

  async function loadLearningPrompts(force = false) {
    const targetProject = typeof currentProject === 'string' ? currentProject : '';
    const cacheValid = learningAssistantState.loaded && learningAssistantState.project === targetProject;
    if (!force && cacheValid) {
      return;
    }
    if (learningAssistantState.loadingPrompts) {
      learningAssistantState.pendingProject = targetProject;
      return;
    }
    learningAssistantState.loadingPrompts = true;
    learningAssistantState.pendingProject = targetProject;
    let staleResult = false;
    try {
      const res = await fetch('/learn/config');
      if (!res.ok) {
        throw new Error(`HTTP ${res.status}`);
      }
      const data = await res.json();
      if (!data || data.success === false || !Array.isArray(data.prompts)) {
        const message = data && data.error ? data.error : '未知错误';
        throw new Error(message);
      }
      const current = typeof currentProject === 'string' ? currentProject : '';
      if (learningAssistantState.pendingProject !== targetProject || targetProject !== current) {
        staleResult = true;
        return;
      }
      setLearningPrompts(data.prompts);
    } catch (err) {
      console.error('加载学习提示词失败:', err);
      showStatus('加载学习提示词失败：' + (err?.message || err || '未知错误'), 'danger', 6000);
    } finally {
      learningAssistantState.loadingPrompts = false;
      if (staleResult && learningAssistantState.pendingProject && learningAssistantState.pendingProject !== learningAssistantState.project) {
        loadLearningPrompts(true);
      }
    }
  }

  function renderLearningPrompts() {
    const defaultContainer = document.getElementById('ai-learn-default-prompts');
    const customContainer = document.getElementById('ai-learn-custom-prompts');
    if (defaultContainer) defaultContainer.innerHTML = '';
    if (customContainer) customContainer.innerHTML = '';
    const defaults = learningAssistantState.prompts.filter(item => item.source === 'default');
    const customs = learningAssistantState.prompts.filter(item => item.source === 'custom');
    if (defaultContainer) {
      if (!defaults.length) {
        defaultContainer.innerHTML = '<div class="text-muted small">暂无默认提示词。</div>';
      } else {
        defaults.forEach(prompt => {
          defaultContainer.appendChild(buildLearningPromptItem(prompt));
        });
      }
    }
    if (customContainer) {
      if (!customs.length) {
        customContainer.innerHTML = '<div class="text-muted small">尚未创建自定义提示词。</div>';
      } else {
        customs.forEach(prompt => {
          customContainer.appendChild(buildLearningPromptItem(prompt, true));
        });
      }
    }
  }

  function buildLearningPromptItem(prompt, stacked = false) {
    const wrapper = document.createElement('div');
    wrapper.className = stacked ? 'd-flex flex-column flex-sm-row align-items-sm-center gap-2' : 'd-flex flex-wrap align-items-center gap-2';
    wrapper.dataset.promptId = prompt.id || '';
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'btn btn-sm btn-outline-primary';
    btn.textContent = prompt.name || prompt.id;
    btn.addEventListener('click', () => runLearningPrompt(prompt, btn));
    wrapper.appendChild(btn);

    if (prompt.description) {
      const desc = document.createElement('small');
      desc.className = 'text-muted';
      desc.textContent = prompt.description;
      wrapper.appendChild(desc);
    }

    const actions = document.createElement('div');
    actions.className = 'btn-group btn-group-sm';
    const editBtn = document.createElement('button');
    editBtn.type = 'button';
    editBtn.className = 'btn btn-outline-secondary';
    editBtn.textContent = '编辑';
    editBtn.addEventListener('click', evt => {
      evt.stopPropagation();
      openPromptEditor(prompt);
    });
    actions.appendChild(editBtn);

    const delBtn = document.createElement('button');
    delBtn.type = 'button';
    delBtn.className = 'btn btn-outline-danger';
    delBtn.textContent = '删除';
    if (!prompt.allowDelete) {
      delBtn.disabled = true;
    }
    delBtn.addEventListener('click', evt => {
      evt.stopPropagation();
      deletePrompt(prompt);
    });
    actions.appendChild(delBtn);

    wrapper.appendChild(actions);
    return wrapper;
  }

  function openLearningModal() {
    const modal = ensureLearningModal();
    if (!modal) return;
    const contentEl = document.getElementById('ai-learn-content');
    if (contentEl) {
      const selection = getLearningSelection();
      if (selection) {
        contentEl.value = selection;
      } else if (!contentEl.value.trim()) {
        contentEl.value = '';
      }
    }
    updateLearningContext(true);
    updateLearningResultsPlaceholder();
    modal.show();
    loadLearningPrompts(false);
  }

  function updateLearningResultsPlaceholder() {
    const container = document.getElementById('ai-learn-results');
    const placeholder = document.getElementById('ai-learn-results-empty');
    if (!container || !placeholder) return;
    const hasCards = container.querySelector('.ai-learn-result');
    placeholder.classList.toggle('d-none', !!hasCards);
  }

  async function runLearningPrompt(prompt, triggerBtn) {
    const contentEl = document.getElementById('ai-learn-content');
    if (!contentEl) return;
    const baseContent = contentEl.value.trim();
    if (!baseContent) {
      alert('请输入或选择需要学习的内容');
      return;
    }
    const contextEl = document.getElementById('ai-learn-context');
    const baseContext = contextEl ? contextEl.value.trim() : '';
    const promptId = prompt ? prompt.id : '__raw__';
    const promptName = prompt ? prompt.name : '无提示词';
    const applyMeta = captureLearningApplyMeta();

    let buttonLabel = '';
    if (triggerBtn) {
      buttonLabel = triggerBtn.textContent;
      triggerBtn.disabled = true;
      triggerBtn.textContent = '学习中...';
    }
    try {
      const res = await fetch('/learn/query', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          content: baseContent,
          context: baseContext,
          promptId,
          promptName,
        }),
      });
      if (!res.ok) {
        const text = (await res.text()) || `HTTP ${res.status}`;
        throw new Error(text);
      }
      const data = await res.json();
      if (!data || data.success === false) {
        throw new Error((data && data.error) || 'AI 学习失败');
      }
      const resultText = data.result || '';
      appendLearningResultCard(
        { id: data.promptId || promptId, name: data.promptName || promptName },
        baseContent,
        baseContext,
        resultText,
        applyMeta
      );
    } catch (err) {
      console.error('AI 学习失败:', err);
      showStatus('AI 学习失败：' + (err?.message || err || '未知错误'), 'danger', 6000);
    } finally {
      if (triggerBtn) {
        triggerBtn.disabled = false;
        triggerBtn.textContent = buttonLabel || (prompt ? prompt.name : '无提示词');
      }
    }
  }

  function appendLearningResultCard(promptInfo, baseContent, baseContext, resultText, applyMeta = {}) {
    const container = document.getElementById('ai-learn-results');
    if (!container) return;
    const card = document.createElement('div');
    card.className = 'card shadow-sm ai-learn-result';
    card.dataset.promptId = promptInfo.id || '';
    card.dataset.promptName = promptInfo.name || '';
    card._payload = {
      content: baseContent,
      context: baseContext,
      mode: typeof applyMeta.mode === 'string' ? applyMeta.mode : currentEditMode,
      pageIdx: typeof applyMeta.pageIdx === 'number' ? applyMeta.pageIdx : currentPageIdx,
      pageId: typeof applyMeta.pageId === 'string' ? applyMeta.pageId : ((pagesData[currentPageIdx] && pagesData[currentPageIdx].pageId) || ''),
      project: typeof applyMeta.project === 'string' ? applyMeta.project : (currentProject || ''),
      selection: applyMeta.selection || null,
      cursor: applyMeta.cursor || null,
    };
    if (card._payload.pageId) {
      card.dataset.pageId = card._payload.pageId;
    }
    const header = document.createElement('div');
    header.className = 'card-header d-flex flex-wrap justify-content-between align-items-center gap-2';
    const title = document.createElement('div');
    title.innerHTML = `<strong>${promptInfo.name || '学习结果'}</strong> <span class="text-muted small ms-2">${new Date().toLocaleString()}</span>`;
    header.appendChild(title);
    const actions = document.createElement('div');
    actions.className = 'btn-group btn-group-sm';
    actions.innerHTML = `
      <button type="button" class="btn btn-outline-primary ai-learn-save-record">保存记录</button>
      <button type="button" class="btn btn-outline-secondary ai-learn-copy-result">复制</button>
      <button type="button" class="btn btn-outline-success ai-learn-apply-result">一键替换</button>
      <button type="button" class="btn btn-outline-danger ai-learn-remove-result">移除</button>
    `;
    header.appendChild(actions);
    card.appendChild(header);

    const body = document.createElement('div');
    body.className = 'card-body';
    const textarea = document.createElement('textarea');
    textarea.className = 'form-control ai-learn-result-text';
    textarea.rows = 12;
    textarea.value = resultText || '';
    body.appendChild(textarea);
    card.appendChild(body);

    container.prepend(card);
    updateLearningResultsPlaceholder();
  }

  function handleLearningResultsClick(event) {
    const target = event.target;
    const card = target.closest('.ai-learn-result');
    if (!card) return;
    if (target.closest('.ai-learn-save-record')) {
      saveLearningRecord(card, target.closest('button'));
    } else if (target.closest('.ai-learn-copy-result')) {
      const textarea = card.querySelector('.ai-learn-result-text');
      if (textarea) {
        navigator.clipboard.writeText(textarea.value).then(() => {
          showStatus('已复制学习结果', 'success', 3000);
        }).catch(err => {
          console.warn('复制失败', err);
          alert('复制失败，请手动复制。');
        });
      }
    } else if (target.closest('.ai-learn-apply-result')) {
      applyLearningResult(card);
    } else if (target.closest('.ai-learn-remove-result')) {
      card.remove();
      updateLearningResultsPlaceholder();
    }
  }

  function applyLearningResult(card) {
    const textarea = card.querySelector('.ai-learn-result-text');
    if (!textarea) {
      alert('无法读取学习结果内容');
      return;
    }
    const text = textarea.value;
    if (!text) {
      alert('学习结果为空，无法替换');
      return;
    }
    if (!singleEditor || typeof singleEditor.getDoc !== 'function') {
      alert('当前编辑器不可用，无法替换内容');
      return;
    }
    const payload = card._payload || {};
    const targetProject = typeof payload.project === 'string' ? payload.project : '';
    if (targetProject && currentProject && targetProject !== currentProject) {
      showStatus('当前项目已变更，请切换至生成该结果的项目后再试。', 'warning', 3200);
      return;
    }
    const targetMode = typeof payload.mode === 'string' ? payload.mode : '';
    if (targetMode && targetMode !== currentEditMode) {
      const modeLabel = targetMode === 'markdown' ? 'Markdown' : 'LaTeX';
      showStatus(`请先切换到 ${modeLabel} 编辑模式后再执行一键替换。`, 'warning', 3200);
      return;
    }
    const pageId = typeof payload.pageId === 'string' ? payload.pageId : '';
    const pageIdx = typeof payload.pageIdx === 'number' ? payload.pageIdx : null;
    const currentPage = pagesData[currentPageIdx] || {};
    const currentPageId = typeof currentPage.pageId === 'string' ? currentPage.pageId : '';
    if (pageId) {
      if (currentPageId && currentPageId !== pageId) {
        showStatus('请切换到生成该结果的页面后再执行一键替换。', 'warning', 3200);
        return;
      }
    } else if (pageIdx !== null && pageIdx !== currentPageIdx) {
      showStatus('请切换到生成该结果的页面后再执行一键替换。', 'warning', 3200);
      return;
    }
    const doc = singleEditor.getDoc();
    if (!doc) {
      alert('无法访问编辑器，替换失败');
      return;
    }
    const selection = payload.selection;
    const cursor = payload.cursor;
    const resolvePos = (pos) => {
      const plain = toPlainPos(pos);
      if (!plain) return null;
      return {line: plain.line, ch: plain.ch};
    };
    let from = selection && selection.from ? resolvePos(selection.from) : null;
    let to = selection && selection.to ? resolvePos(selection.to) : null;
    if (!from || !to) {
      const fallback = resolvePos(cursor) || resolvePos(doc.getCursor());
      from = fallback;
      to = fallback;
    }
    if (!from) {
      from = resolvePos(doc.getCursor());
      to = from;
    }
    if (!from || !to) {
      alert('未能确定替换位置，请手动粘贴结果。');
      return;
    }
    const startIndex = doc.indexFromPos(from);
    const endIndex = doc.indexFromPos(to);
    let start = from;
    let end = to;
    if (endIndex < startIndex) {
      start = to;
      end = from;
    }
    const startIdx = doc.indexFromPos(start);
    doc.replaceRange(text, start, end);
    const endPos = doc.posFromIndex(startIdx + text.length);
    doc.setSelection(start, endPos);
    if (typeof singleEditor.focus === 'function') {
      singleEditor.focus();
    }
    if (typeof singleEditor.scrollIntoView === 'function') {
      singleEditor.scrollIntoView({from: start, to: endPos});
    }
    showStatus('已将学习结果替换到编辑器', 'success', 2600);
  }

  async function saveLearningRecord(card, button) {
    const payload = card._payload || {};
    const textarea = card.querySelector('.ai-learn-result-text');
    if (!textarea) return;
    const output = textarea.value.trim();
    if (!output) {
      alert('请先填写要保存的学习结果文本');
      return;
    }
    if (button) {
      button.disabled = true;
      button.textContent = '保存中...';
    }
    try {
      const res = await fetch('/learn/record', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          content: payload.content || '',
          context: payload.context || '',
          promptId: card.dataset.promptId || '',
          promptName: card.dataset.promptName || '',
          output,
        }),
      });
      if (!res.ok) {
        const text = (await res.text()) || `HTTP ${res.status}`;
        throw new Error(text);
      }
      const data = await res.json();
      if (data && data.success === false) {
        throw new Error(data.error || '保存失败');
      }
      showStatus('学习记录已保存', 'success', 3000);
      if (button) {
        button.textContent = '已保存';
      }
    } catch (err) {
      console.error('保存学习记录失败:', err);
      showStatus('保存学习记录失败：' + (err?.message || err || '未知错误'), 'danger', 6000);
      if (button) {
        button.textContent = '保存记录';
      }
    } finally {
      if (button) {
        button.disabled = false;
      }
    }
  }

  function resetPromptEditor() {
    const nameEl = document.getElementById('ai-learn-prompt-name');
    const descEl = document.getElementById('ai-learn-prompt-description');
    const sysEl = document.getElementById('ai-learn-prompt-system');
    const tplEl = document.getElementById('ai-learn-prompt-template');
    if (nameEl) nameEl.value = '';
    if (descEl) descEl.value = '';
    if (sysEl) sysEl.value = '';
    if (tplEl) tplEl.value = '请针对以下内容提供学习说明：\n{content}\n\n上下文：\n{context}\n';
  }

  function openPromptEditor(prompt) {
    const modal = ensureLearningPromptModal();
    if (!modal) return;
    resetPromptEditor();
    learningAssistantState.editingPrompt = prompt || null;
    const title = document.getElementById('aiLearnPromptModalLabel');
    if (title) title.textContent = prompt ? '编辑提示词' : '新增提示词';
    if (prompt) {
      const nameEl = document.getElementById('ai-learn-prompt-name');
      const descEl = document.getElementById('ai-learn-prompt-description');
      const sysEl = document.getElementById('ai-learn-prompt-system');
      const tplEl = document.getElementById('ai-learn-prompt-template');
      if (nameEl) nameEl.value = prompt.name || '';
      if (descEl) descEl.value = prompt.description || '';
      if (sysEl) sysEl.value = prompt.system || '';
      if (tplEl) tplEl.value = prompt.template || '';
    }
    modal.show();
  }

  async function submitPromptEditor() {
    const nameEl = document.getElementById('ai-learn-prompt-name');
    const tplEl = document.getElementById('ai-learn-prompt-template');
    if (!nameEl || !tplEl) return;
    const name = nameEl.value.trim();
    const template = tplEl.value.trim();
    if (!name || !template) {
      alert('提示词名称和模板均不能为空');
      return;
    }
    const descEl = document.getElementById('ai-learn-prompt-description');
    const sysEl = document.getElementById('ai-learn-prompt-system');
    const description = descEl ? descEl.value.trim() : '';
    const systemText = sysEl ? sysEl.value.trim() : '';
    const payload = {
      name,
      template,
      description,
      system: systemText,
    };
    const isEdit = !!learningAssistantState.editingPrompt;
    const url = isEdit ? `/learn/prompts/${encodeURIComponent(learningAssistantState.editingPrompt.id)}` : '/learn/prompts';
    const method = isEdit ? 'PUT' : 'POST';
    try {
      const res = await fetch(url, {
        method,
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload),
      });
      if (!res.ok) {
        const text = (await res.text()) || `HTTP ${res.status}`;
        throw new Error(text);
      }
      const data = await res.json();
      if (!data || data.success === false) {
        throw new Error((data && data.error) || '保存提示词失败');
      }
      if (Array.isArray(data.prompts)) {
        learningAssistantState.loaded = true;
        setLearningPrompts(data.prompts);
      }
      showStatus(isEdit ? '提示词已更新' : '提示词已创建', 'success', 3000);
      learningAssistantState.editingPrompt = null;
      const modal = ensureLearningPromptModal();
      if (modal) modal.hide();
    } catch (err) {
      console.error('保存提示词失败:', err);
      alert('保存提示词失败：' + (err?.message || err || '未知错误'));
    }
  }

  async function deletePrompt(prompt) {
    if (!prompt || !prompt.id) return;
    if (!confirm(`确定要删除提示词“${prompt.name || prompt.id}”吗？`)) return;
    try {
      const res = await fetch(`/learn/prompts/${encodeURIComponent(prompt.id)}`, {
        method: 'DELETE',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({}),
      });
      if (!res.ok) {
        const text = (await res.text()) || `HTTP ${res.status}`;
        throw new Error(text);
      }
      const data = await res.json();
      if (!data || data.success === false) {
        throw new Error((data && data.error) || '删除失败');
      }
      if (Array.isArray(data.prompts)) {
        learningAssistantState.loaded = true;
        setLearningPrompts(data.prompts);
      }
      showStatus('提示词已删除', 'success', 3000);
    } catch (err) {
      console.error('删除提示词失败:', err);
      alert('删除提示词失败：' + (err?.message || err || '未知错误'));
    }
  }

  const aiLearnBtn = document.getElementById('ai-learn-helper');
  if (aiLearnBtn) {
    aiLearnBtn.addEventListener('click', openLearningModal);
  }

  const aiLearnFillSelection = document.getElementById('ai-learn-fill-selection');
  if (aiLearnFillSelection) {
    aiLearnFillSelection.addEventListener('click', () => {
      const contentEl = document.getElementById('ai-learn-content');
      if (!contentEl) return;
      const selection = getLearningSelection();
      if (selection) {
        contentEl.value = selection;
        showStatus('已填充选中的内容', 'info', 2000);
      } else {
        showStatus('未检测到选中的文本，请手动粘贴。', 'warning', 3000);
      }
    });
  }

  const aiLearnFetchContext = document.getElementById('ai-learn-fetch-context');
  if (aiLearnFetchContext) {
    aiLearnFetchContext.addEventListener('click', () => {
      updateLearningContext(false, true);
    });
  }

  const aiLearnRefreshBtn = document.getElementById('ai-learn-refresh-prompts');
  if (aiLearnRefreshBtn) {
    aiLearnRefreshBtn.addEventListener('click', () => loadLearningPrompts(true));
  }

  const aiLearnAddPromptBtn = document.getElementById('ai-learn-add-prompt');
  if (aiLearnAddPromptBtn) {
    aiLearnAddPromptBtn.addEventListener('click', () => openPromptEditor(null));
  }

  const aiLearnRawBtn = document.getElementById('ai-learn-run-raw');
  if (aiLearnRawBtn) {
    aiLearnRawBtn.addEventListener('click', () => runLearningPrompt(null, aiLearnRawBtn));
  }

  const aiLearnPromptSaveBtn = document.getElementById('ai-learn-prompt-save');
  if (aiLearnPromptSaveBtn) {
    aiLearnPromptSaveBtn.addEventListener('click', submitPromptEditor);
  }

  const aiLearnResults = document.getElementById('ai-learn-results');
  if (aiLearnResults) {
    aiLearnResults.addEventListener('click', handleLearningResultsClick);
  }

  const aiLearnModalEl = document.getElementById('aiLearnModal');
  if (aiLearnModalEl) {
    aiLearnModalEl.addEventListener('shown.bs.modal', () => {
      const contentEl = document.getElementById('ai-learn-content');
      if (contentEl) {
        contentEl.focus();
      }
      updateLearningContext(true);
    });
  }

  const aiLearnPromptModalEl = document.getElementById('aiLearnPromptModal');
  if (aiLearnPromptModalEl) {
    aiLearnPromptModalEl.addEventListener('hidden.bs.modal', () => {
      learningAssistantState.editingPrompt = null;
    });
  }

  document.getElementById('play-note').onclick = function() {
    const script = pagesData[currentPageIdx]?.script || '';
    if(!script.trim()) return alert('当前页讲稿为空');
    this.disabled = true;
    this.textContent = '生成中...';
    fetch('/tts', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({text: script})
    }).then(res=>res.json()).then(data=>{
      if(data.success && data.audio) {
        const audio = new Audio('data:audio/mp3;base64,' + data.audio);
        audio.play();
      } else {
        alert('TTS失败：'+(data.error||'未知错误'));
      }
    }).catch(()=>alert('TTS请求失败')).finally(()=>{
      this.disabled = false;
      this.textContent = '播放笔记';
    });
  };
  
  // legacy export-audio removed (use unified export modal)
  
  
  function normalizeBibEntry(raw) {
    if (!raw) return null;
    let entryText = '';
    let note = '';
    let label = '';
    let link = '';
    let id = '';
    let metadata = null;

    if (typeof raw === 'string') {
      entryText = raw;
    } else if (typeof raw === 'object') {
      entryText = (raw.entry || raw.bib || '').trim();
      note = (raw.note || '').trim();
      label = (raw.label || raw.name || raw.title || '').trim();
      link = (raw.link || '').trim();
      id = (raw.id || '').trim();
      if (raw.metadata && typeof raw.metadata === 'object' && !Array.isArray(raw.metadata)) {
        try {
          metadata = JSON.parse(JSON.stringify(raw.metadata));
        } catch (e) {
          metadata = {...raw.metadata};
        }
      }
    }

    entryText = (entryText || '').trim();
    const hasInfo = entryText || note || label || link || (metadata && Object.keys(metadata).length);
    if (!hasInfo) return null;

    const keyMatch = entryText.match(/@\w+\s*\{\s*([^,\s]+)/);
    if (!id) {
      id = keyMatch && keyMatch[1] ? keyMatch[1].trim() : '';
    }
    if (!id) {
      id = `ref${Date.now()}${Math.floor(Math.random() * 1000)}`;
    }

    if (!label) {
      const titleMatch = entryText.match(/title\s*=\s*[{"]([^}\"]+)[}"]/i);
      label = titleMatch && titleMatch[1] ? titleMatch[1].trim() : id;
    }

    if (!link) {
      const urlMatch = entryText.match(/url\s*=\s*[{"]([^}\"]+)[}"]/i);
      if (urlMatch && urlMatch[1]) {
        link = urlMatch[1].split('?')[0].split('#')[0].trim();
      } else {
        const doiMatch = entryText.match(/doi\s*=\s*[{"]([^}\"]+)[}"]/i);
        if (doiMatch && doiMatch[1]) {
          link = `https://doi.org/${doiMatch[1].trim()}`;
        }
      }
    }

    return {
      id,
      entry: entryText,
      label,
      note,
      link,
      metadata: metadata || null,
    };
  }

  function normalizeBibList(list) {
    if (!Array.isArray(list)) return [];
    const seen = new Set();
    const normalized = [];
    list.forEach(item => {
      const entry = normalizeBibEntry(item);
      if (!entry) return;
      if (seen.has(entry.id)) return;
      seen.add(entry.id);
      normalized.push(entry);
    });
    return normalized;
  }

  function findBibIndex(collection, id) {
    return collection.findIndex(item => item && item.id === id);
  }

  function insertBibIntoEditor(entry, mode) {
    if (!singleEditor || !entry) return;
    const doc = singleEditor.getDoc();
    const cursor = doc.getCursor();
    const label = entry.label || entry.id;
    const format = mode || (currentEditMode === 'markdown' ? 'markdown' : 'latex');
    if (format === 'markdown') {
      let snippet = entry.link ? `[${label}](${entry.link})` : `[${label}]`;
      if (entry.note) snippet += ` (${entry.note})`;
      doc.replaceRange(snippet + ' ', cursor);
    } else {
      let snippet = entry.link ? `\\href{${entry.link}}{${label}}` : `\\cite{${entry.id}}`;
      if (entry.note && entry.link) {
        snippet += `\\footnote{${entry.note}}`;
      }
      doc.replaceRange(snippet + ' ', cursor);
    }
  }

  let bibData = [];
  const bibEditState = { entry: null, scope: 'page' };
  let bibEditModalInstance = null;

  function getBibEditModal() {
    const modalEl = document.getElementById('bibEntryModal');
    if (!modalEl) return null;
    if (!bibEditModalInstance) {
      bibEditModalInstance = new bootstrap.Modal(modalEl);
      modalEl.addEventListener('hidden.bs.modal', () => {
        bibEditState.entry = null;
        bibEditState.scope = 'page';
        const labelInput = document.getElementById('bib-edit-label');
        const noteInput = document.getElementById('bib-edit-note');
        const infoEl = document.getElementById('bib-edit-details');
        if (labelInput) labelInput.value = '';
        if (noteInput) noteInput.value = '';
        if (infoEl) infoEl.innerHTML = '<div class="text-muted">暂无文献信息</div>';
      });
    }
    return bibEditModalInstance;
  }

  function buildBibMetadataHtml(entry, scope) {
    const infoChunks = [];
    if (scope) {
      const scopeLabel = scope === 'page' ? '所属：本页' : '所属：全局';
      infoChunks.push(`<div class="mb-2 text-muted small">${scopeLabel}</div>`);
    }
    const idText = entry.id ? escapeHtml(entry.id) : '—';
    infoChunks.push(`<div class="mb-2"><div class="text-muted small">引用标识</div><div>${idText}</div></div>`);
    if (entry.link) {
      const safeLink = escapeHtml(entry.link);
      infoChunks.push(`<div class="mb-2"><div class="text-muted small">链接</div><div><a href="${safeLink}" target="_blank" rel="noopener">${safeLink}</a></div></div>`);
    }
    const metadata = entry.metadata && typeof entry.metadata === 'object' ? entry.metadata : null;
    if (metadata) {
      if (Array.isArray(metadata.authors) && metadata.authors.length) {
        infoChunks.push(`<div class="mb-2"><div class="text-muted small">作者</div><div>${escapeHtml(metadata.authors.join(', '))}</div></div>`);
      }
      if (metadata.venue) {
        infoChunks.push(`<div class="mb-2"><div class="text-muted small">发表</div><div>${escapeHtml(metadata.venue)}</div></div>`);
      }
      if (metadata.year) {
        infoChunks.push(`<div class="mb-2"><div class="text-muted small">年份</div><div>${escapeHtml(String(metadata.year))}</div></div>`);
      }
      if (metadata.doi) {
        const trimmedDoi = String(metadata.doi).trim();
        const doiLink = trimmedDoi ? `https://doi.org/${trimmedDoi}` : '';
        const doiHtml = trimmedDoi ? `<a href="${escapeHtml(doiLink)}" target="_blank" rel="noopener">${escapeHtml(trimmedDoi)}</a>` : '—';
        infoChunks.push(`<div class="mb-2"><div class="text-muted small">DOI</div><div>${doiHtml}</div></div>`);
      }
      const extraKeys = Object.keys(metadata).filter(k => !['authors', 'venue', 'year', 'doi'].includes(k));
      extraKeys.forEach(key => {
        const value = metadata[key];
        if (value === undefined || value === null) return;
        const text = typeof value === 'string' ? value : JSON.stringify(value, null, 2);
        infoChunks.push(`<div class="mb-2"><div class="text-muted small">${escapeHtml(key)}</div><div>${escapeHtml(text)}</div></div>`);
      });
    }
    if (entry.entry) {
      const raw = escapeHtml(entry.entry);
      infoChunks.push(`<div class="mb-0"><div class="text-muted small">原始 BibTeX</div><pre class="mb-0 small bg-white border rounded p-2">${raw}</pre></div>`);
    }
    if (!infoChunks.length) {
      infoChunks.push('<div class="text-muted">暂无文献信息</div>');
    }
    return infoChunks.join('');
  }

  function openBibEditModal(entry, scope) {
    const modal = getBibEditModal();
    if (!modal || !entry) return;
    bibEditState.entry = entry;
    bibEditState.scope = scope;
    const labelInput = document.getElementById('bib-edit-label');
    const noteInput = document.getElementById('bib-edit-note');
    if (labelInput) labelInput.value = entry.label || '';
    if (noteInput) noteInput.value = entry.note || '';
    const infoEl = document.getElementById('bib-edit-details');
    if (infoEl) infoEl.innerHTML = buildBibMetadataHtml(entry, scope);
    modal.show();
  }

  function currentPageBib() {
    if (!pagesData[currentPageIdx]) {
      pagesData[currentPageIdx] = {content: '', script: '', notes: '', bib: [], resources: [], pageId: generatePageId()};
    }
    if (!Array.isArray(pagesData[currentPageIdx].bib)) {
      pagesData[currentPageIdx].bib = [];
    }
    pagesData[currentPageIdx].bib = normalizeBibList(pagesData[currentPageIdx].bib);
    return pagesData[currentPageIdx].bib;
  }

  function saveGlobalBib() {
    const payload = { bib: bibData };
    return fetch(PROJECT_ENDPOINTS.projectSave || '/project', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    });
  }

  function clearBibForm() {
    document.getElementById('bib-input').value = '';
    document.getElementById('bib-label-input').value = '';
    document.getElementById('bib-note-input').value = '';
  }

  function renderBibList() {
    const pageList = document.getElementById('bib-page-list');
    const globalList = document.getElementById('bib-global-list');
    const pageCount = document.getElementById('bib-page-count');
    const globalCount = document.getElementById('bib-global-count');
    const pageEntries = currentPageBib();
    bibData = normalizeBibList(bibData);

    pageList.innerHTML = '';
    globalList.innerHTML = '';
    if (pageCount) pageCount.textContent = pageEntries.length ? `${pageEntries.length} 条` : '暂无';
    if (globalCount) globalCount.textContent = bibData.length ? `${bibData.length} 条` : '暂无';

    const buildItem = (entry, scope) => {
      const item = document.createElement('div');
      item.className = 'list-group-item';

      const header = document.createElement('div');
      header.className = 'd-flex justify-content-between align-items-start gap-2';

      const meta = document.createElement('div');
      meta.className = 'flex-grow-1';
      const title = document.createElement('div');
      title.className = 'fw-semibold';
      if (entry.link) {
        const anchor = document.createElement('a');
        anchor.href = entry.link;
        anchor.target = '_blank';
        anchor.rel = 'noopener';
        anchor.textContent = entry.label || entry.id;
        title.appendChild(anchor);
      } else {
        title.textContent = entry.label || entry.id;
      }
      meta.appendChild(title);

      if (entry.note) {
        const note = document.createElement('div');
        note.className = 'text-muted small';
        note.textContent = entry.note;
        meta.appendChild(note);
      }

      const idLine = document.createElement('div');
      idLine.className = 'text-muted small';
      idLine.textContent = scope === 'page' ? `本页 · ${entry.id}` : `全局 · ${entry.id}`;
      meta.appendChild(idLine);

      if (entry.metadata) {
        const infoParts = [];
        const authors = Array.isArray(entry.metadata.authors) ? entry.metadata.authors : [];
        if (authors.length) {
          const shortAuthors = authors.slice(0, 3).join(', ');
          infoParts.push(authors.length > 3 ? `${shortAuthors} 等` : shortAuthors);
        }
        if (entry.metadata.venue) infoParts.push(entry.metadata.venue);
        if (entry.metadata.year) infoParts.push(entry.metadata.year);
        if (entry.metadata.doi) infoParts.push(entry.metadata.doi);
        if (infoParts.length) {
          const metaLine = document.createElement('div');
          metaLine.className = 'text-muted small';
          metaLine.textContent = infoParts.join(' · ');
          meta.appendChild(metaLine);
        }
      }

      header.appendChild(meta);

      const actions = document.createElement('div');
      actions.className = 'd-flex flex-column gap-1';

      const insertBtn = document.createElement('button');
      insertBtn.type = 'button';
      insertBtn.className = 'btn btn-sm btn-outline-primary';
      insertBtn.textContent = '插入引用';
      insertBtn.onclick = () => insertBibIntoEditor(entry);
      actions.appendChild(insertBtn);

      const editBtn = document.createElement('button');
      editBtn.type = 'button';
      editBtn.className = 'btn btn-sm btn-outline-secondary';
      editBtn.textContent = '编辑信息';
      editBtn.onclick = () => openBibEditModal(entry, scope);
      actions.appendChild(editBtn);

      const deleteBtn = document.createElement('button');
      deleteBtn.type = 'button';
      deleteBtn.className = 'btn btn-sm btn-outline-danger';
      deleteBtn.textContent = '删除';
      deleteBtn.onclick = () => {
        if (!confirm('确认删除这条文献吗？')) return;
        if (scope === 'page') {
          const idx = findBibIndex(pageEntries, entry.id);
          if (idx > -1) {
            pageEntries.splice(idx, 1);
            saveProject();
            queueCompile();
          }
        } else {
          const idx = findBibIndex(bibData, entry.id);
          if (idx > -1) {
            bibData.splice(idx, 1);
            saveGlobalBib();
          }
        }
        renderBibList();
      };
      actions.appendChild(deleteBtn);

      header.appendChild(actions);
      item.appendChild(header);
      return item;
    };

    pageEntries.forEach(entry => {
      const item = buildItem(entry, 'page');
      pageList.appendChild(item);
    });

    bibData.forEach(entry => {
      const item = buildItem(entry, 'global');
      globalList.appendChild(item);
    });
  }

  document.getElementById('edit-bib').onclick = function() {
    fetch(PROJECT_ENDPOINTS.project || '/project').then(res=>res.json()).then(data=>{
      bibData = normalizeBibList(data.bib || []);
      renderBibList();
      var modal = new bootstrap.Modal(document.getElementById('bibModal'));
      modal.show();
    });
  };

  const bibEditSaveBtn = document.getElementById('bib-edit-save');
  if (bibEditSaveBtn) {
    bibEditSaveBtn.addEventListener('click', () => {
      const entry = bibEditState.entry;
      if (!entry) return;
      const labelInput = document.getElementById('bib-edit-label');
      const noteInput = document.getElementById('bib-edit-note');
      const newLabel = labelInput ? labelInput.value.trim() : '';
      const newNote = noteInput ? noteInput.value.trim() : '';
      entry.label = newLabel || entry.id;
      if (newNote) {
        entry.note = newNote;
      } else {
        delete entry.note;
      }
      if (bibEditState.scope === 'page') {
        saveProject();
        queueCompile();
      } else {
        saveGlobalBib();
      }
      renderBibList();
      const modal = getBibEditModal();
      if (modal) modal.hide();
    });
  }

  document.getElementById('add-bib-btn').onclick = function() {
    const val = document.getElementById('bib-input').value.trim();
    if(!val) return;
    this.disabled = true;
    this.textContent = '生成中...';
    const scope = document.getElementById('bib-scope').value;
    const labelInput = document.getElementById('bib-label-input');
    const noteInput = document.getElementById('bib-note-input');
    fetch('/ai_bib', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ref: val})
    }).then(res=>res.json()).then(data=>{
      if(data.success && (data.entry || data.bib)) {
        const payload = data.entry ? {...data.entry} : {entry: data.bib};
        if (labelInput.value.trim()) payload.label = labelInput.value.trim();
        if (noteInput.value.trim()) payload.note = noteInput.value.trim();
        if (!payload.link && val.startsWith('http')) payload.link = val;
        const entry = normalizeBibEntry(payload);
        if(entry){
          if(scope === 'page') {
            const pageEntries = currentPageBib();
            pageEntries.push(entry);
            saveProject();
            queueCompile();
          } else {
            bibData.push(entry);
            saveGlobalBib();
          }
        }
        renderBibList();
        clearBibForm();
      } else {
        alert('AI生成失败：'+(data.error||'未知错误'));
      }
    }).catch(()=>alert('AI请求失败')).finally(()=>{
      this.disabled = false;
      this.textContent = 'AI生成';
    });
  };

  document.getElementById('add-url-bib-btn').onclick = function() {
    let val = document.getElementById('bib-input').value.trim();
    if(!val) return;
    const scope = document.getElementById('bib-scope').value;
    const labelInput = document.getElementById('bib-label-input');
    const noteInput = document.getElementById('bib-note-input');
    let cleanVal = val;
    try {
      const parsed = new URL(cleanVal);
      parsed.search = '';
      parsed.hash = '';
      cleanVal = parsed.toString();
    } catch(e) {
      const noQuery = cleanVal.split('?')[0];
      cleanVal = noQuery.split('#')[0];
    }
    const bib = `@misc{url${Date.now()},\n  url={${cleanVal}}\n}`;
    const entry = normalizeBibEntry({
      entry: bib,
      label: labelInput.value,
      note: noteInput.value,
      link: cleanVal,
      metadata: {
        type: 'web',
        source: 'manual',
      },
    });
    if(entry){
      if(scope === 'page') {
        const pageEntries = currentPageBib();
        pageEntries.push(entry);
        saveProject();
        queueCompile();
      } else {
        bibData.push(entry);
        saveGlobalBib();
      }
    }
    renderBibList();
    clearBibForm();
  };

  // Resource upload & listing
  function getCurrentPageIndex() {
    return currentPageIdx; // zero-based
  }

  async function parseJsonSafe(input) {
    if (input instanceof Response) {
      try {
        const json = await input.clone().json();
        return { json };
      } catch (e) {
        try {
          const text = await input.clone().text();
          return { text };
        } catch (_) {
          return { text: '' };
        }
      }
    }
    if (typeof input === 'string') {
      try {
        return { json: JSON.parse(input) };
      } catch (e) {
        return { text: input };
      }
    }
    return { text: String(input || '') };
  }

  function urlToLatexPath(url){
    if(!url) return '';
    const withoutQuery = url.split('?')[0];
    const normalized = withoutQuery.replace(/\\/g, '/');
    const parts = normalized.split('/').filter(Boolean);
    return parts.length ? parts[parts.length - 1] : normalized;
  }

  async function refreshResourceLists() {
    // If resources modal is open, refresh its content. Otherwise no-op.
    const modalEl = document.getElementById('resourcesModal');
    if(modalEl && bootstrap.Modal.getInstance(modalEl)){
      await loadResourcesModal();
    }
  }

  // Manage Resources Modal handlers
  document.getElementById('manage-resources').addEventListener('click', async function(){
    await loadResourcesModal();
    var modal = new bootstrap.Modal(document.getElementById('resourcesModal'));
    modal.show();
  });

  function createResourceListItem(file, options){
    const f = file || {};
    const opts = options || {};
    const scope = typeof opts.scope === 'string' ? opts.scope : '';
    const pageIndex = typeof opts.pageIndex === 'number' ? opts.pageIndex : null;
    const item = document.createElement('div');
    item.className = 'list-group-item resource-item';
    const wrapper = document.createElement('div');
    wrapper.className = 'd-flex flex-column flex-md-row justify-content-between align-items-start gap-2';
    const left = document.createElement('div');
    left.className = 'resource-name me-md-3 flex-grow-1';
    const name = document.createElement('a');
    const localUrl = f.localUrl || '';
    const ossUrl = f.ossUrl || '';
    const preferredUrl = f.url || f.preferredUrl || localUrl || ossUrl || '';
    const hasLocal = !!localUrl && f.exists !== false ? true : !!localUrl;
    const hasRemote = !!ossUrl;
    name.href = preferredUrl || '#';
    name.textContent = f.name || '';
    if(preferredUrl){
      name.target = '_blank';
    } else {
      name.classList.add('disabled');
    }
    if(!hasLocal){
      name.classList.add('text-muted');
      name.title = hasRemote ? '本地缺失，仅 OSS 可用' : '文件缺失';
    }
    left.appendChild(name);

    if(f.location){
      const badge = document.createElement('span');
      badge.className = 'badge rounded-pill ms-2';
      if(f.location === 'synced'){
        badge.classList.add('bg-success');
        badge.textContent = '已同步';
      } else if(f.location === 'local'){
        badge.classList.add('bg-secondary');
        badge.textContent = '仅本地';
      } else if(f.location === 'oss'){
        badge.classList.add('bg-info');
        badge.textContent = '仅 OSS';
      } else {
        badge.classList.add('bg-warning');
        badge.textContent = '缺失';
      }
      left.appendChild(badge);
    } else if(!hasLocal || hasRemote){
      const badge = document.createElement('span');
      badge.className = 'badge rounded-pill ms-2';
      if(!hasLocal && hasRemote){
        badge.classList.add('bg-info', 'text-dark');
        badge.textContent = '仅 OSS';
      } else if(!hasLocal){
        badge.classList.add('bg-warning', 'text-dark');
        badge.textContent = '缺失';
      } else {
        badge.classList.add('bg-secondary');
        badge.textContent = '仅本地';
      }
      left.appendChild(badge);
    }

    if(ossUrl){
      const remoteLink = document.createElement('div');
      remoteLink.className = 'small text-muted';
      const label = hasLocal ? '远程：' : 'OSS：';
      remoteLink.innerHTML = `${label}<a href="${ossUrl}" target="_blank">${ossUrl}</a>`;
      left.appendChild(remoteLink);
    }

    if(typeof f.refCount === 'number'){
      const usageBadge = document.createElement('span');
      usageBadge.className = 'badge rounded-pill ms-2 ' + (f.refCount > 0 ? 'bg-primary' : 'bg-secondary');
      usageBadge.textContent = f.refCount > 0 ? `引用 ${f.refCount}` : '未引用';
      const usagePieces = [];
      if(Array.isArray(f.usedOnPages) && f.usedOnPages.length){
        usagePieces.push(`页面：${f.usedOnPages.join('、')}`);
      }
      if(f.usedGlobally){
        usagePieces.push('全局资源列表');
      }
      if(usagePieces.length){
        usageBadge.title = usagePieces.join('；');
      }
      left.appendChild(usageBadge);
    }

    if(scope === 'page' && Array.isArray(f.otherPages) && f.otherPages.length){
      const info = document.createElement('div');
      info.className = 'small text-muted';
      info.textContent = `同时用于页面：${f.otherPages.join('、')}`;
      left.appendChild(info);
    } else if(scope !== 'page' && Array.isArray(f.usedOnPages) && f.usedOnPages.length){
      const info = document.createElement('div');
      info.className = 'small text-muted';
      info.textContent = `引用页面：${f.usedOnPages.join('、')}`;
      left.appendChild(info);
    } else if(scope === 'page' && f.usedGlobally){
      const info = document.createElement('div');
      info.className = 'small text-muted';
      info.textContent = '同时存在于全局资源';
      left.appendChild(info);
    }

    const actions = document.createElement('div');
    actions.className = 'resource-actions d-flex flex-wrap gap-1';
    const isImage = /\.(png|jpe?g|gif|svg|webp|bmp|heic|heif)$/i.test((f.name || '').toString());
    const targetUrl = f.localUrl || f.ossUrl || preferredUrl;

    const previewBtn = document.createElement('button');
    previewBtn.className = 'btn btn-sm btn-outline-secondary';
    previewBtn.textContent = '预览';
    previewBtn.onclick = function(){
      if(isImage && resourcePreviewModalEl && resourcePreviewImage){
        if(!targetUrl){
          alert('当前资源没有可用的链接');
          return;
        }
        resourcePreviewImage.src = targetUrl;
        if(resourcePreviewMeta){
          const parts = [];
          parts.push(f.exists ? '来源：本地' : (f.ossUrl ? '来源：OSS' : '来源：未知'));
          if(f.ossUrl && f.exists){
            parts.push('已同步');
          }
          resourcePreviewMeta.textContent = `${f.name}${parts.length ? '（' + parts.join('，') + '）' : ''}`;
        }
        if(resourcePreviewOpen){
          resourcePreviewOpen.href = targetUrl;
          resourcePreviewOpen.classList.toggle('disabled', !targetUrl);
        }
        const modal = bootstrap.Modal.getOrCreateInstance(resourcePreviewModalEl);
        modal.show();
      } else {
        if(targetUrl){
          window.open(targetUrl, '_blank');
        } else {
          alert('当前资源没有可用的链接');
        }
      }
    };
    if(!targetUrl){
      previewBtn.disabled = true;
    }

    const openBtn = document.createElement('button');
    openBtn.className = 'btn btn-sm btn-outline-secondary';
    openBtn.textContent = '打开';
    openBtn.onclick = function(){
      if(preferredUrl){
        window.open(preferredUrl, '_blank');
      } else {
        alert('当前资源没有可用的链接');
      }
    };
    if(!preferredUrl){
      openBtn.disabled = true;
    }

    const copyBtn = document.createElement('button');
    copyBtn.className = 'btn btn-sm btn-outline-primary';
    copyBtn.textContent = '复制链接';
    copyBtn.onclick = function(){
      if(!preferredUrl){ alert('当前资源没有可用的链接'); return; }
      navigator.clipboard.writeText(preferredUrl).then(()=>{
        copyBtn.textContent = '已复制';
        setTimeout(()=>{ copyBtn.textContent = '复制链接'; }, 2000);
      }).catch(()=>alert('复制失败，请手动复制链接'));
    };

    const copyOssBtn = document.createElement('button');
    copyOssBtn.className = 'btn btn-sm btn-outline-primary';
    copyOssBtn.textContent = '拷贝 OSS 链接';
    copyOssBtn.onclick = function(){
      if(!ossUrl){ alert('当前资源没有 OSS 链接'); return; }
      navigator.clipboard.writeText(ossUrl).then(()=>{
        copyOssBtn.textContent = '已复制';
        setTimeout(()=>{ copyOssBtn.textContent = '拷贝 OSS 链接'; }, 2000);
      }).catch(()=>alert('复制失败，请手动复制链接'));
    };
    if(!ossUrl){
      copyOssBtn.disabled = true;
    }

    const renameBtn = document.createElement('button');
    renameBtn.className = 'btn btn-sm btn-outline-secondary';
    renameBtn.textContent = '重命名';
    renameBtn.onclick = function(){
      if(!resourceRenameModalEl || !resourceRenameInput){
        alert('当前界面不支持重命名');
        return;
      }
      resourceRenameTarget = f.name;
      resourceRenameInput.value = f.name || '';
      if(resourceRenamePreview) resourceRenamePreview.textContent = f.name ? `完整名称：${f.name}` : '';
      if(f.name){
        resourceRenameInput.title = f.name;
      } else {
        resourceRenameInput.removeAttribute('title');
      }
      const modal = bootstrap.Modal.getOrCreateInstance(resourceRenameModalEl);
      modal.show();
    };

    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'btn btn-sm btn-outline-danger';
    deleteBtn.textContent = scope === 'page' ? '移除关联' : (scope === 'global' ? '移除全局' : '删除');
    deleteBtn.onclick = async function(){
      const confirmText = scope === 'page'
        ? '确认移除当前页对该资源的关联吗？'
        : (scope === 'global' ? '确认从全局资源中移除此文件吗？' : '确认删除此资源及其文件吗？');
      if(!confirm(confirmText)) return;
      try{
        const payload = {name: f.name};
        if(scope === 'page' && pageIndex !== null){
          payload.scope = 'page';
          payload.page = pageIndex;
        } else if(scope === 'global'){
          payload.scope = 'global';
        }
        const res = await fetch('/resources/delete', {method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)});
        const parsed = await parseJsonSafe(res);
        if(res.ok){
          if(parsed.json && parsed.json.success === false){
            alert('删除失败：' + (parsed.json.error || (parsed.text ? parsed.text : '未知错误')));
          } else {
            const body = parsed.json || {};
            if(body.globalRemoved){
              globalResources = globalResources.filter(name => name !== f.name);
            }
            if(Array.isArray(body.pagesRemoved)){
              body.pagesRemoved.forEach(num => {
                const idx = Number(num) - 1;
                if(idx >= 0 && pagesData[idx] && Array.isArray(pagesData[idx].resources)){
                  pagesData[idx].resources = pagesData[idx].resources.filter(name => name !== f.name);
                }
              });
            }
            if(body.fileRemoved){
              globalResources = globalResources.filter(name => name !== f.name);
              pagesData.forEach(p => {
                if(Array.isArray(p.resources)){
                  p.resources = p.resources.filter(name => name !== f.name);
                }
              });
            }
            if(body.stillReferenced && body.stillReferenced.refCount){
              const refs = [];
              if(Array.isArray(body.stillReferenced.pages) && body.stillReferenced.pages.length){
                refs.push(`页面：${body.stillReferenced.pages.join('、')}`);
              }
              if(body.stillReferenced.global){
                refs.push('全局资源列表');
              }
              if(refs.length){
                alert(`资源仍被引用（${refs.join('，')}），文件未删除。`);
              }
            }
            await loadResourcesModal();
            await refreshResourceLists();
            queueCompile();
          }
        } else {
          const message = parsed.json && parsed.json.error ? parsed.json.error : (parsed.text || ('HTTP ' + res.status));
          alert('删除失败：' + message);
        }
      }catch(e){ console.error(e); alert('删除失败：' + e.message); }
    };

    actions.appendChild(previewBtn);
    actions.appendChild(openBtn);
    actions.appendChild(copyBtn);
    actions.appendChild(copyOssBtn);
    actions.appendChild(renameBtn);
    actions.appendChild(deleteBtn);

    wrapper.appendChild(left);
    wrapper.appendChild(actions);
    item.appendChild(wrapper);
    return item;
  }

  function renderResourceList(container, files, options){
    if(!container) return;
    container.innerHTML = '';
    const list = Array.isArray(files) ? files : [];
    if(list.length === 0){
      container.innerHTML = '<div class="text-muted p-2">没有资源</div>';
      return;
    }
    list.forEach(f => {
      container.appendChild(createResourceListItem(f, options));
    });
  }

  async function loadResourcesModal(){
    const pageListEl = document.getElementById('resources-page-list');
    const globalListEl = document.getElementById('resources-global-list');
    const pageCountEl = document.getElementById('resources-page-count');
    const globalCountEl = document.getElementById('resources-global-count');
    if(pageListEl) pageListEl.innerHTML = '<div class="text-muted p-2">加载中...</div>';
    if(globalListEl) globalListEl.innerHTML = '<div class="text-muted p-2">加载中...</div>';
    const pageIdx = getCurrentPageIndex();
    const cpEl = document.getElementById('resources-current-page');
    if(cpEl) cpEl.textContent = pageIdx + 1;
    try{
      const [pageRes, globalRes] = await Promise.all([
        fetch(`/resources/list?page=${pageIdx}`),
        fetch('/resources/list')
      ]);
      const pageData = pageRes.ok ? await pageRes.json() : {files: []};
      const globalData = globalRes.ok ? await globalRes.json() : {files: []};
      if(pageData.ossError || globalData.ossError){
        console.warn('资源 OSS 状态:', pageData.ossError || globalData.ossError);
      }
      const pageFiles = Array.isArray(pageData.files) ? pageData.files : [];
      const globalFiles = Array.isArray(globalData.files) ? globalData.files : [];
      const pageNames = pageFiles.map(f => f && f.name).filter(Boolean);
      const globalNames = globalFiles.map(f => f && f.name).filter(Boolean);
      const serverPageId = pageData && typeof pageData.pageId === 'string' ? pageData.pageId : null;
      const currentPage = pagesData[pageIdx];
      if(currentPage && typeof currentPage === 'object' && typeof currentPage.pageId === 'string' && serverPageId && currentPage.pageId === serverPageId) {
        currentPage.resources = pageNames.slice();
      }
      globalResources = globalNames.slice();
      renderResourceList(pageListEl, pageFiles, {scope: 'page', pageIndex: pageIdx});
      renderResourceList(globalListEl, globalFiles, {scope: 'global'});
      if(pageCountEl) pageCountEl.textContent = pageFiles.length ? `${pageFiles.length} 个` : '暂无';
      if(globalCountEl) globalCountEl.textContent = globalFiles.length ? `${globalFiles.length} 个` : '暂无';
    } catch (e){
      console.error(e);
      if(pageListEl) pageListEl.innerHTML = '<div class="text-danger p-2">加载失败</div>';
      if(globalListEl) globalListEl.innerHTML = '<div class="text-danger p-2">加载失败</div>';
      if(pageCountEl) pageCountEl.textContent = '--';
      if(globalCountEl) globalCountEl.textContent = '--';
    }
  }

  // modal upload handlers
  const modalUploadBtn = document.getElementById('modal-resource-upload-btn');
  if(modalUploadBtn) modalUploadBtn.addEventListener('click', async function(){
    const input = document.getElementById('modal-resource-upload-input');
    if(!input.files || input.files.length === 0) return alert('请选择文件');
    const file = input.files[0];
    const fd = new FormData();
    fd.append('file', file);
    fd.append('page', getCurrentPageIndex());
    this.disabled = true;
    this.textContent = '上传中...';
    try{
      const res = await fetch('/upload_resource', {method: 'POST', body: fd});
      const parsed = await parseJsonSafe(res);
      if(res.ok){
        if(parsed.json && parsed.json.success === false){
          alert('上传失败：' + (parsed.json.error || parsed.text || '未知错误'));
        } else {
          input.value = '';
          const payload = parsed.json || {};
          if(payload.scope === 'page' && typeof payload.page === 'number' && payload.name){
            const idx = payload.page;
            if(pagesData[idx]){
              const list = Array.isArray(pagesData[idx].resources) ? pagesData[idx].resources : (pagesData[idx].resources = []);
              if(!list.includes(payload.name)) list.push(payload.name);
            }
          }
          await loadResourcesModal();
          await refreshResourceLists();
          queueCompile();
        }
      } else {
        alert('上传失败：' + (parsed.json && parsed.json.error ? parsed.json.error : parsed.text || ('HTTP ' + res.status)));
      }
    }catch(e){ console.error(e); alert('上传失败：' + e.message); }
    this.disabled = false;
    this.textContent = '上传到本页';
  });

  const modalUploadGlobalBtn = document.getElementById('modal-resource-upload-global-btn');
  if(modalUploadGlobalBtn) modalUploadGlobalBtn.addEventListener('click', async function(){
    const input = document.getElementById('modal-resource-upload-input');
    if(!input.files || input.files.length === 0) return alert('请选择文件');
    const file = input.files[0];
    const fd = new FormData();
    fd.append('file', file);
    this.disabled = true;
    this.textContent = '上传中...';
    try{
      const res = await fetch('/upload_resource', {method: 'POST', body: fd});
      const parsed = await parseJsonSafe(res);
      if(res.ok){
        if(parsed.json && parsed.json.success === false){
          alert('上传失败：' + (parsed.json.error || parsed.text || '未知错误'));
        } else {
          input.value = '';
          const payload = parsed.json || {};
          if(payload.scope === 'global' && payload.name){
            if(!globalResources.includes(payload.name)) globalResources.push(payload.name);
          } else if(payload.scope === 'page' && typeof payload.page === 'number' && payload.name){
            const idx = payload.page;
            if(pagesData[idx]){
              const list = Array.isArray(pagesData[idx].resources) ? pagesData[idx].resources : (pagesData[idx].resources = []);
              if(!list.includes(payload.name)) list.push(payload.name);
            }
          }
          await loadResourcesModal();
          await refreshResourceLists();
          queueCompile();
        }
      } else {
        const message = parsed.json && parsed.json.error ? parsed.json.error : (parsed.text || ('HTTP ' + res.status));
        alert('上传失败：' + message);
      }
    }catch(e){ console.error(e); alert('上传失败：' + e.message); }
    this.disabled = false;
    this.textContent = '上传为全局';
  });

  let attachmentsCache = [];
  let attachmentsFilterTerm = '';
  let unusedAttachmentsCache = [];
  let clearingUnusedAttachments = false;

  function updateAttachmentsUsageHint(data) {
    const hintEl = document.getElementById('attachments-usage-hint');
    if(!hintEl) return;
    const unused = data && Array.isArray(data.unused) ? data.unused : [];
    unusedAttachmentsCache = unused.slice();
    if(unusedAttachmentsCache.length){
      hintEl.classList.remove('d-none');
      hintEl.innerHTML = '';
      const preview = unusedAttachmentsCache.slice(0, 5).join('、');
      const message = unusedAttachmentsCache.length > 5 ? `有 ${unusedAttachmentsCache.length} 个附件未被引用，例如：${preview}` : `有 ${unusedAttachmentsCache.length} 个附件未被引用：${preview}`;
      const textSpan = document.createElement('span');
      textSpan.textContent = message;
      hintEl.appendChild(textSpan);
      const clearBtn = document.createElement('button');
      clearBtn.type = 'button';
      clearBtn.id = 'clear-unused-attachments-button';
      clearBtn.className = 'btn btn-sm btn-outline-danger ms-3';
      clearBtn.textContent = clearingUnusedAttachments ? '清除中...' : '一键清除';
      clearBtn.disabled = clearingUnusedAttachments;
      clearBtn.addEventListener('click', clearUnusedAttachments);
      hintEl.appendChild(clearBtn);
    } else {
      hintEl.classList.add('d-none');
      hintEl.innerHTML = '';
      hintEl.textContent = '';
    }
  }

  async function clearUnusedAttachments(){
    if(clearingUnusedAttachments || !unusedAttachmentsCache.length) return;
    const pendingNames = unusedAttachmentsCache.slice();
    const hintEl = document.getElementById('attachments-usage-hint');
    const clearBtn = hintEl ? hintEl.querySelector('#clear-unused-attachments-button') : null;
    clearingUnusedAttachments = true;
    if(clearBtn){
      clearBtn.disabled = true;
      clearBtn.textContent = '清除中...';
    }
    const failures = [];
    for(const name of pendingNames){
      const attachment = Array.isArray(attachmentsCache) ? attachmentsCache.find(item => item && item.name === name) : null;
      const path = attachment && attachment.path ? attachment.path : name;
      try{
        const res = await fetch('/attachments/delete', {method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({path})});
        const parsed = await parseJsonSafe(res);
        if(!(res.ok && (!parsed.json || parsed.json.success !== false))){
          const message = (parsed.json && parsed.json.error) ? parsed.json.error : (parsed.text || ('HTTP ' + res.status));
          failures.push({name, message});
        }
      }catch(err){
        failures.push({name, message: err && err.message ? err.message : String(err)});
      }
    }
    if(failures.length){
      const lines = failures.map(item => `${item.name}：${item.message}`);
      alert(`以下附件删除失败：\n${lines.join('\n')}`);
    }
    clearingUnusedAttachments = false;
    unusedAttachmentsCache = failures.map(item => item.name);
    if(clearBtn){
      clearBtn.disabled = false;
      clearBtn.textContent = '一键清除';
    }
    await loadAttachmentsModal();
  }

  function setAttachmentsFilter(term) {
    attachmentsFilterTerm = (term || '').trim().toLowerCase();
    renderAttachmentsList();
  }

  function getFilteredAttachments() {
    if (!Array.isArray(attachmentsCache)) return [];
    const tokens = attachmentsFilterTerm.split(/\s+/).filter(Boolean);
    if (!tokens.length) return attachmentsCache.slice();
    return attachmentsCache.filter(f => {
      if (!f) return false;
      const preferredUrl = (f.preferredUrl || f.localUrl || f.ossUrl || '').toString();
      const haystack = [
        f.name || '',
        f.location || '',
        preferredUrl,
        f.localUrl || '',
        f.ossUrl || '',
        f.path || '',
      ]
        .join(' ')
        .toLowerCase();
      return tokens.every(token => haystack.includes(token));
    });
  }

  function renderAttachmentsList(){
    const listEl = document.getElementById('attachments-list-modal');
    if(!listEl) return;
    listEl.innerHTML = '';
    const files = getFilteredAttachments();

    if((attachmentsCache || []).length === 0){
      listEl.innerHTML = '<div class="text-muted p-2">没有附件</div>';
      return;
    }

    if(files.length === 0){
      listEl.innerHTML = '<div class="text-muted p-2">未找到匹配的附件</div>';
      return;
    }

    files.forEach(f => {
        const preferredUrl = f.preferredUrl || f.localUrl || f.ossUrl || '';
        const item = document.createElement('div');
        item.className = 'list-group-item';
        const wrapper = document.createElement('div');
        wrapper.className = 'd-flex flex-column flex-md-row justify-content-between align-items-start gap-2';
        const left = document.createElement('div');
        left.className = 'me-md-3 flex-grow-1';
        const name = document.createElement('a');
        name.textContent = f.name;
        if(preferredUrl){
          name.href = preferredUrl;
          name.target = '_blank';
        } else {
          name.href = '#';
          name.classList.add('disabled');
        }
        left.appendChild(name);

        if(f.location){
          const badge = document.createElement('span');
          badge.className = 'badge rounded-pill ms-2';
          if(f.location === 'synced'){
            badge.classList.add('bg-success');
            badge.textContent = '已同步';
          } else if(f.location === 'local'){
            badge.classList.add('bg-secondary');
            badge.textContent = '仅本地';
          } else if(f.location === 'oss'){
            badge.classList.add('bg-info');
            badge.textContent = '仅 OSS';
          } else {
            badge.classList.add('bg-warning');
            badge.textContent = '未知';
        }
        left.appendChild(badge);
      }

      if(typeof f.refCount === 'number'){
        const usageBadge = document.createElement('span');
        usageBadge.className = 'badge rounded-pill ms-2 ' + (f.refCount > 0 ? 'bg-primary' : 'bg-secondary');
        usageBadge.textContent = f.refCount > 0 ? `引用 ${f.refCount}` : '未引用';
        if(Array.isArray(f.references) && f.references.length){
          usageBadge.title = f.references.join('；');
        }
        left.appendChild(usageBadge);
        if(Array.isArray(f.references) && f.references.length){
          const info = document.createElement('div');
          info.className = 'small text-muted';
          const preview = f.references.slice(0, 3).join('、');
          info.textContent = f.references.length > 3 ? `引用位置：${preview} 等` : `引用位置：${preview}`;
          left.appendChild(info);
        }
      }

      if(f.ossUrl && f.localUrl && f.ossUrl !== f.localUrl){
        const remoteLink = document.createElement('div');
        remoteLink.className = 'small text-muted';
        remoteLink.innerHTML = `远程：<a href="${f.ossUrl}" target="_blank">${f.ossUrl}</a>`;
        left.appendChild(remoteLink);
        }

        const actions = document.createElement('div');
        actions.className = 'd-flex flex-wrap gap-1';

        const insertBtn = document.createElement('button');
        insertBtn.type = 'button';
        insertBtn.className = 'btn btn-sm btn-primary';
        insertBtn.textContent = '插入';
        insertBtn.onclick = function(){
          if(!singleEditor) return;
          let mode = typeof currentEditMode === 'string' && currentEditMode === 'markdown' ? 'markdown' : 'latex';
          const isImage = /\.(png|jpe?g|gif|svg|webp|bmp|heic|heif)$/i.test(f.name || '');
          const doc = singleEditor.getDoc();
          const cursor = doc.getCursor();
          let snippet = '';
          if(mode === 'latex'){
            if(isImage){
              if(!f.localUrl){
                alert('该图片仅存在于 OSS，请先同步到本地再在 LaTeX 中引用。');
                return;
              }
              const path = urlToLatexPath(f.localUrl);
              snippet = `\\begin{center}\n  \\includegraphics[width=0.7\\textwidth]{${path}}\n\\end{center}\n`;
            } else {
              if(!preferredUrl){
                alert('当前附件没有可用的访问链接');
                return;
              }
              snippet = `\\textbf{附件:} \\href{${preferredUrl}}{${f.name}}\n`;
            }
          } else {
            if(!preferredUrl){
              alert('当前附件没有可用的访问链接');
              return;
            }
            snippet = isImage ? `![${f.name}](${preferredUrl})\n` : `[${f.name}](${preferredUrl})\n`;
          }
          doc.replaceRange(snippet, cursor);
        };

        const insertOssBtn = document.createElement('button');
        insertOssBtn.type = 'button';
        insertOssBtn.className = 'btn btn-sm btn-outline-primary';
        insertOssBtn.textContent = '插入为 OSS 链接';
        if(!f.ossUrl){
          insertOssBtn.disabled = true;
        }
        insertOssBtn.onclick = function(){
          if(!singleEditor) return;
          if(!f.ossUrl){
            alert('当前附件没有 OSS 链接');
            return;
          }
          const doc = singleEditor.getDoc();
          const cursor = doc.getCursor();
          const mode = typeof currentEditMode === 'string' && currentEditMode === 'markdown' ? 'markdown' : 'latex';
          const isImage = /\.(png|jpe?g|gif|svg|webp|bmp|heic|heif)$/i.test(f.name || '');
          const ossUrl = f.ossUrl;
          let snippet = '';
          if(mode === 'latex'){
            if(isImage){
              snippet = `\\href{${ossUrl}}{${f.name}}\n`;
            } else {
              snippet = `\\textbf{附件:} \\href{${ossUrl}}{${f.name}}\n`;
            }
          } else {
            snippet = isImage ? `![${f.name}](${ossUrl})\n` : `[${f.name}](${ossUrl})\n`;
          }
          doc.replaceRange(snippet, cursor);
        };

        const previewBtn = document.createElement('button');
        previewBtn.type = 'button';
        previewBtn.className = 'btn btn-sm btn-outline-secondary';
        previewBtn.textContent = '预览';
        previewBtn.onclick = function(){
          const isImage = /\.(png|jpe?g|gif|svg|webp|bmp|heic|heif)$/i.test(f.name || '');
          const targetUrl = f.localUrl || f.ossUrl || preferredUrl;
          if(isImage && attachmentPreviewModalEl && attachmentPreviewImage){
            if(!targetUrl){
              alert('当前附件没有可用的访问链接');
              return;
            }
            attachmentPreviewImage.src = targetUrl;
            if(attachmentPreviewMeta){
              const parts = [];
              parts.push(f.location === 'oss' ? '来源：OSS' : '来源：本地');
              if(f.ossUrl && f.localUrl && f.ossUrl !== f.localUrl){
                parts.push('已同步');
              }
              attachmentPreviewMeta.textContent = `${f.name}${parts.length ? '（' + parts.join('，') + '）' : ''}`;
            }
            if(attachmentPreviewOpen){
              attachmentPreviewOpen.href = targetUrl || '#';
              attachmentPreviewOpen.classList.toggle('disabled', !targetUrl);
            }
            const modal = bootstrap.Modal.getOrCreateInstance(attachmentPreviewModalEl);
            modal.show();
          } else {
            if(targetUrl){
              window.open(targetUrl, '_blank');
            } else {
              alert('当前附件没有可用的访问链接');
            }
          }
        };

        const openBtn = document.createElement('button');
        openBtn.type = 'button';
        openBtn.className = 'btn btn-sm btn-outline-secondary';
        openBtn.textContent = '打开';
        openBtn.onclick = function(){
          if(preferredUrl){
            window.open(preferredUrl, '_blank');
          } else {
            alert('当前附件没有可用的访问链接');
          }
        };

        const copyNameBtn = document.createElement('button');
        copyNameBtn.type = 'button';
        copyNameBtn.className = 'btn btn-sm btn-outline-primary';
        copyNameBtn.textContent = '复制名称';
        copyNameBtn.onclick = function(){
          navigator.clipboard.writeText(f.name || '').then(()=>{
            copyNameBtn.textContent = '已复制';
            setTimeout(()=>{ copyNameBtn.textContent = '复制名称'; }, 2000);
          }).catch(()=>alert('复制失败，请手动复制'));
        };

        const copyLinkBtn = document.createElement('button');
        copyLinkBtn.type = 'button';
        copyLinkBtn.className = 'btn btn-sm btn-outline-primary';
        copyLinkBtn.textContent = '复制链接';
        copyLinkBtn.onclick = function(){
          if(!preferredUrl){
            alert('当前附件没有可用的链接');
            return;
          }
          navigator.clipboard.writeText(preferredUrl).then(()=>{
            copyLinkBtn.textContent = '已复制';
            setTimeout(()=>{ copyLinkBtn.textContent = '复制链接'; }, 2000);
          }).catch(()=>alert('复制失败，请手动复制链接'));
        };

        const renameBtn = document.createElement('button');
        renameBtn.type = 'button';
        renameBtn.className = 'btn btn-sm btn-outline-secondary';
        renameBtn.textContent = '重命名';
        renameBtn.onclick = function(){
          if(!attachmentRenameModalEl || !attachmentRenameInput){
            alert('当前界面不支持重命名');
            return;
          }
          attachmentRenameTarget = f.name;
          attachmentRenameInput.value = f.name;
          const modal = bootstrap.Modal.getOrCreateInstance(attachmentRenameModalEl);
          modal.show();
        };

        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.className = 'btn btn-sm btn-outline-danger';
        deleteBtn.textContent = '删除';
        deleteBtn.onclick = async function(){
          if(typeof f.refCount === 'number' && f.refCount > 0){
            const refs = Array.isArray(f.references) && f.references.length ? f.references.join('、') : '';
            alert(refs ? `该附件仍被引用：${refs}` : '该附件仍被引用，无法删除。');
            return;
          }
          if(!confirm('确认删除此附件吗？')) return;
          try{
            const res = await fetch('/attachments/delete', {method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({path: f.path})});
            const parsed = await parseJsonSafe(res);
            if(res.ok && (!parsed.json || parsed.json.success !== false)){
              await loadAttachmentsModal();
            } else {
              const message = (parsed.json && parsed.json.error) ? parsed.json.error : (parsed.text || ('HTTP ' + res.status));
              alert('删除失败：' + message);
            }
          }catch(e){ console.error(e); alert('删除失败：' + e.message); }
        };

        actions.appendChild(insertBtn);
        actions.appendChild(insertOssBtn);
        actions.appendChild(previewBtn);
        actions.appendChild(openBtn);
        actions.appendChild(copyNameBtn);
        actions.appendChild(copyLinkBtn);
        actions.appendChild(renameBtn);
        actions.appendChild(deleteBtn);

        wrapper.appendChild(left);
        wrapper.appendChild(actions);
        item.appendChild(wrapper);
        listEl.appendChild(item);
      });
  }

  const attachmentFilterInput = document.getElementById('attachment-filter-input');
  const attachmentFilterClear = document.getElementById('attachment-filter-clear');

  if(attachmentFilterInput && !attachmentFilterInput.dataset.bound){
    attachmentFilterInput.dataset.bound = 'true';
    attachmentFilterInput.addEventListener('input', () => {
      setAttachmentsFilter(attachmentFilterInput.value);
    });
    attachmentFilterInput.addEventListener('keydown', (event) => {
      if(event.key === 'Escape'){
        attachmentFilterInput.value = '';
        setAttachmentsFilter('');
        event.preventDefault();
      }
    });
  }

  if(attachmentFilterClear && !attachmentFilterClear.dataset.bound){
    attachmentFilterClear.dataset.bound = 'true';
    attachmentFilterClear.addEventListener('click', () => {
      if(attachmentFilterInput){
        attachmentFilterInput.value = '';
        attachmentFilterInput.focus();
      }
      setAttachmentsFilter('');
    });
  }

  async function loadAttachmentsModal(){
    const listEl = document.getElementById('attachments-list-modal');
    if(!listEl) return;
    listEl.innerHTML = '<div class="text-muted p-2">加载中...</div>';
    try{
      const res = await fetch('/attachments/list');
      const data = res.ok ? await res.json() : {files: []};
      attachmentsCache = Array.isArray(data.files) ? data.files : [];
      updateAttachmentsUsageHint(data);
      if(attachmentFilterInput && typeof attachmentFilterInput.value === 'string'){
        setAttachmentsFilter(attachmentFilterInput.value);
      } else {
        renderAttachmentsList();
      }
    }catch(e){
      console.warn('加载附件失败', e);
      listEl.innerHTML = '<div class="text-danger p-2">加载失败</div>';
      updateAttachmentsUsageHint({unused: []});
    }
  }

  const manageAttachmentsBtn = document.getElementById('manage-attachments');
  if(manageAttachmentsBtn) manageAttachmentsBtn.addEventListener('click', async function(){
    await loadAttachmentsModal();
    var modal = new bootstrap.Modal(document.getElementById('attachmentsModal'));
    modal.show();
  });

  const manageSyncBtn = document.getElementById('manage-sync');
  if(manageSyncBtn && ossSyncModalEl){
    manageSyncBtn.addEventListener('click', async function(){
      await refreshOssSyncModal();
      const modal = bootstrap.Modal.getOrCreateInstance(ossSyncModalEl);
      modal.show();
    });
  }

  if(ossSyncToggleMain && !ossSyncToggleMain.dataset.bound){
    ossSyncToggleMain.dataset.bound = 'true';
    ossSyncToggleMain.addEventListener('change', async function(){
      if(this.dataset.configured !== 'true'){
        this.checked = false;
        alert('当前未配置 OSS，同步不可用');
        return;
      }
      const desired = this.checked;
      this.disabled = true;
      const prevLabel = this.nextElementSibling ? this.nextElementSibling.textContent : '';
      if(this.nextElementSibling) this.nextElementSibling.textContent = desired ? '开启中...' : '关闭中...';
      try{
        const res = await fetch('/attachments/sync', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({enabled: desired})
        });
        const parsed = await parseJsonSafe(res);
        if(!(res.ok && (!parsed.json || parsed.json.success !== false))){
          const message = (parsed.json && parsed.json.error) ? parsed.json.error : (parsed.text || (`HTTP ${res.status}`));
          alert('同步开关更新失败：' + message);
          this.checked = !desired;
        } else {
          await refreshOssSyncModal();
          await loadAttachmentsModal();
          await loadResourcesModal();
        }
      }catch(e){
        alert('同步开关更新失败：' + e.message);
        this.checked = !desired;
      }
      if(this.nextElementSibling) this.nextElementSibling.textContent = prevLabel || '启用 OSS 同步';
      this.disabled = false;
    });
  }

  if(ossSyncRunBtn && !ossSyncRunBtn.dataset.bound){
    ossSyncRunBtn.dataset.bound = 'true';
    ossSyncRunBtn.addEventListener('click', async function(){
      this.disabled = true;
      const original = this.textContent;
      this.textContent = '同步中...';
      if(ossSyncStatusBox) ossSyncStatusBox.textContent = '正在与 OSS 同步...';
      try{
        const res = await fetch('/oss/sync_now', {method: 'POST'});
        const parsed = await parseJsonSafe(res);
        if(res.ok && (!parsed.json || parsed.json.success !== false)){
          const payload = parsed.json || {};
          const summary = payload.synced || {};
          const messageLines = [];
          messageLines.push(`附件：${renderSyncEntry(summary.attachments)}`);
          messageLines.push(`资源：${renderSyncEntry(summary.resources)}`);
          messageLines.push(`项目 YAML：${renderSyncEntry(summary.yaml)}`);
          await loadAttachmentsModal();
          await loadResourcesModal();
          await refreshOssSyncModal();
          if(ossSyncStatusBox) ossSyncStatusBox.innerHTML = messageLines.join('<br>');
        } else {
          const message = (parsed.json && parsed.json.error) ? parsed.json.error : (parsed.text || (`HTTP ${res.status}`));
          if(ossSyncStatusBox) ossSyncStatusBox.textContent = '同步失败：' + message;
          alert('同步失败：' + message);
        }
      }catch(e){
        if(ossSyncStatusBox) ossSyncStatusBox.textContent = '同步失败：' + e.message;
        alert('同步失败：' + e.message);
      }
      this.textContent = original || '立即同步';
      this.disabled = false;
    });
  }

  const attachmentUploadBtn = document.getElementById('modal-attachment-upload-btn');
  if(attachmentUploadBtn) attachmentUploadBtn.addEventListener('click', async function(){
    const input = document.getElementById('modal-attachment-upload-input');
    if(!input.files || input.files.length === 0) return alert('请选择文件');
    const file = input.files[0];
    const fd = new FormData();
    fd.append('file', file);
    this.disabled = true;
    this.textContent = '上传中...';
    try{
      const res = await fetch('/attachments/upload', {method: 'POST', body: fd});
      const text = await res.text();
      const parsed = await parseJsonSafe(text);
      if(res.ok){
        const payload = parsed.json || {};
        if(payload.success === false){
          alert('上传失败：' + (payload.error || parsed.text || '未知错误'));
        } else {
          input.value = '';
          await loadAttachmentsModal();
        }
      } else {
        const message = (parsed.json && parsed.json.error) ? parsed.json.error : (parsed.text || ('HTTP ' + res.status));
        alert('上传失败：' + message);
      }
    }catch(e){ console.error(e); alert('上传失败：' + e.message); }
    this.disabled = false;
    this.textContent = '上传附件';
  });

  if(resourceRenameConfirm && !resourceRenameConfirm.dataset.bound){
    resourceRenameConfirm.dataset.bound = 'true';
    resourceRenameConfirm.addEventListener('click', async function(){
      if(!resourceRenameTarget){
        alert('请先选择要重命名的资源');
        return;
      }
      if(!resourceRenameInput){
        alert('无法读取新文件名');
        return;
      }
      const newName = resourceRenameInput.value.trim();
      if(!newName){
        alert('文件名不能为空');
        return;
      }
      const originalText = this.textContent;
      this.disabled = true;
      this.textContent = '保存中...';
      try{
        const res = await fetch('/resources/rename', {method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({oldName: resourceRenameTarget, newName})});
        const parsed = await parseJsonSafe(res);
        if(res.ok && (!parsed.json || parsed.json.success !== false)){
          if(parsed.json && parsed.json.name && parsed.json.name !== newName){
            alert(`文件名已更新为：${parsed.json.name}`);
          }
          const modal = resourceRenameModalEl ? bootstrap.Modal.getInstance(resourceRenameModalEl) : null;
          if(modal) modal.hide();
          resourceRenameTarget = null;
          await loadResourcesModal();
          await refreshResourceLists();
          queueCompile();
        } else {
          const message = (parsed.json && parsed.json.error) ? parsed.json.error : (parsed.text || ('HTTP ' + res.status));
          alert('重命名失败：' + message);
        }
      }catch(e){
        alert('重命名失败：' + e.message);
      }
      this.disabled = false;
      this.textContent = originalText || '保存';
    });
  }

  if(attachmentRenameConfirm && !attachmentRenameConfirm.dataset.bound){
    attachmentRenameConfirm.dataset.bound = 'true';
    attachmentRenameConfirm.addEventListener('click', async function(){
      if(!attachmentRenameTarget){
        alert('请先选择要重命名的附件');
        return;
      }
      if(!attachmentRenameInput){
        alert('无法读取新文件名');
        return;
      }
      const newName = attachmentRenameInput.value.trim();
      if(!newName){
        alert('文件名不能为空');
        return;
      }
      const originalText = this.textContent;
      this.disabled = true;
      this.textContent = '保存中...';
      try{
        const res = await fetch('/attachments/rename', {method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({oldName: attachmentRenameTarget, newName})});
        const parsed = await parseJsonSafe(res);
        if(res.ok && (!parsed.json || parsed.json.success !== false)){
          if(parsed.json){
            const payload = parsed.json;
            if(payload.name && payload.name !== newName){
              alert(`文件名已更新为：${payload.name}`);
            }
            const status = payload.ossStatus;
            if(status && (status.error || status.delete_error)){
              const msg = status.error || status.delete_error;
              alert('OSS 同步出现问题：' + msg);
            }
          }
          const modal = attachmentRenameModalEl ? bootstrap.Modal.getInstance(attachmentRenameModalEl) : null;
          if(modal) modal.hide();
          attachmentRenameTarget = null;
          await loadAttachmentsModal();
        } else {
          const message = (parsed.json && parsed.json.error) ? parsed.json.error : (parsed.text || ('HTTP ' + res.status));
          alert('重命名失败：' + message);
        }
      }catch(e){
        alert('重命名失败：' + e.message);
      }
      this.disabled = false;
      this.textContent = originalText || '保存';
    });
  }

  const mobileMediaQuery = window.matchMedia('(max-width: 768px)');
  const handleMobileMediaQuery = e => setMobileCompact(e.matches);
  if(typeof mobileMediaQuery.addEventListener === 'function'){
    mobileMediaQuery.addEventListener('change', handleMobileMediaQuery);
  } else if (typeof mobileMediaQuery.addListener === 'function'){
    mobileMediaQuery.addListener(handleMobileMediaQuery);
  }
  applyMobileRestrictions();

  // Side-panel upload handlers removed — resource management is modal-only

  // ensure modal content refreshes when page changes
  const origRenderSingleEditor = renderSingleEditor;
  renderSingleEditor = function(){ origRenderSingleEditor(); if(document.getElementById('resourcesModal') && bootstrap.Modal.getInstance(document.getElementById('resourcesModal'))) loadResourcesModal(); };

</script>
</body>
</html>
